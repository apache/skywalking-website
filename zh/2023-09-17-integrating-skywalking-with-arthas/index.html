<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="twitter:site" content="skywalking.apache.org">
<meta name="twitter:image:src" content="https://skywalking.apache.org/images/skywalking_400x400.png">
<meta property="og:image" content="https://skywalking.apache.org/images/skywalking_400x400.png">

<meta http-equiv="Content-Security-Policy" content="frame-src 'self' https://www.google.com https://app.netlify.com;">

<meta name="generator" content="Hugo 0.80.0" />


<script async src="https://www.googletagmanager.com/gtag/js?id=G-GR8N6PGRJ3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);};
  gtag('js', new Date());gtag('config', 'G-GR8N6PGRJ3');
</script>
<META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
<link rel="stylesheet" href="//at.alicdn.com/t/c/font_3007530_pvozs1rz2wn.css">



<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
<link rel="manifest" href="/favicons/site.webmanifest">
<link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<title>将 Apache SkyWalking 与 Arthas 集成 | Apache SkyWalking</title><meta property="og:title" content="将 Apache SkyWalking 与 Arthas 集成" />
<meta property="og:description" content="本篇文章演示如何将 Arthas 集成到 SkyWalking 中，并借此场景讨论 SkyWalking 中的常见扩展点。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/zh/2023-09-17-integrating-skywalking-with-arthas/" />
<meta property="article:published_time" content="2023-09-17T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-02-19T22:02:37-05:00" />
<meta itemprop="name" content="将 Apache SkyWalking 与 Arthas 集成">
<meta itemprop="description" content="本篇文章演示如何将 Arthas 集成到 SkyWalking 中，并借此场景讨论 SkyWalking 中的常见扩展点。">
<meta itemprop="datePublished" content="2023-09-17T00:00:00+00:00" />
<meta itemprop="dateModified" content="2024-02-19T22:02:37-05:00" />
<meta itemprop="wordCount" content="1177">



<meta itemprop="keywords" content="Agent,Arthas," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="将 Apache SkyWalking 与 Arthas 集成"/>
<meta name="twitter:description" content="本篇文章演示如何将 Arthas 集成到 SkyWalking 中，并借此场景讨论 SkyWalking 中的常见扩展点。"/>



<link rel="preload" href="/scss/main.min.592235942cb3c9f3dd697382a4e7a1fad8e1c182dad2841bdce6b43b4a346ae8.css" as="style">
<link href="/scss/main.min.592235942cb3c9f3dd697382a4e7a1fad8e1c182dad2841bdce6b43b4a346ae8.css" rel="stylesheet" integrity="">



<link rel="stylesheet" href="/css/docSearch.css" />


<script src="/js/jquery-3.6.0.min.js"></script>





    <title>将 Apache SkyWalking 与 Arthas 集成 | Apache SkyWalking</title>
  </head>
  <body class="td-page td-blog">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand  flex-column flex-md-row td-navbar">
    <div class="sidebar-button">
      <i class="iconfont icon-menu"></i>
    </div>
    <a class="navbar-brand" href="/">
        <span class="navbar-logo"><img width="130" src="/images/logo.svg" alt="SkyWalking"></span> 
    </a>
    <div class="td-navbar-nav-scroll navbar-nav-wrapper" id="navigation">
        <ul class="navbar-nav mt-lg-0">
             
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/docs" ><span>Projects and Docs</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/events" ><span>Events</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/blog" ><span>Blogs</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/downloads" ><span>Downloads</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/team" ><span>Team</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/users" ><span>Users</span></a>
			</li>
            
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
                <span class="link dropdown blog">
                    <a class="link-name nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">中文资料</a>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="/zh/">博客</a>
                        <a class="dropdown-item" href="https://space.bilibili.com/390683219" target="_blank" rel="noopener noreferrer">
                            B站
                        </a>
                        <a class="dropdown-item" href="https://juejin.cn/user/13673577331607" target="_blank" rel="noopener noreferrer">
                            掘金
                        </a>
                    </div>
                </span>
            </li>

            
			
        </ul>
    </div>
    <div class="navbar-nav d-none d-lg-block search-input-box">
         
            
        
            
        
            
        
            
        
            
        
            
        
            
            <span class="link dropdown">
                <a class="link-name dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Links
                </a>
                <div class="dropdown-menu">
                    
                    <a class="dropdown-item" href="http://www.apache.org/">Apache Software Foundation</a> 
                    <a class="dropdown-item" href="https://github.com/apache/skywalking/issues">GitHub Issue Tracker</a> 
                    <a class="dropdown-item" href="https://github.com/apache/skywalking/discussions">Discussion</a> 
                    <a class="dropdown-item" href="https://lists.apache.org/list.html?dev@skywalking.apache.org">Dev Mailing List</a> 
                    <a class="dropdown-item" href="https://cwiki.apache.org/confluence/display/SKYWALKING/Home">WIKI</a> 
                    <a class="dropdown-item" href="http://www.apache.org/licenses/">License</a> 
                    <a class="dropdown-item" href="http://www.apache.org/events/current-event">Apache Events</a> 
                    <a class="dropdown-item" href="http://www.apache.org/security/">Security</a> 
                    <a class="dropdown-item" href="http://www.apache.org/foundation/sponsorship.html">Sponsor and Donate</a> 
                    <a class="dropdown-item" href="http://www.apache.org/foundation/thanks.html">Thanks</a> 
                    <a class="dropdown-item" href="https://apache.org/foundation/policies/privacy.html">Privacy</a> 
                </div>
            </span>
            
        
        
<div id="docsearch"></div>


    </div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row container container-center">
          <main class="col-12 col-md-12 col-xl-10 pl-md-4 pr-md-4" role="main">
            
<div class="td-content">
	<h1>将 Apache SkyWalking 与 Arthas 集成</h1>
	<div class="lead">本篇文章演示如何将 Arthas 集成到 SkyWalking 中，并借此场景讨论 SkyWalking 中的常见扩展点。</div>
	<div class="td-byline mb-4">
		By <b>魏翔</b> |
		<time datetime="2023-09-17" class="text-muted">Sunday, September 17, 2023</time>

	    

	</div>
	<h2 id="背景介绍">背景介绍</h2>
<p>Arthas 是一款常用的 Java 诊断工具，我们可以在 SkyWalking 监控到服务异常后，通过 Arthas 进一步分析和诊断以快速定位问题。</p>
<p>在 Arthas 实际使用中，通常由开发人员拷贝或者下载安装包到服务对应的VM或者容器中，attach 到对应的 Java 进程进行问题排查。这一过程不可避免的会造成服务器敏感运维信息的扩散，
而且在分秒必争的问题排查过程中，这些繁琐的操作无疑会浪费大量时间。</p>
<p>SkyWalking Java Agent 伴随 Java 服务一起启动，并定期上报服务、实例信息给OAP Server。我们可以借助 SkyWalking Java Agent 的插件化能力，开发一个 Arthas 控制插件，
由该插件管理 Arthas 运行生命周期，通过页面化的方式，完成Arthas的启动与停止。最终实现效果可以参考下图：</p>
<p><img src="skywalking-x-arthas-ui.png" alt="skywalking-x-arthas"></p>
<p>要完成上述功能，我们需要实现以下几个关键点：</p>
<ol>
<li>开发 agent arthas-control-plugin，执行 arthas 的启动与停止命令</li>
<li>开发 oap arthas-controller-module ，下发控制命令给 arthas agent plugin</li>
<li>定制 skywalking-ui, 连接 arthas-tunnel-server，发送 arthas 命令并获取执行结果</li>
</ol>
<p>以上各个模块之间的交互流程如下图所示：</p>
<h3 id="connect">connect</h3>
<p><img src="connect-sequence.png" alt="skywalking-x-arthas"></p>
<h3 id="disconnect">disconnect</h3>
<p><img src="disconnect-sequence.png" alt="skywalking-x-arthas"></p>
<p>本文涉及的所有代码均已发布在 github <a href="https://github.com/weixiang1862/skywalking-x-arthas">skywalking-x-arthas</a> 上，如有需要，大家可以自行下载代码测试。
文章后半部分将主要介绍代码逻辑及其中包含的SkyWalking扩展点。</p>
<h2 id="agent-arthas-control-plugin">agent arthas-control-plugin</h2>
<p>首先在 skywalking-java/apm-sniffer/apm-sdk-plugin 下创建一个 arthas-control-plugin，
该模块在打包后会成为 skywalking-agent/plugins 下的一个插件， 其目录结构如下：</p>
<pre><code>arthas-control-plugin/
├── pom.xml
└── src
    └── main
        ├── java
        │   └── org
        │       └── apache
        │           └── skywalking
        │               └── apm
        │                   └── plugin
        │                       └── arthas
        │                           ├── config
        │                           │   └── ArthasConfig.java    # 模块配置
        │                           ├── service
        │                           │   └── CommandListener.java # boot service，监听 oap command
        │                           └── util
        │                               ├── ArthasCtl.java       # 控制 arthas 的启动与停止
        │                               └── ProcessUtils.java
        ├── proto
        │   └── ArthasCommandService.proto                       # 与oap server通信的 grpc 协议定义
        └── resources
            └── META-INF
                └── services                                     # boot service spi service
                    └── org.apache.skywalking.apm.agent.core.boot.BootService

16 directories, 7 files
</code></pre><p>在 ArthasConfig.java 中，我们定义了以下配置，这些参数将在 arthas 启动时传递。</p>
<p>以下的配置可以通过 agent.config 文件、system prop、env variable指定。
关于 skywalking-agent 配置的初始化的具体流程，大家可以参考 <a href="https://github.com/apache/skywalking-java/blob/main/apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/conf/SnifferConfigInitializer.java">SnifferConfigInitializer</a> 。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ArthasConfig</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Plugin</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#3c5d5d;font-weight:bold">@PluginConfig</span><span style="color:#000;font-weight:bold">(</span>root <span style="color:#000;font-weight:bold">=</span> ArthasConfig<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Arthas</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#998;font-style:italic">// arthas 目录
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> String ARTHAS_HOME<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#998;font-style:italic">// arthas 启动时连接的tunnel server
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> String TUNNEL_SERVER<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#998;font-style:italic">// arthas 会话超时时间
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> Long SESSION_TIMEOUT<span style="color:#000;font-weight:bold">;</span>
            <span style="color:#998;font-style:italic">// 禁用的 arthas command
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> String DISABLED_COMMANDS<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>接着，我们看下 CommandListener.java 的实现，CommandListener 实现了 BootService 接口，
并通过 resources/META-INF/services 下的文件暴露给 ServiceLoader。</p>
<p>BootService 的定义如下，共有prepare()、boot()、onComplete()、shutdown()几个方法，这几个方法分别对应插件生命周期的不同阶段。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">BootService</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">prepare</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> Throwable<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">boot</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> Throwable<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">onComplete</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> Throwable<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">shutdown</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> Throwable<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#000;font-weight:bold">default</span> <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">priority</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> 0<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>在 <a href="https://github.com/apache/skywalking-java/blob/main/apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/boot/ServiceManager.java">ServiceManager</a> 类的 boot() 方法中，
定义了BootService 的 load 与启动流程，该方法 由SkyWalkingAgent 的 premain 调用，在主程序运行前完成初始化与启动：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">enum</span> ServiceManager <span style="color:#000;font-weight:bold">{</span>
    INSTANCE<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">...</span>
    <span style="color:#000;font-weight:bold">...</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">boot</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        bootedServices <span style="color:#000;font-weight:bold">=</span> loadAllServices<span style="color:#000;font-weight:bold">();</span>

        prepare<span style="color:#000;font-weight:bold">();</span>
        startup<span style="color:#000;font-weight:bold">();</span>
        onComplete<span style="color:#000;font-weight:bold">();</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">...</span>
    <span style="color:#000;font-weight:bold">...</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>回到我们 CommandListener 的 boot 方法，该方法在 agent 启动之初定义了一个定时任务，这个定时任务会轮询 oap ，查询是否需要启动或者停止arthas:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">CommandListener</span> <span style="color:#000;font-weight:bold">implements</span> BootService<span style="color:#000;font-weight:bold">,</span> GRPCChannelListener <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">...</span>
    <span style="color:#000;font-weight:bold">...</span>
    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">boot</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> Throwable <span style="color:#000;font-weight:bold">{</span>
        getCommandFuture <span style="color:#000;font-weight:bold">=</span> Executors<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newSingleThreadScheduledExecutor</span><span style="color:#000;font-weight:bold">(</span>
            <span style="color:#000;font-weight:bold">new</span> DefaultNamedThreadFactory<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;CommandListener&#34;</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#000;font-weight:bold">).</span><span style="color:#008080">scheduleWithFixedDelay</span><span style="color:#000;font-weight:bold">(</span>
            <span style="color:#000;font-weight:bold">new</span> RunnableWithExceptionProtection<span style="color:#000;font-weight:bold">(</span>
                <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">::</span>getCommand<span style="color:#000;font-weight:bold">,</span>
                t <span style="color:#000;font-weight:bold">-&gt;</span> LOGGER<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;get arthas command error.&#34;</span><span style="color:#000;font-weight:bold">,</span> t<span style="color:#000;font-weight:bold">)</span>
            <span style="color:#000;font-weight:bold">),</span> 0<span style="color:#000;font-weight:bold">,</span> 2<span style="color:#000;font-weight:bold">,</span> TimeUnit<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">SECONDS</span>
        <span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">...</span>
    <span style="color:#000;font-weight:bold">...</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>getCommand方法中定义了start、stop的处理逻辑，分别对应页面上的 connect 和 disconnect 操作。
这两个 command 有分别转给 ArthasCtl 的 startArthas 和 stopArthas 两个方法处理，用来控制 arthas 的启停。</p>
<p>在 startArthas 方法中，启动arthas-core.jar 并使用 skywalking-agent 的 serviceName 和 instanceName 注册连接至配置文件中指定的arthas-tunnel-server。</p>
<p>ArthasCtl 逻辑参考自 Arthas 的  <a href="https://github.com/alibaba/arthas/blob/master/boot/src/main/java/com/taobao/arthas/boot/Bootstrap.java">BootStrap.java</a> ，由于不是本篇文章的重点，这里不再赘述，感兴趣的小伙伴可以自行查看。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">(</span>commandResponse<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getCommand</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">case</span> START<span style="color:#000;font-weight:bold">:</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>alreadyAttached<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            LOGGER<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;arthas already attached, no need start again&#34;</span><span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
            arthasTelnetPort <span style="color:#000;font-weight:bold">=</span> SocketUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findAvailableTcpPort</span><span style="color:#000;font-weight:bold">();</span>
            ArthasCtl<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">startArthas</span><span style="color:#000;font-weight:bold">(</span>PidUtils<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">currentLongPid</span><span style="color:#000;font-weight:bold">(),</span> arthasTelnetPort<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            LOGGER<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;error when start arthas&#34;</span><span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">case</span> STOP<span style="color:#000;font-weight:bold">:</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(!</span>alreadyAttached<span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
            LOGGER<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">warn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;no arthas attached, no need to stop&#34;</span><span style="color:#000;font-weight:bold">);</span>
            <span style="color:#000;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">try</span> <span style="color:#000;font-weight:bold">{</span>
            ArthasCtl<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">stopArthas</span><span style="color:#000;font-weight:bold">(</span>arthasTelnetPort<span style="color:#000;font-weight:bold">);</span>
            arthasTelnetPort <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">catch</span> <span style="color:#000;font-weight:bold">(</span>Exception e<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
            LOGGER<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;error when stop arthas&#34;</span><span style="color:#000;font-weight:bold">,</span> e<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>看完 arthas 的启动与停止控制逻辑，我们回到 CommandListener 的 statusChanged 方法，
由于要和 oap 通信，这里我们按照惯例监听 grpc channel 的状态，只有状态正常时才会执行上面的getCommand轮询。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">CommandListener</span> <span style="color:#000;font-weight:bold">implements</span> BootService<span style="color:#000;font-weight:bold">,</span> GRPCChannelListener <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">...</span>
    <span style="color:#000;font-weight:bold">...</span>
    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">statusChanged</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">final</span> GRPCChannelStatus status<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>GRPCChannelStatus<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">CONNECTED</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">equals</span><span style="color:#000;font-weight:bold">(</span>status<span style="color:#000;font-weight:bold">))</span> <span style="color:#000;font-weight:bold">{</span>
            Object channel <span style="color:#000;font-weight:bold">=</span> ServiceManager<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">INSTANCE</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">findService</span><span style="color:#000;font-weight:bold">(</span>GRPCChannelManager<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">getChannel</span><span style="color:#000;font-weight:bold">();</span>
            <span style="color:#998;font-style:italic">// DO NOT REMOVE Channel CAST, or it will throw `incompatible types: org.apache.skywalking.apm.dependencies.io.grpc.Channel
</span><span style="color:#998;font-style:italic"></span>            <span style="color:#998;font-style:italic">// cannot be converted to io.grpc.Channel` exception when compile due to agent core&#39;s shade of grpc dependencies.
</span><span style="color:#998;font-style:italic"></span>            commandServiceBlockingStub <span style="color:#000;font-weight:bold">=</span> ArthasCommandServiceGrpc<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">newBlockingStub</span><span style="color:#000;font-weight:bold">((</span>Channel<span style="color:#000;font-weight:bold">)</span> channel<span style="color:#000;font-weight:bold">);</span>
        <span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
            commandServiceBlockingStub <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">this</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">status</span> <span style="color:#000;font-weight:bold">=</span> status<span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">...</span>
    <span style="color:#000;font-weight:bold">...</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>上面的代码，细心的小伙伴可能会发现，getChannel() 的返回值被向上转型成了 Object, 而在下面的 newBlockingStub 方法中，又强制转成了 Channel。</p>
<p>看似有点多此一举，其实不然，我们将这里的转型去掉,尝试编译就会收到下面的错误：</p>
<pre><code>[ERROR] Failed to execute goal org.apache.maven.plugins:maven-compiler-plugin:3.10.1:compile (default-compile) on project arthas-control-plugin: Compilation failure
[ERROR] .../CommandListener.java:[59,103] 不兼容的类型: org.apache.skywalking.apm.dependencies.io.grpc.Channel无法转换为io.grpc.Channel
</code></pre><p>上面的错误提示 ServiceManager.INSTANCE.findService(GRPCChannelManager.class).getChannel() 的返回值类型是 org.apache.skywalking.apm.dependencies.io.grpc.Channel，无法被赋值给 io.grpc.Channel 引用。</p>
<p>我们查看GRPCChannelManager的getChannel()方法代码会发现，方法定义的返回值明明是 io.grpc.Channel，为什么编译时会报上面的错误？</p>
<p>其实这是skywalking-agent的一个小魔法，由于 agent-core 最终会被打包进 skywalking-agent.jar，启动时由系统类装载器（或者其他父级类装载器）直接装载，
为了防止所依赖的类库和被监控服务的类发生版本冲突，agent 核心代码在打包时使用了maven-shade-plugin, 该插件会在 maven package 阶段改变 grpc 依赖的包名，
我们在源代码里看到的是 io.grpc.Channel，其实在真正运行时已经被改成了 org.apache.skywalking.apm.dependencies.io.grpc.Channel，这便可解释上面编译报错的原因。</p>
<p>除了grpc以外，其他一些 well-known 的 dependency 也会进行 shade 操作，详情大家可以参考 <a href="https://github.com/apache/skywalking-java/blob/main/apm-sniffer/apm-agent-core/pom.xml">apm-agent-core pom.xml</a> ：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-xml" data-lang="xml"><span style="color:#000080">&lt;plugin&gt;</span>
    <span style="color:#000080">&lt;artifactId&gt;</span>maven-shade-plugin<span style="color:#000080">&lt;/artifactId&gt;</span>
    <span style="color:#000080">&lt;executions&gt;</span>
        <span style="color:#000080">&lt;execution&gt;</span>
            <span style="color:#000080">&lt;phase&gt;</span>package<span style="color:#000080">&lt;/phase&gt;</span>
            <span style="color:#000080">&lt;goals&gt;</span>
                <span style="color:#000080">&lt;goal&gt;</span>shade<span style="color:#000080">&lt;/goal&gt;</span>
            <span style="color:#000080">&lt;/goals&gt;</span>
            <span style="color:#000080">&lt;configuration&gt;</span>
                ...
                ...
                <span style="color:#000080">&lt;relocations&gt;</span>
                    <span style="color:#000080">&lt;relocation&gt;</span>
                        <span style="color:#000080">&lt;pattern&gt;</span>${shade.com.google.source}<span style="color:#000080">&lt;/pattern&gt;</span>
                        <span style="color:#000080">&lt;shadedPattern&gt;</span>${shade.com.google.target}<span style="color:#000080">&lt;/shadedPattern&gt;</span>
                    <span style="color:#000080">&lt;/relocation&gt;</span>
                    <span style="color:#000080">&lt;relocation&gt;</span>
                        <span style="color:#000080">&lt;pattern&gt;</span>${shade.io.grpc.source}<span style="color:#000080">&lt;/pattern&gt;</span>
                        <span style="color:#000080">&lt;shadedPattern&gt;</span>${shade.io.grpc.target}<span style="color:#000080">&lt;/shadedPattern&gt;</span>
                    <span style="color:#000080">&lt;/relocation&gt;</span>
                    <span style="color:#000080">&lt;relocation&gt;</span>
                        <span style="color:#000080">&lt;pattern&gt;</span>${shade.io.netty.source}<span style="color:#000080">&lt;/pattern&gt;</span>
                        <span style="color:#000080">&lt;shadedPattern&gt;</span>${shade.io.netty.target}<span style="color:#000080">&lt;/shadedPattern&gt;</span>
                    <span style="color:#000080">&lt;/relocation&gt;</span>
                    <span style="color:#000080">&lt;relocation&gt;</span>
                        <span style="color:#000080">&lt;pattern&gt;</span>${shade.io.opencensus.source}<span style="color:#000080">&lt;/pattern&gt;</span>
                        <span style="color:#000080">&lt;shadedPattern&gt;</span>${shade.io.opencensus.target}<span style="color:#000080">&lt;/shadedPattern&gt;</span>
                    <span style="color:#000080">&lt;/relocation&gt;</span>
                    <span style="color:#000080">&lt;relocation&gt;</span>
                        <span style="color:#000080">&lt;pattern&gt;</span>${shade.io.perfmark.source}<span style="color:#000080">&lt;/pattern&gt;</span>
                        <span style="color:#000080">&lt;shadedPattern&gt;</span>${shade.io.perfmark.target}<span style="color:#000080">&lt;/shadedPattern&gt;</span>
                    <span style="color:#000080">&lt;/relocation&gt;</span>
                    <span style="color:#000080">&lt;relocation&gt;</span>
                        <span style="color:#000080">&lt;pattern&gt;</span>${shade.org.slf4j.source}<span style="color:#000080">&lt;/pattern&gt;</span>
                        <span style="color:#000080">&lt;shadedPattern&gt;</span>${shade.org.slf4j.target}<span style="color:#000080">&lt;/shadedPattern&gt;</span>
                    <span style="color:#000080">&lt;/relocation&gt;</span>
                <span style="color:#000080">&lt;/relocations&gt;</span>
                ...
                ...
            <span style="color:#000080">&lt;/configuration&gt;</span>
        <span style="color:#000080">&lt;/execution&gt;</span>
    <span style="color:#000080">&lt;/executions&gt;</span>
<span style="color:#000080">&lt;/plugin&gt;</span>
</code></pre></div><p>除了上面的注意点以外，我们来看一下另一个场景，假设我们需要在 agent plugin 的 interceptor 中使用 plugin 中定义的 BootService 会发生什么？</p>
<p>我们回到 BootService 的加载逻辑，为了加载到 plugin 中定义的BootService，ServiceLoader 指定了类装载器为AgentClassLoader.getDefault()，
（这行代码历史非常悠久，可以追溯到2018年：<a href="https://github.com/apache/skywalking/pull/1111">Allow use SkyWalking plugin to override service in Agent core. #1111</a> ），
由此可见，plugin 中定义的 BootService 的 classloader 是 AgentClassLoader.getDefault()：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">load</span><span style="color:#000;font-weight:bold">(</span>List<span style="color:#000;font-weight:bold">&lt;</span>BootService<span style="color:#000;font-weight:bold">&gt;</span> allServices<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000;font-weight:bold">final</span> BootService bootService <span style="color:#000;font-weight:bold">:</span> ServiceLoader<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">load</span><span style="color:#000;font-weight:bold">(</span>BootService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">,</span> AgentClassLoader<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getDefault</span><span style="color:#000;font-weight:bold">()))</span> <span style="color:#000;font-weight:bold">{</span>
        allServices<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>bootService<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>再来看下 interceptor 的加载逻辑，<a href="https://github.com/apache/skywalking-java/blob/main/apm-sniffer/apm-agent-core/src/main/java/org/apache/skywalking/apm/agent/core/plugin/loader/InterceptorInstanceLoader.java">InterceptorInstanceLoader.java</a>
的 load 方法规定了如果父加载器相同，plugin 中的 interceptor 将使用一个新创建的 AgentClassLoader （在绝大部分简单场景中，plugin 的 interceptor 都由同一个 AgentClassLoader 加载）：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">&lt;</span>T<span style="color:#000;font-weight:bold">&gt;</span> T <span style="color:#900;font-weight:bold">load</span><span style="color:#000;font-weight:bold">(</span>String className<span style="color:#000;font-weight:bold">,</span>
    ClassLoader targetClassLoader<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> IllegalAccessException<span style="color:#000;font-weight:bold">,</span> InstantiationException<span style="color:#000;font-weight:bold">,</span> ClassNotFoundException<span style="color:#000;font-weight:bold">,</span> AgentPackageNotFoundException <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">...</span>
    <span style="color:#000;font-weight:bold">...</span>
    pluginLoader <span style="color:#000;font-weight:bold">=</span> EXTEND_PLUGIN_CLASSLOADERS<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">get</span><span style="color:#000;font-weight:bold">(</span>targetClassLoader<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>pluginLoader <span style="color:#000;font-weight:bold">==</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
        pluginLoader <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> AgentClassLoader<span style="color:#000;font-weight:bold">(</span>targetClassLoader<span style="color:#000;font-weight:bold">);</span>
        EXTEND_PLUGIN_CLASSLOADERS<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">put</span><span style="color:#000;font-weight:bold">(</span>targetClassLoader<span style="color:#000;font-weight:bold">,</span> pluginLoader<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">...</span>
    <span style="color:#000;font-weight:bold">...</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>按照类装载器的委派机制，interceptor 中如果用到了 BootService，也会由当前的类的装载器去装载。
所以 ServiceManager 中装载的 BootService 和 interceptor 装载的 BootService 并不是同一个 （一个 class 文件被不同的 classloader 装载了两次），如果在 interceptor 中 调用 BootService 方法，同样会发生 cast 异常。
由此可见，目前的实现并不支持我们在interceptor中直接调用 plugin 中 BootService 的方法，如果需要调用，只能将 BootService 放到 agent-core 中，由更高级别的类装载器优先装载。</p>
<p>这其实并不是 skywalking-agent 的问题，skywalking agent plugin 专注于自己的应用场景，只需要关注 trace、meter 以及默认 BootService 的覆盖就可以了。
只是我们如果有扩展 skywalking-agent 的需求，要对其类装载机制做到心中有数，否则可能会出现一些意想不到的问题。</p>
<h2 id="oap-arthas-controller-module">oap arthas-controller-module</h2>
<p>看完 agent-plugin 的实现，我们再来看看 oap 部分的修改，oap 同样是模块化的设计，我们可以很轻松的增加一个新的模块，在 /oap-server/ 目录下新建 arthas-controller 子模块：</p>
<pre><code>arthas-controller/
├── pom.xml
└── src
    └── main
        ├── java
        │   └── org
        │       └── apache
        │           └── skywalking
        │               └── oap
        │                   └── arthas
        │                       ├── ArthasControllerModule.java      # 模块定义
        │                       ├── ArthasControllerProvider.java    # 模块逻辑实现者
        │                       ├── CommandQueue.java
        │                       └── handler
        │                           ├── CommandGrpcHandler.java      # grpc handler,供 plugin 通信使用
        │                           └── CommandRestHandler.java      # http handler,供 skywalking-ui 通信使用
        ├── proto
        │   └── ArthasCommandService.proto
        └── resources
            └── META-INF
                └── services                                         # 模块及模块实现的 spi service
                    ├── org.apache.skywalking.oap.server.library.module.ModuleDefine
                    └── org.apache.skywalking.oap.server.library.module.ModuleProvider
</code></pre><p>模块的定义非常简单，只包含一个模块名，由于我们新增的模块并不需要暴露service给其他模块调用，services 我们返回一个空数组</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ArthasControllerModule</span> <span style="color:#000;font-weight:bold">extends</span> ModuleDefine <span style="color:#000;font-weight:bold">{</span>

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> String NAME <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;arthas-controller&#34;</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#000;font-weight:bold">public</span> <span style="color:#900;font-weight:bold">ArthasControllerModule</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">super</span><span style="color:#000;font-weight:bold">(</span>NAME<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> Class<span style="color:#000;font-weight:bold">&lt;?&gt;[]</span> services<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> Class<span style="color:#000;font-weight:bold">[</span>0<span style="color:#000;font-weight:bold">];</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>接着是模块实现者，实现者取名为 default，module 指定该 provider 所属模块，由于没有模块的自定义配置，newConfigCreator 我们返回null即可。
start 方法分别向 CoreModule 的 grpc 服务和 http 服务注册了两个 handler，grpc 服务和 http 服务就是我们熟知的 11800 和 12800 端口：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">ArthasControllerProvider</span> <span style="color:#000;font-weight:bold">extends</span> ModuleProvider <span style="color:#000;font-weight:bold">{</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> String <span style="color:#900;font-weight:bold">name</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;default&#34;</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> Class<span style="color:#000;font-weight:bold">&lt;?</span> <span style="color:#000;font-weight:bold">extends</span> ModuleDefine<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">module</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> ArthasControllerModule<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> ConfigCreator<span style="color:#000;font-weight:bold">&lt;?&gt;</span> newConfigCreator<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">null</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">prepare</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> ServiceNotProvidedException <span style="color:#000;font-weight:bold">{</span>

    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">start</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> ServiceNotProvidedException<span style="color:#000;font-weight:bold">,</span> ModuleStartException <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// grpc service for agent
</span><span style="color:#998;font-style:italic"></span>        GRPCHandlerRegister grpcService <span style="color:#000;font-weight:bold">=</span> getManager<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">find</span><span style="color:#000;font-weight:bold">(</span>CoreModule<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">NAME</span><span style="color:#000;font-weight:bold">)</span>
                                                      <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">provider</span><span style="color:#000;font-weight:bold">()</span>
                                                      <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getService</span><span style="color:#000;font-weight:bold">(</span>GRPCHandlerRegister<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
        grpcService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addHandler</span><span style="color:#000;font-weight:bold">(</span>
            <span style="color:#000;font-weight:bold">new</span> CommandGrpcHandler<span style="color:#000;font-weight:bold">()</span>
        <span style="color:#000;font-weight:bold">);</span>

        <span style="color:#998;font-style:italic">// rest service for ui
</span><span style="color:#998;font-style:italic"></span>        HTTPHandlerRegister restService <span style="color:#000;font-weight:bold">=</span> getManager<span style="color:#000;font-weight:bold">().</span><span style="color:#008080">find</span><span style="color:#000;font-weight:bold">(</span>CoreModule<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">NAME</span><span style="color:#000;font-weight:bold">)</span>
                                                      <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">provider</span><span style="color:#000;font-weight:bold">()</span>
                                                      <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getService</span><span style="color:#000;font-weight:bold">(</span>HTTPHandlerRegister<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">);</span>
        restService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addHandler</span><span style="color:#000;font-weight:bold">(</span>
            <span style="color:#000;font-weight:bold">new</span> CommandRestHandler<span style="color:#000;font-weight:bold">(),</span>
            Collections<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">singletonList</span><span style="color:#000;font-weight:bold">(</span>HttpMethod<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">POST</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">notifyAfterCompleted</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">throws</span> ServiceNotProvidedException <span style="color:#000;font-weight:bold">{</span>

    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span>
    <span style="color:#000;font-weight:bold">public</span> String<span style="color:#000;font-weight:bold">[]</span> <span style="color:#900;font-weight:bold">requiredModules</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> String<span style="color:#000;font-weight:bold">[</span>0<span style="color:#000;font-weight:bold">];</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>最后在配置文件中注册本模块及模块实现者，下面的配置表示 arthas-controller 这个 module 由 default provider 提供实现：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#000080">arthas-controller</span>:<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">selector</span>:<span style="color:#bbb"> </span>default<span style="color:#bbb">
</span><span style="color:#bbb">  </span><span style="color:#000080">default</span>:<span style="color:#bbb">
</span></code></pre></div><p>CommandGrpcHandler 和 CommandHttpHandler 的逻辑非常简单，CommandHttpHandler 定义了 connect 和 disconnect 接口，
收到请求后会放到一个 Queue 中供 CommandGrpcHandler 消费，Queue 的实现如下，这里不再赘述：</p>
<pre><code>public class CommandQueue {

    private static final Map&lt;String, Command&gt; COMMANDS = new ConcurrentHashMap&lt;&gt;();

    // produce by connect、disconnect
    public static void produceCommand(String serviceName, String instanceName, Command command) {
        COMMANDS.put(serviceName + instanceName, command);
    }

    // consume by agent getCommand task
    public static Optional&lt;Command&gt; consumeCommand(String serviceName, String instanceName) {
        return Optional.ofNullable(COMMANDS.remove(serviceName + instanceName));
    }
}
</code></pre><h2 id="skywalking-ui-arthas-console">skywalking-ui arthas console</h2>
<p>完成了 agent 和 oap 的开发，我们再看下 ui 部分：</p>
<ol>
<li>connect：调用oap server connect 接口，并连接 arthas-tunnel-server</li>
<li>disconnect：调用oap server disconnect 接口，并与 arthas-tunnel-server 断开连接</li>
<li>arthas 命令交互，这部分代码主要参考 arthas，大家可以查看 <a href="https://github.com/alibaba/arthas/blob/master/web-ui/arthasWebConsole/all/share/component/Console.vue">web-ui console</a> 的实现</li>
</ol>
<p>修改完skywalking-ui的代码后，我们可以直接通过 <code>npm run dev</code> 测试了。</p>
<p>如果需要通过主项目打包，别忘了在apm-webapp 的 <a href="https://github.com/apache/skywalking/blob/master/apm-webapp/src/main/java/org/apache/skywalking/oap/server/webapp/ApplicationStartUp.java">ApplicationStartUp.java</a> 类中添加一条 arthas 的路由：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">Server
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">builder</span><span style="color:#000;font-weight:bold">()</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">port</span><span style="color:#000;font-weight:bold">(</span>port<span style="color:#000;font-weight:bold">,</span> SessionProtocol<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">HTTP</span><span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">service</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/arthas&#34;</span><span style="color:#000;font-weight:bold">,</span> oap<span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">service</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/graphql&#34;</span><span style="color:#000;font-weight:bold">,</span> oap<span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">service</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/internal/l7check&#34;</span><span style="color:#000;font-weight:bold">,</span> HealthCheckService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">of</span><span style="color:#000;font-weight:bold">())</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">service</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/zipkin/config.json&#34;</span><span style="color:#000;font-weight:bold">,</span> zipkin<span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">serviceUnder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/zipkin/api&#34;</span><span style="color:#000;font-weight:bold">,</span> zipkin<span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">serviceUnder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/zipkin&#34;</span><span style="color:#000;font-weight:bold">,</span>
        FileService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">of</span><span style="color:#000;font-weight:bold">(</span>
            ApplicationStartUp<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getClassLoader</span><span style="color:#000;font-weight:bold">(),</span>
            <span style="color:#d14">&#34;/zipkin-lens&#34;</span><span style="color:#000;font-weight:bold">)</span>
            <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">orElse</span><span style="color:#000;font-weight:bold">(</span>zipkinIndexPage<span style="color:#000;font-weight:bold">))</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">serviceUnder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/&#34;</span><span style="color:#000;font-weight:bold">,</span>
        FileService<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">of</span><span style="color:#000;font-weight:bold">(</span>
            ApplicationStartUp<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getClassLoader</span><span style="color:#000;font-weight:bold">(),</span>
            <span style="color:#d14">&#34;/public&#34;</span><span style="color:#000;font-weight:bold">)</span>
            <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">orElse</span><span style="color:#000;font-weight:bold">(</span>indexPage<span style="color:#000;font-weight:bold">))</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">()</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">start</span><span style="color:#000;font-weight:bold">()</span>
    <span style="color:#000;font-weight:bold">.</span><span style="color:#008080">join</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><h2 id="总结">总结</h2>
<ol>
<li>BootService 启动及停止流程</li>
<li>如何利用 BootService 实现自定义逻辑</li>
<li>Agent Plugin 的类装载机制</li>
<li>maven-shade-plugin 的使用与注意点</li>
<li>如何利用 ModuleDefine 与 ModuleProvider 定义新的模块</li>
<li>如何向 GRPC、HTTP Service 添加新的 handler</li>
</ol>
<p>如果你还有任何的疑问，<a href="https://github.com/weixiang1862/skywalking-x-arthas/issues">欢迎大家与我交流</a> 。</p>

	

	<ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5">
  <li>
    <a href="/zh/2023-07-30-complete-auto-instrumentation-go-agent-for-distributed-tracing-and-monitoring/" class="btn btn-primary "><span class="mr-1">←</span> Previous</a>
  </li>
    <a href="/zh/2023-08-20-coc-asia-2023/" class="btn btn-primary ">Next <span class="ml-1">→</span></a>
  </li>
</ul>

</div>


          </main>
          <div class="toc d-none d-xl-block d-md-none col-xl-2 td-toc d-print-none">
            <div class="tags-wrapper">
    <div class="font-weight-bold post-meta ">
        <i class="iconfont icon-tags pr-1" aria-hidden="true"></i>
        Tags
    </div>
    <ul class="tags-box">
        
        <li>
            <a href="/zh_tags/agent/" class="tag-link">Agent</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/zh_tags/apache-shenyu-incubating/" class="tag-link">Apache ShenYu (incubating)</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/conference/" class="tag-link">Conference</a>
            <span class="count">9</span>
        </li>
        
        <li>
            <a href="/zh_tags/course/" class="tag-link">Course</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/development/" class="tag-link">Development</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/zh_tags/dotnetcore/" class="tag-link">DotNetCore</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/ebpf/" class="tag-link">eBPF</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/elasticsearch/" class="tag-link">ElasticSearch</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/java/" class="tag-link">Java</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/zh_tags/logging/" class="tag-link">Logging</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/metrics/" class="tag-link">Metrics</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/observability/" class="tag-link">Observability</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/open-source-contribution/" class="tag-link">Open Source Contribution</a>
            <span class="count">4</span>
        </li>
        
        <li>
            <a href="/zh_tags/open-source-promotion-plan/" class="tag-link">Open Source Promotion Plan</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/zh_tags/performance/" class="tag-link">Performance</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/profiling/" class="tag-link">Profiling</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/release-blog/" class="tag-link">Release Blog</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/zh_tags/service-mesh/" class="tag-link">Service Mesh</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/shardingsphere/" class="tag-link">ShardingSphere</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/shardingsphere-proxy/" class="tag-link">ShardingSphere-proxy</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/skywalking/" class="tag-link">SkyWalking</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/source-code/" class="tag-link">Source Code</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/tracing/" class="tag-link">Tracing</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/zh_tags/use-case/" class="tag-link">Use Case</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/zh_tags/user-manual/" class="tag-link">User Manual</a>
            <span class="count">16</span>
        </li>
        
        <li>
            <a href="/zh_tags/video/" class="tag-link">Video</a>
            <span class="count">11</span>
        </li>
        
        <li>
            <a href="/zh_tags/web-ui/" class="tag-link">Web UI</a>
            <span class="count">1</span>
        </li>
        
    </ul>
</div>


            




<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">











</div>






<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#背景介绍">背景介绍</a>
          <ul>
            <li><a href="#connect">connect</a></li>
            <li><a href="#disconnect">disconnect</a></li>
          </ul>
        </li>
        <li><a href="#agent-arthas-control-plugin">agent arthas-control-plugin</a></li>
        <li><a href="#oap-arthas-controller-module">oap arthas-controller-module</a></li>
        <li><a href="#skywalking-ui-arthas-console">skywalking-ui arthas console</a></li>
        <li><a href="#总结">总结</a></li>
      </ul>
    </li>
  </ul>
</nav>




<script>
  $(function () {
    var $toc = $("#TableOfContents");
    if (!$toc || !$toc.length) {
      return;
    }
    var top = $toc.offset().top;
    $(window).on("scroll", debounce(setTop, 100))
    $(window).on("scroll", debounce(addActive, 30))

    function addActive() {
      var scrollValue = $(window).scrollTop();
      var topEle = null;
      $.each($('main h1, main h2, main h3'), function (index, item) {
        if ($(item).offset().top - 70 > scrollValue) {
          return
        }
        if (!topEle) {
          topEle = item
        } else if ($(item).offset().top >= $(topEle).offset().top) {
          topEle = item
        }
        if (topEle) {
          var id = $(item).attr('id');
          $toc.find('a').removeClass("active").end().find('a[href="' + '#' + id + '"]').addClass("active")
        }
      })
    }

    function setTop() {
      var scrollValue = $(window).scrollTop();
      if (scrollValue >= top - 70) {
        $toc.addClass('fixed')
      } else {
        $toc.removeClass('fixed')
      }
    }

    function debounce(fn, wait) {
      var timeout = null;
      return function () {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          fn.apply(this, arguments);
        }, wait);
      };
    }
  })

</script>


          </div>
        </div>
      </div>
      
<footer class="py-5 sky-row">
  <div class="container-fluid text-center">
    <div class="">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-color" target="_blank" href="https://twitter.com/asfskywalking">
      <i class="iconfont icon-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-color" target="_blank" href="http://s.apache.org/slack-invite">
      <i class="iconfont icon-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Mailing list" aria-label="Mailing list">
    <a class="text-color" target="_blank" href="https://lists.apache.org/list.html?dev@skywalking.apache.org">
      <i class="iconfont icon-email"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-color" target="_blank" href="https://github.com/apache/skywalking">
      <i class="iconfont icon-github"></i>
    </a>
  </li>
  
</ul>

        
        
    </div>
    <div class="">

        <small class="text-color">&copy; 2017 - 2024 The Apache Software Foundation All Rights Reserved</small>
        
	
    </div>
    <div class="">
      <small class="text-color mt-4">Apache SkyWalking, SkyWalking, Apache, the Apache feather logo, and the Apache SkyWalking project logo are either registered trademarks or trademarks of the Apache Software Foundation.</small>
    </div>
  </div>
</footer>


    </div>
    





























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































    
<div id="popup">
    <div class="mask">
        <img src=""/>
    </div>
</div>

    <div class="sidebar-mask"></div>
<div class="sidebar">
    <nav class="nav-links">
        <div class="nav-item"><a href="/docs/" class="nav-link">Projects and Documentation</a></div>
        <div class="nav-item"><a href="/events/" class="nav-link">Events</a></div>
        <div class="nav-item"><a href="/blog/" class="nav-link router-link-exact-active router-link-active">Blog</a>
        </div>
        <div class="nav-item"><a href="/downloads/" class="nav-link">Downloads</a></div>
        <div class="nav-item"><a href="/team/" class="nav-link">Team</a></div>
        <div class="nav-item"><a href="/users/" class="nav-link">Users</a></div>
        <div class="nav-item">
            <div class="dropdown-wrapper open">
                <a class="dropdown-title"><span>中文资料</span>
                    <span class="arrow down"></span>
                </a>
                <ul class="nav-dropdown">
                    <li class="dropdown-item">
                        <a href="/zh/" class="nav-link external">博客</a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://space.bilibili.com/390683219" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">B站</a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://juejin.cn/user/13673577331607" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">掘金</a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="nav-item">
            <div class="dropdown-wrapper open">
                <a class="dropdown-title">
                    <span>Links</span>
                    <span class="arrow down"></span>
                </a>
                <ul class="nav-dropdown">
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Apache Software Foundation
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://github.com/apache/skywalking/issues"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            GitHub Issue Tracker
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://lists.apache.org/list.html?dev@skywalking.apache.org" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Dev Mailing List
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/licenses/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            License
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/events/current-event"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Apache Events
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/security/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Security
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/foundation/sponsorship.html"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Sponsorship and Donate
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/foundation/thanks.html"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Thanks
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</div>

    <script src="/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>









<script src="/js/main.min.dc00f5ca911ee5aa105ea6de6b3b7e8d8169ba5a3bf156b1fcfe23dfe3e62b0a.js" integrity="sha256-3AD1ypEe5aoQXqbeazt&#43;jYFpulo78Vax/P4j3&#43;PmKwo=" crossorigin="anonymous"></script>


<script src="/js/mermaid.min.js"></script>
<script>
    window.onload = () => mermaid.init(undefined, ".language-mermaid");
</script>


<script defer
src="https://widget.kapa.ai/kapa-widget.bundle.js"
data-website-id="8a08392b-9c4d-4816-8bc4-f93e0ecdd2a7"
data-project-name="SkyWalking"
data-project-color="#2B74B8"
data-button-text="Ask AI"
data-search-mode-enabled="true"
data-modal-open-on-command-k="true"
data-modal-disclaimer="The AI supports multiple languages, but it may not be accessible in China, a proxy is required."
data-project-logo="https://miro.medium.com/v2/resize:fit:2400/0*kmS-5BQ8ShAhZ_F4.jpg"
data-modal-example-questions="What is Apache SkyWalking?,How to deploy SkyWalking?,How to inject agents non-intrusively?,How to setup trace sampling?"
data-button-position-top=""
data-button-position-right="20px"
data-button-position-bottom="200px"
data-button-position-left=""
></script>




  </body>
</html>
