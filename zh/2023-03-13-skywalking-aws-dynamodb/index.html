<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="twitter:site" content="skywalking.apache.org">
<meta name="twitter:image:src" content="https://skywalking.apache.org/images/skywalking_400x400.png">
<meta property="og:image" content="https://skywalking.apache.org/images/skywalking_400x400.png">

<meta http-equiv="Content-Security-Policy" content="frame-src 'self' https://www.google.com https://app.netlify.com;">

<meta name="generator" content="Hugo 0.80.0" />


<script async src="https://www.googletagmanager.com/gtag/js?id=G-GR8N6PGRJ3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);};
  gtag('js', new Date());gtag('config', 'G-GR8N6PGRJ3');
</script>
<META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
<link rel="stylesheet" href="//at.alicdn.com/t/c/font_3007530_pvozs1rz2wn.css">



<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
<link rel="manifest" href="/favicons/site.webmanifest">
<link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<title>使用SkyWalking监控DynamoDB | Apache SkyWalking</title><meta property="og:title" content="使用SkyWalking监控DynamoDB" />
<meta property="og:description" content="本文将展示如何使用 Apache SkyWalking 监控 Amazon DynamoDB." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/zh/2023-03-13-skywalking-aws-dynamodb/" />
<meta property="article:published_time" content="2023-03-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-02-19T22:02:37-05:00" />
<meta itemprop="name" content="使用SkyWalking监控DynamoDB">
<meta itemprop="description" content="本文将展示如何使用 Apache SkyWalking 监控 Amazon DynamoDB.">
<meta itemprop="datePublished" content="2023-03-13T00:00:00+00:00" />
<meta itemprop="dateModified" content="2024-02-19T22:02:37-05:00" />
<meta itemprop="wordCount" content="692">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="使用SkyWalking监控DynamoDB"/>
<meta name="twitter:description" content="本文将展示如何使用 Apache SkyWalking 监控 Amazon DynamoDB."/>



<link rel="preload" href="/scss/main.min.592235942cb3c9f3dd697382a4e7a1fad8e1c182dad2841bdce6b43b4a346ae8.css" as="style">
<link href="/scss/main.min.592235942cb3c9f3dd697382a4e7a1fad8e1c182dad2841bdce6b43b4a346ae8.css" rel="stylesheet" integrity="">



<link rel="stylesheet" href="/css/docSearch.css" />


<script src="/js/jquery-3.6.0.min.js"></script>





    <title>使用SkyWalking监控DynamoDB | Apache SkyWalking</title>
  </head>
  <body class="td-page td-blog">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand  flex-column flex-md-row td-navbar">
    <div class="sidebar-button">
      <i class="iconfont icon-menu"></i>
    </div>
    <a class="navbar-brand" href="/">
        <span class="navbar-logo"><img width="130" src="/images/logo.svg" alt="SkyWalking"></span> 
    </a>
    <div class="td-navbar-nav-scroll navbar-nav-wrapper" id="navigation">
        <ul class="navbar-nav mt-lg-0">
             
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/docs" ><span>Projects and Docs</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/events" ><span>Events</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/blog" ><span>Blogs</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/downloads" ><span>Downloads</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/team" ><span>Team</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/users" ><span>Users</span></a>
			</li>
            
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
                <span class="link dropdown blog">
                    <a class="link-name nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">中文资料</a>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="/zh/">博客</a>
                        <a class="dropdown-item" href="https://space.bilibili.com/390683219" target="_blank" rel="noopener noreferrer">
                            B站
                        </a>
                        <a class="dropdown-item" href="https://juejin.cn/user/13673577331607" target="_blank" rel="noopener noreferrer">
                            掘金
                        </a>
                    </div>
                </span>
            </li>

            
			
        </ul>
    </div>
    <div class="navbar-nav d-none d-lg-block search-input-box">
         
            
        
            
        
            
        
            
        
            
        
            
        
            
            <span class="link dropdown">
                <a class="link-name dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Links
                </a>
                <div class="dropdown-menu">
                    
                    <a class="dropdown-item" href="http://www.apache.org/">Apache Software Foundation</a> 
                    <a class="dropdown-item" href="https://github.com/apache/skywalking/issues">GitHub Issue Tracker</a> 
                    <a class="dropdown-item" href="https://github.com/apache/skywalking/discussions">Discussion</a> 
                    <a class="dropdown-item" href="https://lists.apache.org/list.html?dev@skywalking.apache.org">Dev Mailing List</a> 
                    <a class="dropdown-item" href="https://cwiki.apache.org/confluence/display/SKYWALKING/Home">WIKI</a> 
                    <a class="dropdown-item" href="http://www.apache.org/licenses/">License</a> 
                    <a class="dropdown-item" href="http://www.apache.org/events/current-event">Apache Events</a> 
                    <a class="dropdown-item" href="http://www.apache.org/security/">Security</a> 
                    <a class="dropdown-item" href="http://www.apache.org/foundation/sponsorship.html">Sponsor and Donate</a> 
                    <a class="dropdown-item" href="http://www.apache.org/foundation/thanks.html">Thanks</a> 
                    <a class="dropdown-item" href="https://apache.org/foundation/policies/privacy.html">Privacy</a> 
                </div>
            </span>
            
        
        
<div id="docsearch"></div>


    </div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row container container-center">
          <main class="col-12 col-md-12 col-xl-10 pl-md-4 pr-md-4" role="main">
            
<div class="td-content">
	<h1>使用SkyWalking监控DynamoDB</h1>
	<div class="lead">本文将展示如何使用 Apache SkyWalking 监控 Amazon DynamoDB.</div>
	<div class="td-byline mb-4">
		By <b>张跃骎</b> |
		<time datetime="2023-03-13" class="text-muted">Monday, March 13, 2023</time>

	    

	</div>
	<p><img src="./icon.png" alt="icon.png"></p>
<h2 id="背景">背景</h2>
<p><a href="https://skywalking.apache.org/">Apache SkyWalking</a>  是一个开源应用性能管理系统，帮助用户收集和聚合日志、追踪、指标和事件，并在 UI 上显示。从 OAP 9.4.0 开始，SkyWalking 新增了 <a href="https://skywalking.apache.org/docs/main/next/en/setup/backend/aws-firehose-receiver/">AWS Firehose receiver</a>，用来接收，计算CloudWatch metrics的数据。本文将以DynamoDB为例，展示如何使用 SkyWalking接收并计算 CloudWatch metrics 数据，以监控Amazon Web Services。</p>
<h2 id="什么是-amazon-cloudwatch-与-amazon-kinesis-data-firehose-">什么是 Amazon CloudWatch 与 Amazon Kinesis Data Firehose ？</h2>
<p><a href="https://aws.amazon.com/cn/cloudwatch/">Amazon CloudWatch</a> 是一个指标存储库, 此工具可从 AWS中 ( 如 DynamoDB ) 收集原始数据，近实时处理为可读取的指标。同时，我们也可以使用<strong>指标流</strong>持续地将 CloudWatch 指标流式传输到所选的目标位置，实现近实时传送和低延迟。SkyWalking 利用此特性，创建指标流并将其导向 Amazon Kinesis Data Firehose 传输流，并由后者进一步传输处理。</p>
<p><a href="https://aws.amazon.com/cn/kinesis/data-firehose/">Amazon Kinesis Data Firehose</a>是一项提取、转换、加载服务，可以将流式处理数据以可靠方式捕获、转换和提供到数据湖、数据存储和分析服务中。SkyWalking利用此特性，将指标流最终导向 aws-firehose-receiver，交由OAP计算并最终展示指标。</p>
<p>整体过程流程图如下：</p>
<p><img src="./aws-service.png" alt="aws-service.png"></p>
<h6 id="注意">注意</h6>
<ul>
<li>由于 Kinesis Data Firehose 规定，HTTP端点的URL必须使用HTTPS协议，且必须使用443端口。同时，此URL必须由Gateway代理并转发到真正的aws-firehose-receiver。</li>
<li>TLS 证书必须由CA签发的，自签证书不会被 Kinesis Data Firehose 信任。</li>
</ul>
<h2 id="设置dynamodb监控">设置DynamoDB监控</h2>
<p>接下来以DynamoDB为例说明使用OAP 收集CloudWatch metrics 前，aws中必要的设置:</p>
<ol>
<li>进入 <a href="https://console.aws.amazon.com/kinesis/home">Kinesis 控制台</a>，创建数据流， <code>Source</code>选择 <code>Direct PUT</code>, <code>Destination</code> 选择 <code>HTTP Endpoint</code>. 并且设置<code>HTTP Endpoint URL</code> 为 <code>Gateway对应URL</code>。 其余配置选项可由需要自行配置。</li>
</ol>
<p><img src="./kinesis.png" alt="image.png"></p>
<ol start="2">
<li>进入 <a href="https://console.aws.amazon.com/cloudwatch/home">CloudWatch 控制台</a>，在左侧控制面板中选择<code>Metrics-Stream</code>，点击Create metric stream。其中，<code>namespace</code> 选择 <code>AWS/DynamoDB</code>。同时，根据需要，也可以增加其他命名空间。 <code>Kinesis Data Firehose</code>选择在第一步中创建好的数据流。最后，设置输出格式为opentelemetry0.7。其余配置选项可由需要自行配置。</li>
</ol>
<p><img src="./cloudwatch.png" alt="cloudwatch.png"></p>
<p>至此，DynamoDB监控配置的AWS方面设置完成。</p>
<h2 id="skywalking-oap-指标处理分析">SkyWalking OAP 指标处理分析</h2>
<p>SkyWalking 利用 aws-firehose-receiver 接收并解码由Gateway转发来的 AWS 指标流，交由<a href="https://github.com/apache/skywalking/tree/master/oap-server/server-receiver-plugin/otel-receiver-plugin">Opentelemetry-receiver</a>进行处理，转化为SkyWalking metrics。并由<a href="https://skywalking.apache.org/docs/main/next/en/concepts-and-designs/mal/">Meter Analysis Language (MAL)</a>进行指标的分析与聚合，最终呈现在UI上。</p>
<p>其中 MAL 部分以及 UI 部分，SkyWalking支持用户自由定制，从而更多样性的展示指标数据。详情请参考<a href="https://skywalking.apache.org/docs/main/next/en/concepts-and-designs/mal/">MAL doc</a> 以及 <a href="https://skywalking.apache.org/docs/main/next/en/ui/readme/">UI doc</a>。</p>
<p><img src="./gateway_to_ui.png" alt="gateway_to_ui.png"></p>
<h2 id="典型指标分析">典型指标分析</h2>
<h3 id="作用域">作用域</h3>
<p>SkyWalking中，有作用域 ( scope ) 的概念。通过作用域, 我们可以对指标进行更合理的分类与聚合。在对DynamoDB的监控中，使用到了其中两种作用域———Service和Endpoint。</p>
<p>Service表示一组工作负荷，这些工作负荷为传入请求提供相同的行为。常用作服务的集群级别作用域，在AWS中，用户的账户更接近集群的概念。 所以SkyWalking将AWS account id作为key，将AWS账户映射为Service类型。</p>
<p>同理，Endpoint表示一种逻辑概念，常用于服务中用于传入请求的路径，例如 HTTP URI 路径或 gRPC 服务类 + 方法签名，也可以表示数据库中的表结构。所以SkyWalking将DynamoDB表映射为Endpoint类型。</p>
<h3 id="指标">指标</h3>
<table>
<thead>
<tr>
<th>指标名称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>AccountMaxReads / AccountMaxWrites</td>
<td>账户可以使用的最大 读取/写入 容量单位数。</td>
</tr>
<tr>
<td>AccountMaxTableLevelReads / AccountMaxTableLevelWrites</td>
<td>账户的表或全局二级索引可以使用的最大 读取/写入 容量单位数。</td>
</tr>
<tr>
<td>AccountProvisionedReadCapacityUtilization / AccountProvisionedWriteCapacityUtilization</td>
<td>账户使用的预置 读取/写入 容量单位百分比。</td>
</tr>
<tr>
<td>MaxProvisionedTableReadCapacityUtilization / MaxProvisionedTableWriteCapacityUtilization</td>
<td>账户的最高预调配 读取/写入 表或全局二级索引使用的预调配读取容量单位百分比。</td>
</tr>
</tbody>
</table>
<p>以上为一些常用的账户指标(Serivce 作用域)。它们是DynamoDB中的各种配置信息，SkyWalking通过对这些指标的监控，可以完整的展示出数据库配置的变动情况。</p>
<table>
<thead>
<tr>
<th>指标名称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>ConsumedReadCapacityUnits / ConsumedWriteCapacityUnits</td>
<td>指定时间段内占用的 读取/写入 容量单位数</td>
</tr>
<tr>
<td>ReturnedItemCount</td>
<td><code>Query</code>、<code>Scan</code> 或 <code>ExecuteStatement</code>（可选择）操作在指定时段内返回的项目数。</td>
</tr>
<tr>
<td>SuccessfulRequestLatency</td>
<td>指定时间段内对于 DynamoDB 或 Amazon DynamoDB Streams 的成功请求的延迟。</td>
</tr>
<tr>
<td>TimeToLiveDeletedItemCount</td>
<td>指定时间段内按存活时间 (TTL) 删除的项目数。</td>
</tr>
</tbody>
</table>
<p>以上为一些常用的表指标(Endpoint作用域)，它们也会被聚合到账户指标中。这些指标一般用于分析数据库的性能，用户可以通过它们判断出数据库配置的合理程度。例如，用户可以通过ConsumedReadCapicityUnits / ConsumedReadCapicityUnits，跟踪预置吞吐量的使用，从而判断表或账户的预制吞吐量的合理性。关于预置吞吐量，请参见<a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/ProvisionedThroughputIntro.html">读/写容量模式</a>。</p>
<table>
<thead>
<tr>
<th>指标名称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>UserErrors</td>
<td>在指定时间段内生成 HTTP 400 状态代码的对 DynamoDB 或 Amazon DynamoDB Streams 的请求。HTTP 400 通常表示客户端错误，如参数组合无效，尝试更新不存在的表或请求签名错误。</td>
</tr>
<tr>
<td>SystemErrors</td>
<td>在指定的时间段内生成 HTTP 500 状态代码的对 DynamoDB 或 Amazon DynamoDB Streams 的请求。HTTP 500 通常指示内部服务错误。</td>
</tr>
<tr>
<td>ThrottledRequests</td>
<td>超出资源（如表或索引）预置吞吐量限制的 DynamoDB 请求。</td>
</tr>
<tr>
<td>TransactionConflict</td>
<td>由于同一项目的并发请求之间的事务性冲突而被拒绝的项目级请求。</td>
</tr>
</tbody>
</table>
<p>以上为一些常用的错误指标，其中UserErrors为用户级别指标，其余为表级别指标。用户可以在这些指标上设置告警，如果警告出现，那么可能说明数据库的使用出现了一些问题，需要用户自行查看验证。</p>
<h3 id="注意-1">注意</h3>
<p>SkyWalking对于DynamoDB的指标选取直接来源于CloudWatch metrics， 您也可以通过<a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/metrics-dimensions.html">CloudWatch metrics doc</a>来获取指标详细信息。</p>
<h2 id="demo">Demo</h2>
<p>在本节中，我们将演示如何利用terraform创建一个DynamoDB表，以及可以产生指标流的其他AWS服务，并部署Skywalking完成指标收集。</p>
<p>首先，您需要一个正在运行的网关实例，例如 <a href="https://www.nginx.com/">NGINX</a>，它负责接收AWS传来的指标流并且转发到aws-firehose-receiver。注意, 网关需要配置证书以便接受HTTPS协议的请求。</p>
<p>下面是一个NGINX的示例配置。配置不要求完全一致，只要能将收到的HTTPS请求发送到<code>oap所在host:12801/aws/firehose/metrics</code>即可。</p>
<pre><code>server {
        listen       443 ssl;
        
        ssl_certificate     /crt/test.pem;
        ssl_certificate_key  /crt/test.key; 
        
        ssl_session_timeout  5m;   
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4; 
        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;  
        ssl_prefer_server_ciphers on; 
    
        location /aws/firehose/metrics {
            proxy_pass http://test.xyz:12801/aws/firehose/metrics;
        }
    }
</code></pre><h3 id="部署skywalking">部署SkyWalking</h3>
<p>SkyWalking的部署方式有很多种，您可以直接从<a href="https://github.com/apache/skywalking/releases/tag/v9.4.0">release页面</a>中直接获取。</p>
<p>当然，如果您更习惯于 Kubernetes，您也可以从<a href="https://github.com/apache/skywalking-kubernetes">SkyWalking-kubernetes</a>找到相应部署方式。</p>
<p>请注意，无论使用哪种部署方式，请确保OAP和UI的版本为9.4.0以上，并且需要开放12801端口。</p>
<p>下面是一个使用helm指令部署的示例：</p>
<pre><code>export SKYWALKING_RELEASE_VERSION=4.3.0 
export SKYWALKING_RELEASE_NAME=skywalking  
export SKYWALKING_RELEASE_NAMESPACE=default

helm install &quot;${SKYWALKING_RELEASE_NAME}&quot; \
  oci://registry-1.docker.io/apache/skywalking-helm \
  --version &quot;${SKYWALKING_RELEASE_VERSION}&quot; \
  -n &quot;${SKYWALKING_RELEASE_NAMESPACE}&quot; \
  --set oap.image.tag=9.4.0 \
  --set oap.storageType=elasticsearch \
  --set ui.image.tag=9.4.0 \
  --set oap.ports.firehose=12801
</code></pre><h3 id="开启对应aws服务">开启对应AWS服务</h3>
<p>terraform 配置文件如下（实例修改于<a href="https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/kinesis_firehose_delivery_stream">Terraform Registry - kinesis_firehose_delivery_stream</a>）：</p>
<details>
<summary>terraform 配置文件 </summary>
<pre><code>provider &quot;aws&quot; {
  region = &quot;ap-northeast-1&quot;
  access_key = &quot;在这里填入您的access_key&quot;
  secret_key = &quot;在这里填入您的secret_key&quot;
}
resource &quot;aws_dynamodb_table&quot; &quot;basic-dynamodb-table&quot; {
  name           = &quot;GameScores&quot;
  billing_mode   = &quot;PROVISIONED&quot;
  read_capacity  = 20
  write_capacity = 20
  hash_key       = &quot;UserId&quot;
  range_key      = &quot;GameTitle&quot;

  attribute {
    name = &quot;UserId&quot;
    type = &quot;S&quot;
  }

  attribute {
    name = &quot;GameTitle&quot;
    type = &quot;S&quot;
  }

  attribute {
    name = &quot;TopScore&quot;
    type = &quot;N&quot;
  }

  ttl {
    attribute_name = &quot;TimeToExist&quot;
    enabled        = true
  }

  global_secondary_index {
    name               = &quot;GameTitleIndex&quot;
    hash_key           = &quot;GameTitle&quot;
    range_key          = &quot;TopScore&quot;
    write_capacity     = 10
    read_capacity      = 10
    projection_type    = &quot;INCLUDE&quot;
    non_key_attributes = [&quot;UserId&quot;]
  }

  tags = {
    Name        = &quot;dynamodb-table-1&quot;
    Environment = &quot;production&quot;
  }
}

resource &quot;aws_cloudwatch_metric_stream&quot; &quot;main&quot; {
  name          = &quot;my-metric-stream&quot;
  role_arn      = aws_iam_role.metric_stream_to_firehose.arn
  firehose_arn  = aws_kinesis_firehose_delivery_stream.http_stream.arn
  output_format = &quot;opentelemetry0.7&quot;

  include_filter {
    namespace = &quot;AWS/DynamoDB&quot;
  }
}

# https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-metric-streams-trustpolicy.html
data &quot;aws_iam_policy_document&quot; &quot;streams_assume_role&quot; {
  statement {
    effect = &quot;Allow&quot;

    principals {
      type        = &quot;Service&quot;
      identifiers = [&quot;streams.metrics.cloudwatch.amazonaws.com&quot;]
    }

    actions = [&quot;sts:AssumeRole&quot;]
  }
}

resource &quot;aws_iam_role&quot; &quot;metric_stream_to_firehose&quot; {
  name               = &quot;metric_stream_to_firehose_role&quot;
  assume_role_policy = data.aws_iam_policy_document.streams_assume_role.json
}

# https://docs.aws.amazon.com/AmazonCloudWatch/latest/monitoring/CloudWatch-metric-streams-trustpolicy.html
data &quot;aws_iam_policy_document&quot; &quot;metric_stream_to_firehose&quot; {
  statement {
    effect = &quot;Allow&quot;

    actions = [
      &quot;firehose:PutRecord&quot;,
      &quot;firehose:PutRecordBatch&quot;,
    ]

    resources = [aws_kinesis_firehose_delivery_stream.http_stream.arn]
  }
}
resource &quot;aws_iam_role_policy&quot; &quot;metric_stream_to_firehose&quot; {
  name   = &quot;default&quot;
  role   = aws_iam_role.metric_stream_to_firehose.id
  policy = data.aws_iam_policy_document.metric_stream_to_firehose.json
}

resource &quot;aws_s3_bucket&quot; &quot;bucket&quot; {
  bucket = &quot;metric-stream-test-bucket&quot;
}

resource &quot;aws_s3_bucket_acl&quot; &quot;bucket_acl&quot; {
  bucket = aws_s3_bucket.bucket.id
  acl    = &quot;private&quot;
}

data &quot;aws_iam_policy_document&quot; &quot;firehose_assume_role&quot; {
  statement {
    effect = &quot;Allow&quot;

    principals {
      type        = &quot;Service&quot;
      identifiers = [&quot;firehose.amazonaws.com&quot;]
    }

    actions = [&quot;sts:AssumeRole&quot;]
  }
}

resource &quot;aws_iam_role&quot; &quot;firehose_to_s3&quot; {
  assume_role_policy = data.aws_iam_policy_document.firehose_assume_role.json
}

data &quot;aws_iam_policy_document&quot; &quot;firehose_to_s3&quot; {
  statement {
    effect = &quot;Allow&quot;

    actions = [
      &quot;s3:AbortMultipartUpload&quot;,
      &quot;s3:GetBucketLocation&quot;,
      &quot;s3:GetObject&quot;,
      &quot;s3:ListBucket&quot;,
      &quot;s3:ListBucketMultipartUploads&quot;,
      &quot;s3:PutObject&quot;,
    ]

    resources = [
      aws_s3_bucket.bucket.arn,
      &quot;${aws_s3_bucket.bucket.arn}/*&quot;,
    ]
  }
}

resource &quot;aws_iam_role_policy&quot; &quot;firehose_to_s3&quot; {
  name   = &quot;default&quot;
  role   = aws_iam_role.firehose_to_s3.id
  policy = data.aws_iam_policy_document.firehose_to_s3.json
}

resource &quot;aws_kinesis_firehose_delivery_stream&quot; &quot;http_stream&quot; {
  name        = &quot;metric-stream-test-stream&quot;
  destination = &quot;http_endpoint&quot;

  http_endpoint_configuration {
    name       = &quot;test_http_endpoint&quot;
    url        = &quot;这里填入Gateway的url&quot;
    role_arn   = aws_iam_role.firehose_to_s3.arn
  }
  s3_configuration {
    role_arn   = aws_iam_role.firehose_to_s3.arn
    bucket_arn = aws_s3_bucket.bucket.arn
  }
}
</code></pre></details>
<p>使用步骤：</p>
<p>1.获取AWS账户的access_key以及secret_key。( 关于如何获取，请参考：<a href="https://aws.amazon.com/premiumsupport/knowledge-center/create-access-key/">create-access-key</a> )</p>
<p>2.将上一步中获取的access_key与secret_key填入对应位置，并将您的网关对应 url 填入 <code>aws_kinesis_firehose_delivery_stream</code> 配置的对应位置中。</p>
<p>3.复制以上内容并保存到main.tf文件中。</p>
<p>4.在对应路径下执行以下代码。</p>
<pre><code>terraform init
terraform apply
</code></pre><p>至此，需要的AWS服务已全部建立成功，您可以检查您的控制台，查看服务是否成功创建。</p>
<h3 id="完成">完成！</h3>
<p>如果以上步骤全部成功，请耐心等待约五分钟。之后您可以访问SkyWalking UI，查看指标变动情况</p>
<p>目前，SkyWalking 默认收集的指标展示如下：</p>
<p><strong>账户指标:</strong></p>
<p><img src="./service.png" alt="service.png"></p>
<p><strong>表指标：</strong></p>
<p><img src="./endpoint.png" alt="endpoint.png"></p>
<h5 id="现已支持的服务">现已支持的服务</h5>
<p>目前SkyWalking官方支持EKS，S3，DynamoDB监控。
用户也参考 <a href="https://skywalking.apache.org/docs/main/next/en/setup/backend/opentelemetry-receiver/">OpenTelemetry receiver</a> 配置OTEL rules来收集，计算AWS其他服务的CloudWatch metrics，并且通过<a href="https://skywalking.apache.org/docs/main/next/en/ui/readme/">自定义dashboard</a>展示。</p>
<h4 id="相关的资料">相关的资料</h4>
<ul>
<li><a href="https://docs.aws.amazon.com/AmazonS3/latest/userguide/cloudwatch-monitoring.html">Monitoring S3 metrics with Amazon CloudWatch</a></li>
<li><a href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/monitoring-cloudwatch.html">Monitoring DynamoDB metrics with Amazon CloudWatch</a></li>
<li><a href="https://skywalking.apache.org/docs/main/next/en/setup/backend/aws-firehose-receiver/">Supported metrics in AWS Firehose receiver of OAP</a></li>
<li><a href="https://skywalking.apache.org/docs/main/next/en/setup/backend/configuration-vocabulary/">Configuration Vocabulary | Apache SkyWalking</a></li>
</ul>

	

	<ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5">
  <li>
    <a href="/zh/2023-03-12-skywalking-aws-s3-eks/" class="btn btn-primary "><span class="mr-1">←</span> Previous</a>
  </li>
    <a href="/zh/2023-03-17-build-grafana-dashboards-for-apache-skywalking-native-promql-support/" class="btn btn-primary ">Next <span class="ml-1">→</span></a>
  </li>
</ul>

</div>


          </main>
          <div class="toc d-none d-xl-block d-md-none col-xl-2 td-toc d-print-none">
            <div class="tags-wrapper">
    <div class="font-weight-bold post-meta ">
        <i class="iconfont icon-tags pr-1" aria-hidden="true"></i>
        Tags
    </div>
    <ul class="tags-box">
        
        <li>
            <a href="/zh_tags/agent/" class="tag-link">Agent</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/zh_tags/apache-shenyu-incubating/" class="tag-link">Apache ShenYu (incubating)</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/conference/" class="tag-link">Conference</a>
            <span class="count">9</span>
        </li>
        
        <li>
            <a href="/zh_tags/course/" class="tag-link">Course</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/development/" class="tag-link">Development</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/zh_tags/dotnetcore/" class="tag-link">DotNetCore</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/ebpf/" class="tag-link">eBPF</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/elasticsearch/" class="tag-link">ElasticSearch</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/java/" class="tag-link">Java</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/zh_tags/logging/" class="tag-link">Logging</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/metrics/" class="tag-link">Metrics</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/observability/" class="tag-link">Observability</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/open-source-contribution/" class="tag-link">Open Source Contribution</a>
            <span class="count">4</span>
        </li>
        
        <li>
            <a href="/zh_tags/open-source-promotion-plan/" class="tag-link">Open Source Promotion Plan</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/zh_tags/performance/" class="tag-link">Performance</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/profiling/" class="tag-link">Profiling</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/release-blog/" class="tag-link">Release Blog</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/zh_tags/service-mesh/" class="tag-link">Service Mesh</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/shardingsphere/" class="tag-link">ShardingSphere</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/shardingsphere-proxy/" class="tag-link">ShardingSphere-proxy</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/skywalking/" class="tag-link">SkyWalking</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/source-code/" class="tag-link">Source Code</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/tracing/" class="tag-link">Tracing</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/zh_tags/use-case/" class="tag-link">Use Case</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/zh_tags/user-manual/" class="tag-link">User Manual</a>
            <span class="count">16</span>
        </li>
        
        <li>
            <a href="/zh_tags/video/" class="tag-link">Video</a>
            <span class="count">11</span>
        </li>
        
        <li>
            <a href="/zh_tags/web-ui/" class="tag-link">Web UI</a>
            <span class="count">1</span>
        </li>
        
    </ul>
</div>


            




<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">











</div>






<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#背景">背景</a></li>
        <li><a href="#什么是-amazon-cloudwatch-与-amazon-kinesis-data-firehose-">什么是 Amazon CloudWatch 与 Amazon Kinesis Data Firehose ？</a>
          <ul>
            <li></li>
          </ul>
        </li>
        <li><a href="#设置dynamodb监控">设置DynamoDB监控</a></li>
        <li><a href="#skywalking-oap-指标处理分析">SkyWalking OAP 指标处理分析</a></li>
        <li><a href="#典型指标分析">典型指标分析</a>
          <ul>
            <li><a href="#作用域">作用域</a></li>
            <li><a href="#指标">指标</a></li>
            <li><a href="#注意-1">注意</a></li>
          </ul>
        </li>
        <li><a href="#demo">Demo</a>
          <ul>
            <li><a href="#部署skywalking">部署SkyWalking</a></li>
            <li><a href="#开启对应aws服务">开启对应AWS服务</a></li>
            <li><a href="#完成">完成！</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>




<script>
  $(function () {
    var $toc = $("#TableOfContents");
    if (!$toc || !$toc.length) {
      return;
    }
    var top = $toc.offset().top;
    $(window).on("scroll", debounce(setTop, 100))
    $(window).on("scroll", debounce(addActive, 30))

    function addActive() {
      var scrollValue = $(window).scrollTop();
      var topEle = null;
      $.each($('main h1, main h2, main h3'), function (index, item) {
        if ($(item).offset().top - 70 > scrollValue) {
          return
        }
        if (!topEle) {
          topEle = item
        } else if ($(item).offset().top >= $(topEle).offset().top) {
          topEle = item
        }
        if (topEle) {
          var id = $(item).attr('id');
          $toc.find('a').removeClass("active").end().find('a[href="' + '#' + id + '"]').addClass("active")
        }
      })
    }

    function setTop() {
      var scrollValue = $(window).scrollTop();
      if (scrollValue >= top - 70) {
        $toc.addClass('fixed')
      } else {
        $toc.removeClass('fixed')
      }
    }

    function debounce(fn, wait) {
      var timeout = null;
      return function () {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          fn.apply(this, arguments);
        }, wait);
      };
    }
  })

</script>


          </div>
        </div>
      </div>
      
<footer class="py-5 sky-row">
  <div class="container-fluid text-center">
    <div class="">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-color" target="_blank" href="https://twitter.com/asfskywalking">
      <i class="iconfont icon-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-color" target="_blank" href="http://s.apache.org/slack-invite">
      <i class="iconfont icon-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Mailing list" aria-label="Mailing list">
    <a class="text-color" target="_blank" href="https://lists.apache.org/list.html?dev@skywalking.apache.org">
      <i class="iconfont icon-email"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-color" target="_blank" href="https://github.com/apache/skywalking">
      <i class="iconfont icon-github"></i>
    </a>
  </li>
  
</ul>

        
        
    </div>
    <div class="">

        <small class="text-color">&copy; 2017 - 2024 The Apache Software Foundation All Rights Reserved</small>
        
	
    </div>
    <div class="">
      <small class="text-color mt-4">Apache SkyWalking, SkyWalking, Apache, the Apache feather logo, and the Apache SkyWalking project logo are either registered trademarks or trademarks of the Apache Software Foundation.</small>
    </div>
  </div>
</footer>


    </div>
    





























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































    
<div id="popup">
    <div class="mask">
        <img src=""/>
    </div>
</div>

    <div class="sidebar-mask"></div>
<div class="sidebar">
    <nav class="nav-links">
        <div class="nav-item"><a href="/docs/" class="nav-link">Projects and Documentation</a></div>
        <div class="nav-item"><a href="/events/" class="nav-link">Events</a></div>
        <div class="nav-item"><a href="/blog/" class="nav-link router-link-exact-active router-link-active">Blog</a>
        </div>
        <div class="nav-item"><a href="/downloads/" class="nav-link">Downloads</a></div>
        <div class="nav-item"><a href="/team/" class="nav-link">Team</a></div>
        <div class="nav-item"><a href="/users/" class="nav-link">Users</a></div>
        <div class="nav-item">
            <div class="dropdown-wrapper open">
                <a class="dropdown-title"><span>中文资料</span>
                    <span class="arrow down"></span>
                </a>
                <ul class="nav-dropdown">
                    <li class="dropdown-item">
                        <a href="/zh/" class="nav-link external">博客</a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://space.bilibili.com/390683219" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">B站</a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://juejin.cn/user/13673577331607" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">掘金</a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="nav-item">
            <div class="dropdown-wrapper open">
                <a class="dropdown-title">
                    <span>Links</span>
                    <span class="arrow down"></span>
                </a>
                <ul class="nav-dropdown">
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Apache Software Foundation
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://github.com/apache/skywalking/issues"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            GitHub Issue Tracker
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://lists.apache.org/list.html?dev@skywalking.apache.org" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Dev Mailing List
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/licenses/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            License
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/events/current-event"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Apache Events
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/security/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Security
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/foundation/sponsorship.html"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Sponsorship and Donate
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/foundation/thanks.html"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Thanks
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</div>

    <script src="/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>









<script src="/js/main.min.dc00f5ca911ee5aa105ea6de6b3b7e8d8169ba5a3bf156b1fcfe23dfe3e62b0a.js" integrity="sha256-3AD1ypEe5aoQXqbeazt&#43;jYFpulo78Vax/P4j3&#43;PmKwo=" crossorigin="anonymous"></script>


<script src="/js/mermaid.min.js"></script>
<script>
    window.onload = () => mermaid.init(undefined, ".language-mermaid");
</script>


<script defer
src="https://widget.kapa.ai/kapa-widget.bundle.js"
data-website-id="8a08392b-9c4d-4816-8bc4-f93e0ecdd2a7"
data-project-name="SkyWalking"
data-project-color="#2B74B8"
data-button-text="Ask AI"
data-search-mode-enabled="true"
data-modal-open-on-command-k="true"
data-modal-disclaimer="The AI supports multiple languages, but it may not be accessible in China, a proxy is required."
data-project-logo="https://miro.medium.com/v2/resize:fit:2400/0*kmS-5BQ8ShAhZ_F4.jpg"
data-modal-example-questions="What is Apache SkyWalking?,How to deploy SkyWalking?,How to inject agents non-intrusively?,How to setup trace sampling?"
data-button-position-top=""
data-button-position-right="20px"
data-button-position-bottom="200px"
data-button-position-left=""
></script>




  </body>
</html>
