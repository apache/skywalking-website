<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="twitter:site" content="skywalking.apache.org">
<meta name="twitter:image:src" content="https://skywalking.apache.org/images/skywalking_400x400.png">
<meta property="og:image" content="https://skywalking.apache.org/images/skywalking_400x400.png">

<meta http-equiv="Content-Security-Policy" content="frame-src 'self' https://www.google.com https://app.netlify.com;">

<meta name="generator" content="Hugo 0.80.0" />


<script async src="https://www.googletagmanager.com/gtag/js?id=G-GR8N6PGRJ3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);};
  gtag('js', new Date());gtag('config', 'G-GR8N6PGRJ3');
</script>
<META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
<link rel="stylesheet" href="//at.alicdn.com/t/c/font_3007530_pvozs1rz2wn.css">



<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
<link rel="manifest" href="/favicons/site.webmanifest">
<link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<title>为 Apache SkyWalking 构建 Grafana Dashboard —— 原生 PromQL 支持 | Apache SkyWalking</title><meta property="og:title" content="为 Apache SkyWalking 构建 Grafana Dashboard —— 原生 PromQL 支持" />
<meta property="og:description" content="本文介绍什么是 SkyWalking 中的 PromQL 服务，以及如何使用它来构建 Grafana Dashboard。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/zh/2023-03-17-build-grafana-dashboards-for-apache-skywalking-native-promql-support/" />
<meta property="article:published_time" content="2023-03-16T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-02-19T22:02:37-05:00" />
<meta itemprop="name" content="为 Apache SkyWalking 构建 Grafana Dashboard —— 原生 PromQL 支持">
<meta itemprop="description" content="本文介绍什么是 SkyWalking 中的 PromQL 服务，以及如何使用它来构建 Grafana Dashboard。">
<meta itemprop="datePublished" content="2023-03-16T00:00:00+00:00" />
<meta itemprop="dateModified" content="2024-02-19T22:02:37-05:00" />
<meta itemprop="wordCount" content="727">



<meta itemprop="keywords" content="PromQL,Metric,Grafana," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="为 Apache SkyWalking 构建 Grafana Dashboard —— 原生 PromQL 支持"/>
<meta name="twitter:description" content="本文介绍什么是 SkyWalking 中的 PromQL 服务，以及如何使用它来构建 Grafana Dashboard。"/>



<link rel="preload" href="/scss/main.min.592235942cb3c9f3dd697382a4e7a1fad8e1c182dad2841bdce6b43b4a346ae8.css" as="style">
<link href="/scss/main.min.592235942cb3c9f3dd697382a4e7a1fad8e1c182dad2841bdce6b43b4a346ae8.css" rel="stylesheet" integrity="">



<link rel="stylesheet" href="/css/docSearch.css" />


<script src="/js/jquery-3.6.0.min.js"></script>





    <title>为 Apache SkyWalking 构建 Grafana Dashboard —— 原生 PromQL 支持 | Apache SkyWalking</title>
  </head>
  <body class="td-page td-blog">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand  flex-column flex-md-row td-navbar">
    <div class="sidebar-button">
      <i class="iconfont icon-menu"></i>
    </div>
    <a class="navbar-brand" href="/">
        <span class="navbar-logo"><img width="130" src="/images/logo.svg" alt="SkyWalking"></span> 
    </a>
    <div class="td-navbar-nav-scroll navbar-nav-wrapper" id="navigation">
        <ul class="navbar-nav mt-lg-0">
             
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/docs" ><span>Projects and Docs</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/events" ><span>Events</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/blog" ><span>Blogs</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/downloads" ><span>Downloads</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/team" ><span>Team</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/users" ><span>Users</span></a>
			</li>
            
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
                <span class="link dropdown blog">
                    <a class="link-name nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">中文资料</a>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="/zh/">博客</a>
                        <a class="dropdown-item" href="https://space.bilibili.com/390683219" target="_blank" rel="noopener noreferrer">
                            B站
                        </a>
                        <a class="dropdown-item" href="https://juejin.cn/user/13673577331607" target="_blank" rel="noopener noreferrer">
                            掘金
                        </a>
                    </div>
                </span>
            </li>

            
			
        </ul>
    </div>
    <div class="navbar-nav d-none d-lg-block search-input-box">
         
            
        
            
        
            
        
            
        
            
        
            
        
            
            <span class="link dropdown">
                <a class="link-name dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Links
                </a>
                <div class="dropdown-menu">
                    
                    <a class="dropdown-item" href="http://www.apache.org/">Apache Software Foundation</a> 
                    <a class="dropdown-item" href="https://github.com/apache/skywalking/issues">GitHub Issue Tracker</a> 
                    <a class="dropdown-item" href="https://github.com/apache/skywalking/discussions">Discussion</a> 
                    <a class="dropdown-item" href="https://lists.apache.org/list.html?dev@skywalking.apache.org">Dev Mailing List</a> 
                    <a class="dropdown-item" href="https://cwiki.apache.org/confluence/display/SKYWALKING/Home">WIKI</a> 
                    <a class="dropdown-item" href="http://www.apache.org/licenses/">License</a> 
                    <a class="dropdown-item" href="http://www.apache.org/events/current-event">Apache Events</a> 
                    <a class="dropdown-item" href="http://www.apache.org/security/">Security</a> 
                    <a class="dropdown-item" href="http://www.apache.org/foundation/sponsorship.html">Sponsor and Donate</a> 
                    <a class="dropdown-item" href="http://www.apache.org/foundation/thanks.html">Thanks</a> 
                    <a class="dropdown-item" href="https://apache.org/foundation/policies/privacy.html">Privacy</a> 
                </div>
            </span>
            
        
        
<div id="docsearch"></div>


    </div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row container container-center">
          <main class="col-12 col-md-12 col-xl-10 pl-md-4 pr-md-4" role="main">
            
<div class="td-content">
	<h1>为 Apache SkyWalking 构建 Grafana Dashboard —— 原生 PromQL 支持</h1>
	<div class="lead">本文介绍什么是 SkyWalking 中的 PromQL 服务，以及如何使用它来构建 Grafana Dashboard。</div>
	<div class="td-byline mb-4">
		By <b>万凯</b> |
		<time datetime="2023-03-16" class="text-muted">Thursday, March 16, 2023</time>

	    

	</div>
	<h2 id="背景">背景</h2>
<p>Apache SkyWalking 作为分布式系统的应用性能监控工具，提供了对云原生架构下的分布式系统的监控、跟踪、诊断能力。<a href="https://prometheus.io/docs/introduction/overview/#what-is-prometheus">Prometheus</a> 是一个开源系统监控和警报工具包，具有活跃的生态系统。特别是 Prometheus 指标通过 <a href="https://prometheus.io/docs/instrumenting/exporters/#exporters-and-integrations">导出器和集成</a> 得到广泛支持。 <a href="https://prometheus.io/docs/prometheus/latest/querying/basics/#querying-prometheus">PromQL</a> 作为 Prometheus 查询语言，包含一组表达式并公开 HTTP API 以读取指标。</p>
<p><a href="https://opentelemetry.io/ecosystem/integrations/">SkyWalking 支持通过 OpenTelemetry 收集器</a> 摄取 Prometheus 指标，并通过这些指标的聚合计算提供多种系统监控，例如 Linux 监控和 Kubernetes 监控。SkyWalking 已经为用户提供了 <a href="https://skywalking.apache.org/docs/main/next/en/ui/readme/">原生 UI</a> 和 <a href="https://skywalking.apache.org/docs/main/next/en/api/query-protocol/">GraphQL API</a>。但为了提供更广泛的生态整合能力，从 9.4.0 开始，它提供了 PromQL 服务，已经支持 PromQL 的第三方系统或可视化平台（如 Grafana），可以通过它获取指标。SkyWalking 用户在与不同系统集成时将从中受益。</p>
<h2 id="skywalking-中的-promql-服务是什么">SkyWalking 中的 PromQL 服务是什么？</h2>
<p>PromQL 服务是 SkyWalking 原生 GraphQL 查询之上的查询引擎，具有由 Prometheus 表达式提供支持的附加查询阶段计算能力。它可以接受 PromQL HTTP API 请求，解析 Prometheus 表达式，并在 Prometheus 指标和 SkyWalking 指标之间进行转换。</p>
<p><img src="img_1.png#pic_left" alt=""></p>
<p>PromQL 服务遵循 PromQL 的所有协议和语法，用户可以像使用 PromQL 一样使用它。由于 SkyWalking 在度量分类、格式、存储等方面与 Prometheus 有根本不同，因此 PromQL 服务不必实现完整的 PromQL 功能。<a href="https://skywalking.apache.org/docs/main/next/en/api/promql-service/#promql-service">有关详细信息</a>，请参阅文档。</p>
<h2 id="skywalking-基本概念">SkyWalking 基本概念</h2>
<p>以下是用户使用 PromQL 服务需要了解的一些基本概念和与 Prometheus 的区别： Prometheus 指标指定命名格式和结构，实际指标名称和标签由客户端提供商确定，并存储详细信息。用户使用 PromQL 中的表达式聚合和计算指标。与 Prometheus 不同，SkyWalking 的度量机制是围绕以下具有层次结构的核心概念构建的：</p>
<ul>
<li>
<p>层（Layer）：表示计算机科学中的一个抽象框架，如 Operating System（OS_LINUX 层）、Kubernetes（k8s 层）。该层将是从不同技术检测到的不同服务的所有者。<a href="https://github.com/apache/skywalking/blob/master/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/analysis/Layer.java">可以在此处</a></p>
<p>找到所有层定义。</p>
</li>
<li>
<p>服务：表示一组 / 一组工作负载，它为传入请求提供相同的行为。</p>
</li>
<li>
<p>服务实例：服务组中的单个工作负载。</p>
</li>
<li>
<p>端点：传入请求的服务路径。</p>
</li>
<li>
<p>进程：操作系统进程。在某些场景下，<code>service instance</code> 不是一个进程，比如一个 Kubernetes Pod 可能包含多个进程。</p>
</li>
</ul>
<p>Metric 名称和属性（标签）由 SkyWalking OAP 服务器根据数据源以及 OAL 和 MAL 配置。SkyWalking 提供了对时间序列指标进行下采样（down-sampling），并生成不同时间段数据（分钟、小时、天）的能力。</p>
<p>SkyWalking 指标流如下：</p>
<p><img src="img_3.png#pic_left" alt=""></p>
<h3 id="流量">流量</h3>
<ul>
<li>Service/ServiceRelation/Instance/ServiceInstanceRelation/Endpoint/EndpointRelation/Process/ProcessRelation 的元数据。包括名称、层、属性、它们之间的关系等。</li>
</ul>
<h3 id="指标">指标</h3>
<ul>
<li>名称（Name）：指标名称，来自 OAL 和 MAL 的配置。</li>
<li>实体（Entity）：表示指标的归属，用于查询。一个 Entity 根据 <code>Scope</code> 不同会包含如下信息： Scope 代表指标级别，在查询阶段代表 Scope catalog，Scope catalog 为所有的 scope 提供了高维的分类，层次结构。</li>
</ul>
<table>
<thead>
<tr>
<th>Scope</th>
<th>实体信息</th>
</tr>
</thead>
<tbody>
<tr>
<td>Service</td>
<td>服务（包括图层信息）</td>
</tr>
<tr>
<td>ServiceInstance</td>
<td>服务、服务实例</td>
</tr>
<tr>
<td>Endpoint</td>
<td>服务、端点</td>
</tr>
<tr>
<td>ServiceRelation</td>
<td>服务，目标服务</td>
</tr>
<tr>
<td>ServiceInstanceRelation</td>
<td>服务实例、目标服务实例</td>
</tr>
<tr>
<td>EndpointRelation</td>
<td>端点、目标端点</td>
</tr>
<tr>
<td>Process</td>
<td>服务、服务实例、流程</td>
</tr>
<tr>
<td>ProcessRelation</td>
<td>进程、服务实例、DestProcess</td>
</tr>
</tbody>
</table>
<ul>
<li>值：</li>
</ul>
<ol>
<li>单值：long</li>
<li>标签值：文本，<code>label1,value1|label2,value2|...</code> ，例如 <code>L2 aggregation,5000 | L1 aggregation,8000</code></li>
</ol>
<ul>
<li>TimeBucket：时间精确到分钟、小时、天</li>
</ul>
<h2 id="如何使用-promql-服务">如何使用 PromQL 服务</h2>
<h3 id="设置">设置</h3>
<p>PromQL 服务在 v9.4.0 之后默认开启，不需要额外配置。例如，可以使用 OAP 环境变量配置默认端口：</p>
<pre><code>restHost: ${SW_PROMQL_REST_HOST:0.0.0.0}
restPort: ${SW_PROMQL_REST_PORT:9090}
restContextPath: ${SW_PROMQL_REST_CONTEXT_PATH:/}
restMaxThreads: ${SW_PROMQL_REST_MAX_THREADS:200}
restIdleTimeOut: ${SW_PROMQL_REST_IDLE_TIMEOUT:30000}
restAcceptQueueSize: ${SW_PROMQL_REST_QUEUE_SIZE:0}
</code></pre><h3 id="使用-prometheus-表达式">使用 Prometheus 表达式</h3>
<p>PromQL 通过 Prometheus 表达式匹配指标。这是一个典型的 Prometheus 指标。</p>
<p><img src="img_2.png#pic_left" alt=""></p>
<p>为了匹配指标，Prometheus 表达式如下：</p>
<p><img src="img_4.png#pic_left" alt=""></p>
<p>在 PromQL 服务中，这些保留的标签将被解析为度量名称和实体信息字段以及用于查询的其他标签。映射如下。</p>
<table>
<thead>
<tr>
<th>SkyWalking 概念</th>
<th>Prometheus 表达</th>
</tr>
</thead>
<tbody>
<tr>
<td>指标名称</td>
<td>指标名称</td>
</tr>
<tr>
<td>层</td>
<td>标签</td>
</tr>
<tr>
<td>服务</td>
<td>标签</td>
</tr>
<tr>
<td>服务实例</td>
<td>标签 &lt;服务实例&gt;</td>
</tr>
<tr>
<td>端点</td>
<td>标签</td>
</tr>
<tr>
<td>……</td>
<td>……</td>
</tr>
</tbody>
</table>
<p>例如，以下表达式用于匹配查询指标：service_cpm、service_instance_cpm、endpoint_cpm</p>
<pre><code>service_cpm {service='agent::songs', layer='GENERAL'}
service_instance_cpm {service='agent::songs', service_instance='agent::songs_instance_1', layer='GENERAL'}
endpoint_cpm {service='agent::songs', endpoint='GET:/songs', layer='GENERAL'}
</code></pre><h3 id="典型查询示例">典型查询示例</h3>
<p>在这里，我们将 <a href="https://skywalking.apache.org/docs/skywalking-showcase/next/readme/">SkyWalking Showcase</a> 部署作为 Playground 来演示如何使用 PromQL 获取 SkyWalking 指标。</p>
<p><img src="img_5.png" alt=""></p>
<p>以下示例可用于通过 PromQL 服务查询服务的元数据和指标。</p>
<h3 id="获取指标名称">获取指标名称</h3>
<p>查询：</p>
<pre><code>http://localhost:9099/api/v1/label/__name__/values
</code></pre><p>结果：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#000080">&#34;status&#34;</span>: <span style="color:#d14">&#34;success&#34;</span>,
    <span style="color:#000080">&#34;data&#34;</span>: [
        <span style="color:#d14">&#34;meter_mysql_instance_qps&#34;</span>,
        <span style="color:#d14">&#34;service_cpm&#34;</span>,
        <span style="color:#d14">&#34;envoy_cluster_up_rq_active&#34;</span>,
        <span style="color:#d14">&#34;instance_jvm_class_loaded_class_count&#34;</span>,
        <span style="color:#d14">&#34;k8s_cluster_memory_requests&#34;</span>,
        <span style="color:#d14">&#34;meter_vm_memory_used&#34;</span>,
        <span style="color:#d14">&#34;meter_apisix_sv_bandwidth_unmatched&#34;</span>,
        <span style="color:#d14">&#34;meter_vm_memory_total&#34;</span>,
        <span style="color:#a61717;background-color:#e3d2d2">...</span>
    ]
}
</code></pre></div><h3 id="选择一个指标并获取标签">选择一个指标并获取标签</h3>
<p>查询：</p>
<pre><code>http://localhost:9099/api/v1/labels?match []=service_cpm
</code></pre><p>结果：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#000080">&#34;status&#34;</span>: <span style="color:#d14">&#34;success&#34;</span>,
  <span style="color:#000080">&#34;data&#34;</span>: [
    <span style="color:#d14">&#34;layer&#34;</span>,
    <span style="color:#d14">&#34;service&#34;</span>,
    <span style="color:#d14">&#34;top_n&#34;</span>,
    <span style="color:#d14">&#34;order&#34;</span>
  ]
}
</code></pre></div><h3 id="从特定层获取服务">从特定层获取服务</h3>
<p>查询：</p>
<pre><code>http://127.0.0.1:9099/api/v1/series?match []=service_traffic {layer='GENERAL'}&amp;start=1677479336&amp;end=1677479636
</code></pre><p>结果：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#000080">&#34;status&#34;</span>: <span style="color:#d14">&#34;success&#34;</span>,
    <span style="color:#000080">&#34;data&#34;</span>: [
        {<span style="color:#000080">&#34;__name__&#34;</span>: <span style="color:#d14">&#34;service_traffic&#34;</span>,
            <span style="color:#000080">&#34;service&#34;</span>: <span style="color:#d14">&#34;agent::songs&#34;</span>,
            <span style="color:#000080">&#34;scope&#34;</span>: <span style="color:#d14">&#34;Service&#34;</span>,
            <span style="color:#000080">&#34;layer&#34;</span>: <span style="color:#d14">&#34;GENERAL&#34;</span>
        },
        {<span style="color:#000080">&#34;__name__&#34;</span>: <span style="color:#d14">&#34;service_traffic&#34;</span>,
            <span style="color:#000080">&#34;service&#34;</span>: <span style="color:#d14">&#34;agent::recommendation&#34;</span>,
            <span style="color:#000080">&#34;scope&#34;</span>: <span style="color:#d14">&#34;Service&#34;</span>,
            <span style="color:#000080">&#34;layer&#34;</span>: <span style="color:#d14">&#34;GENERAL&#34;</span>
        },
        {<span style="color:#000080">&#34;__name__&#34;</span>: <span style="color:#d14">&#34;service_traffic&#34;</span>,
            <span style="color:#000080">&#34;service&#34;</span>: <span style="color:#d14">&#34;agent::app&#34;</span>,
            <span style="color:#000080">&#34;scope&#34;</span>: <span style="color:#d14">&#34;Service&#34;</span>,
            <span style="color:#000080">&#34;layer&#34;</span>: <span style="color:#d14">&#34;GENERAL&#34;</span>
        },
        {<span style="color:#000080">&#34;__name__&#34;</span>: <span style="color:#d14">&#34;service_traffic&#34;</span>,
            <span style="color:#000080">&#34;service&#34;</span>: <span style="color:#d14">&#34;agent::gateway&#34;</span>,
            <span style="color:#000080">&#34;scope&#34;</span>: <span style="color:#d14">&#34;Service&#34;</span>,
            <span style="color:#000080">&#34;layer&#34;</span>: <span style="color:#d14">&#34;GENERAL&#34;</span>
        },
        {<span style="color:#000080">&#34;__name__&#34;</span>: <span style="color:#d14">&#34;service_traffic&#34;</span>,
            <span style="color:#000080">&#34;service&#34;</span>: <span style="color:#d14">&#34;agent::frontend&#34;</span>,
            <span style="color:#000080">&#34;scope&#34;</span>: <span style="color:#d14">&#34;Service&#34;</span>,
            <span style="color:#000080">&#34;layer&#34;</span>: <span style="color:#d14">&#34;GENERAL&#34;</span>
        }
    ]
}
</code></pre></div><h3 id="查询服务的特定指标">查询服务的特定指标</h3>
<p>查询：</p>
<pre><code>http://127.0.0.1:9099/api/v1/query?query=service_cpm {service='agent::songs', layer='GENERAL'}
</code></pre><p>结果：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#000080">&#34;status&#34;</span>: <span style="color:#d14">&#34;success&#34;</span>,
  <span style="color:#000080">&#34;data&#34;</span>: {
    <span style="color:#000080">&#34;resultType&#34;</span>: <span style="color:#d14">&#34;vector&#34;</span>,
    <span style="color:#000080">&#34;result&#34;</span>: [
      {<span style="color:#000080">&#34;metric&#34;</span>: {
          <span style="color:#000080">&#34;__name__&#34;</span>: <span style="color:#d14">&#34;service_cpm&#34;</span>,
          <span style="color:#000080">&#34;layer&#34;</span>: <span style="color:#d14">&#34;GENERAL&#34;</span>,
          <span style="color:#000080">&#34;scope&#34;</span>: <span style="color:#d14">&#34;Service&#34;</span>,
          <span style="color:#000080">&#34;service&#34;</span>: <span style="color:#d14">&#34;agent::songs&#34;</span>
        },<span style="color:#000080">&#34;value&#34;</span>: [
          <span style="color:#099">1679559960</span>,
          <span style="color:#d14">&#34;6&#34;</span>
        ]
      }
    ]
  }
}
</code></pre></div><p>关于<code>range query</code>和不同的<code>metrics type for query</code> 可以参考 <a href="https://skywalking.apache.org/docs/main/next/en/api/promql-service">这里的</a> 文档。</p>
<h2 id="构建-grafana-dashboard">构建 Grafana Dashboard</h2>
<p>从上面我们知道了 PromQL 服务的机制和查询方式，现在我们可以为上面的服务示例构建 Grafana Dashboard。<strong>注</strong>：以下所有配置均基于 Grafana 9.1.0 版本。</p>
<p>SkyWalking Showcase 提供了 <code>General Service</code> 和 <code>Service Mesh</code> 层等 Dashboard 文件，我们可以通过导入 Dashboard JSON 文件快速为层服务创建 Dashboard。</p>
<p>部署 Grafana 应用程序后，请按照以下步骤操作：</p>
<h3 id="配置数据源">配置数据源</h3>
<p>首先，我们需要创建一个数据源： 在数据源配置面板中，选择 <code>Prometheus</code> 并设置 URL 为 OAP 服务器地址，默认端口为 <code>9090</code>。 <code>SkyWalking</code> 如果有多个 Prometheus 数据源，请在此处设置数据源名称。</p>
<p><img src="datasource.jpg" alt=""></p>
<h3 id="导入-dashboard-文件">导入 Dashboard 文件</h3>
<ol>
<li>
<p>创建一个名为 <code>SkyWalking</code> 的 Dashboard 文件夹。</p>
<p><img src="dashboard-folder.jpg" alt=""></p>
</li>
<li>
<p>将 Dashboard 文件导入到 Grafana 中，有两种获取文件的方式：</p>
<ol>
<li>来自 <a href="https://github.com/apache/skywalking-showcase/tree/main/deploy/platform/config/promql/dashboards">SkyWalking Showcase</a></li>
<li>转到 SkyWaking Demo：<a href="https://skywalking.apache.org/#demo">在 Grafana 上预览指标</a>，并将其从 <code>General Service</code> Dashboard 导出。</li>
</ol>
<p><img src="dashboard-import.jpg" alt=""></p>
</li>
<li>
<p>完毕！现在我们可以看到 Dashboard 正在运行，服务位于下拉列表中，指标显示在面板上。</p>
<p><img src="dashboard.jpg" alt=""></p>
</li>
</ol>
<p>这是一种简单的构建方式，但是如果我们想要自定义它，我们需要知道它是如何工作的。</p>
<h3 id="dashboard-的工作原理">Dashboard 的工作原理</h3>
<h3 id="dashboard-设置">Dashboard 设置</h3>
<p>打开 <code>Settings-Variables</code> 我们可以看到如下变量：</p>
<p><img src="dashboard-variables.jpg" alt=""></p>
<p>让我们看看每个变量的作用：</p>
<ol>
<li>
<p><strong>$DS_SkyWalking</strong></p>
<p>这是一个数据源 ty 变量，它指定了之前定义为 <code>SkyWalking</code> 的 Prometheus 数据源。</p>
<p><img src="v-DS_SkyWalking.jpg" alt=""></p>
</li>
<li>
<p><strong>$layer</strong></p>
<p>这是一个常量类型，因为在 &lsquo;General Service&rsquo; Dashboard 中，所有服务都属于 &lsquo;GENERAL&rsquo; 层，因此可以在每个查询中直接使用它们。注意，当您自定义其他层时，必须在 <code>Layer</code> 上面定义该值。</p>
<p><img src="v-layer.jpg" alt=""></p>
</li>
<li>
<p><strong>$service</strong></p>
<p>查询类型变量，为下拉列表获取该层下的所有服务名称。</p>
<p>查询表达式：</p>
<pre><code>label_values (service_traffic {layer='$layer'}, service)
</code></pre><p>查询表达式将查询 HTTP API <code>/api/v1/series</code>，以获取 <code>$layer</code> 中服务元数据，并根据标签（服务）提取服务名称。</p>
<p><img src="v-service.jpg" alt=""></p>
</li>
<li>
<p><strong>$service_instance</strong></p>
<p>与 <code>$service</code> 一样，是一个查询变量，用于在下拉列表中选择服务的所有实例。</p>
<p>查询表达式：</p>
<pre><code>label_values (instance_traffic {layer='$layer', service='$service'}, service_instance)
</code></pre><p>这里的查询表达式不仅指定了 <code>$layer</code> 还包含 <code>$service</code> 变量，用于关联下拉列表的服务。</p>
</li>
<li>
<p><strong>$endpoint</strong></p>
<p>与 <code>$service</code> 一样，是一个查询变量，用于在下拉列表中选择服务的所有端点。</p>
<p>查询表达式：</p>
<pre><code>label_values (endpoint_traffic {layer='$layer', service='$service', keyword='$endpoint_keyword', limit='$endpoint_limit'}, endpoint)
</code></pre><p>此处的查询表达式指定 <code>$layer</code> 和 <code>$service</code> 用于与下拉列表的服务相关联的。并且还接受 <code>$endpoint_keyword</code> 和 <code>$endpoint_limit</code> 变量作为过滤条件。</p>
</li>
<li>
<p><strong>$endpoint_keyword</strong></p>
<p>一个文本类型的变量，用户可以输入它来过滤 <code>$endpoint</code> 的返回值。</p>
<p><img src="v-endpoint_keyword.jpg" alt=""></p>
</li>
<li>
<p><strong>$endpoint_limit</strong></p>
<p>自定义类型，用户可以选择它以限制返回端点的最大数量。</p>
<p><img src="v-endpoint_limit.jpg" alt=""></p>
</li>
</ol>
<h3 id="dashboard-配置">Dashboard 配置</h3>
<p>这个 Dashboard 上有几个典型的指标面板，让我们看看它是如何配置的。</p>
<h3 id="普通值指标">普通值指标</h3>
<p>选择 <code>Time series chart</code> 面板 <code>Service Apdex</code> 并单击 <code>edit。</code></p>
<p><img src="panel-common-value.jpg" alt=""></p>
<ol>
<li>
<p>查询表达式</p>
<pre><code>service_apdex {service='$service', layer='$layer'} / 10000
</code></pre><p>指标范围为 <code>Service</code>，添加 <code>service</code> 和 <code>layer</code> 标签用于匹配，label 值使用上面配置的变量。该计算 <code>Divided by 10000</code> 用于匹配结果单位。查询文档可以参考 <a href="https://skywalking.apache.org/docs/main/next/en/api/promql-service/#common-value-metrics">这里</a>。</p>
</li>
<li>
<p>设置 <code>Query options --&gt; Min interval = 1m</code>，因为 SkyWalking 中的指标最小时间段是 1m。</p>
</li>
<li>
<p>设置 <code>Connect null values --&gt; AlwaysShow points --&gt; Always</code>，因为当查询间隔大于 1 小时或 1 天时，SkyWalking 返回小时 / 天步长指标值。</p>
</li>
</ol>
<h3 id="标签值指标">标签值指标</h3>
<p>选择 <code>Time series chart</code> 面板 <code>Service Response Time Percentile</code> 并单击 <code>edit</code>。</p>
<p><img src="panel-labeled-value.jpg" alt=""></p>
<ol>
<li>
<p>查询表达式</p>
<pre><code>service_percentile {service='$service', layer='$layer', labels='0,1,2,3,4', relabels='P50,P75,P90,P95,P99'}
</code></pre><p>指标范围为 <code>Service</code>，添加 <code>service</code> 和 <code>layer</code> 标签用于匹配，label 值使用上面配置的变量。添加 <code>labels='0,1,2,3,4'</code> 过滤结果标签，并添加 <code>relabels='P50,P75,P90,P95,P99'</code> 重命名结果标签。查询文档可以参考 <a href="https://skywalking.apache.org/docs/main/next/en/api/promql-service/#labeled-value-metrics">这里</a>。</p>
</li>
<li>
<p>设置 <code>Query options --&gt; Min interval = 1m</code>，因为 SkyWalking 中的指标最小时间段是 1m。</p>
</li>
<li>
<p>设置 <code>Connect null values --&gt; AlwaysShow points --&gt; Always</code>，因为当查询间隔 &gt; 1 小时或 1 天时，SkyWalking 返回小时 / 天步长指标值。</p>
</li>
<li>
<p>设置 <code>Legend</code> 为 <code>{{label}}</code> 来展示。</p>
</li>
</ol>
<h3 id="排序指标">排序指标</h3>
<p>选择 <code>Time series chart</code> 面板 <code>Service Response Time Percentile</code> 并单击 <code>edit</code>。</p>
<p><img src="panel-sort-metric.jpg" alt=""></p>
<ol>
<li>
<p>查询表达式</p>
<pre><code>service_instance_cpm {parent_service='$service', layer='$layer', top_n='10', order='DES'}
</code></pre><p>该表达式用于查询服务下的排序指标，因此添加标签 <code>parent_service</code> 和 <code>layer</code> 进行匹配。添加 <code>top_n='10'</code> 和 <code>order='DES'</code> 过滤结果。查询文档可以参考 <a href="https://skywalking.apache.org/docs/main/next/en/api/promql-service/#sort-metrics">这里</a>。</p>
</li>
<li>
<p>设置 <code>Query options --&gt; Min interval = 1m</code>，因为 SkyWalking 中的指标最小时间段是 1m。</p>
</li>
<li>
<p>设置 <code>Calculation --&gt; Latest*</code>。</p>
</li>
<li>
<p>设置 <code>Legend</code> 为 <code>{{service_instance}}</code> 来展示。</p>
</li>
</ol>
<h2 id="结论">结论</h2>
<p>在这篇文章中，我们介绍了 SkyWalking 中的 PromQL 服务是什么以及它的背景。详细介绍了 PromQL 服务的使用方法和 SkyWalking 相关的基本概念，展示了如何使用 PromQL 服务为 SkyWalking 构建 Grafana Dashboard。</p>
<p>未来，将会有更多的集成利用这个协议，比如 CI/CD、HPA（缩放）等。</p>

	

	<ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5">
  <li>
    <a href="/zh/2023-03-13-skywalking-aws-dynamodb/" class="btn btn-primary "><span class="mr-1">←</span> Previous</a>
  </li>
    <a href="/zh/2023-04-23-obs-summit-china/" class="btn btn-primary ">Next <span class="ml-1">→</span></a>
  </li>
</ul>

</div>


          </main>
          <div class="toc d-none d-xl-block d-md-none col-xl-2 td-toc d-print-none">
            <div class="tags-wrapper">
    <div class="font-weight-bold post-meta ">
        <i class="iconfont icon-tags pr-1" aria-hidden="true"></i>
        Tags
    </div>
    <ul class="tags-box">
        
        <li>
            <a href="/zh_tags/agent/" class="tag-link">Agent</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/zh_tags/apache-shenyu-incubating/" class="tag-link">Apache ShenYu (incubating)</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/conference/" class="tag-link">Conference</a>
            <span class="count">9</span>
        </li>
        
        <li>
            <a href="/zh_tags/course/" class="tag-link">Course</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/development/" class="tag-link">Development</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/zh_tags/dotnetcore/" class="tag-link">DotNetCore</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/ebpf/" class="tag-link">eBPF</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/elasticsearch/" class="tag-link">ElasticSearch</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/java/" class="tag-link">Java</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/zh_tags/logging/" class="tag-link">Logging</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/metrics/" class="tag-link">Metrics</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/observability/" class="tag-link">Observability</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/open-source-contribution/" class="tag-link">Open Source Contribution</a>
            <span class="count">4</span>
        </li>
        
        <li>
            <a href="/zh_tags/open-source-promotion-plan/" class="tag-link">Open Source Promotion Plan</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/zh_tags/performance/" class="tag-link">Performance</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/profiling/" class="tag-link">Profiling</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/release-blog/" class="tag-link">Release Blog</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/zh_tags/service-mesh/" class="tag-link">Service Mesh</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/shardingsphere/" class="tag-link">ShardingSphere</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/shardingsphere-proxy/" class="tag-link">ShardingSphere-proxy</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/skywalking/" class="tag-link">SkyWalking</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/source-code/" class="tag-link">Source Code</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/tracing/" class="tag-link">Tracing</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/zh_tags/use-case/" class="tag-link">Use Case</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/zh_tags/user-manual/" class="tag-link">User Manual</a>
            <span class="count">16</span>
        </li>
        
        <li>
            <a href="/zh_tags/video/" class="tag-link">Video</a>
            <span class="count">11</span>
        </li>
        
        <li>
            <a href="/zh_tags/web-ui/" class="tag-link">Web UI</a>
            <span class="count">1</span>
        </li>
        
    </ul>
</div>


            




<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">











</div>






<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#背景">背景</a></li>
        <li><a href="#skywalking-中的-promql-服务是什么">SkyWalking 中的 PromQL 服务是什么？</a></li>
        <li><a href="#skywalking-基本概念">SkyWalking 基本概念</a>
          <ul>
            <li><a href="#流量">流量</a></li>
            <li><a href="#指标">指标</a></li>
          </ul>
        </li>
        <li><a href="#如何使用-promql-服务">如何使用 PromQL 服务</a>
          <ul>
            <li><a href="#设置">设置</a></li>
            <li><a href="#使用-prometheus-表达式">使用 Prometheus 表达式</a></li>
            <li><a href="#典型查询示例">典型查询示例</a></li>
            <li><a href="#获取指标名称">获取指标名称</a></li>
            <li><a href="#选择一个指标并获取标签">选择一个指标并获取标签</a></li>
            <li><a href="#从特定层获取服务">从特定层获取服务</a></li>
            <li><a href="#查询服务的特定指标">查询服务的特定指标</a></li>
          </ul>
        </li>
        <li><a href="#构建-grafana-dashboard">构建 Grafana Dashboard</a>
          <ul>
            <li><a href="#配置数据源">配置数据源</a></li>
            <li><a href="#导入-dashboard-文件">导入 Dashboard 文件</a></li>
            <li><a href="#dashboard-的工作原理">Dashboard 的工作原理</a></li>
            <li><a href="#dashboard-设置">Dashboard 设置</a></li>
            <li><a href="#dashboard-配置">Dashboard 配置</a></li>
            <li><a href="#普通值指标">普通值指标</a></li>
            <li><a href="#标签值指标">标签值指标</a></li>
            <li><a href="#排序指标">排序指标</a></li>
          </ul>
        </li>
        <li><a href="#结论">结论</a></li>
      </ul>
    </li>
  </ul>
</nav>




<script>
  $(function () {
    var $toc = $("#TableOfContents");
    if (!$toc || !$toc.length) {
      return;
    }
    var top = $toc.offset().top;
    $(window).on("scroll", debounce(setTop, 100))
    $(window).on("scroll", debounce(addActive, 30))

    function addActive() {
      var scrollValue = $(window).scrollTop();
      var topEle = null;
      $.each($('main h1, main h2, main h3'), function (index, item) {
        if ($(item).offset().top - 70 > scrollValue) {
          return
        }
        if (!topEle) {
          topEle = item
        } else if ($(item).offset().top >= $(topEle).offset().top) {
          topEle = item
        }
        if (topEle) {
          var id = $(item).attr('id');
          $toc.find('a').removeClass("active").end().find('a[href="' + '#' + id + '"]').addClass("active")
        }
      })
    }

    function setTop() {
      var scrollValue = $(window).scrollTop();
      if (scrollValue >= top - 70) {
        $toc.addClass('fixed')
      } else {
        $toc.removeClass('fixed')
      }
    }

    function debounce(fn, wait) {
      var timeout = null;
      return function () {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          fn.apply(this, arguments);
        }, wait);
      };
    }
  })

</script>


          </div>
        </div>
      </div>
      
<footer class="py-5 sky-row">
  <div class="container-fluid text-center">
    <div class="">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-color" target="_blank" href="https://twitter.com/asfskywalking">
      <i class="iconfont icon-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-color" target="_blank" href="http://s.apache.org/slack-invite">
      <i class="iconfont icon-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Mailing list" aria-label="Mailing list">
    <a class="text-color" target="_blank" href="https://lists.apache.org/list.html?dev@skywalking.apache.org">
      <i class="iconfont icon-email"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-color" target="_blank" href="https://github.com/apache/skywalking">
      <i class="iconfont icon-github"></i>
    </a>
  </li>
  
</ul>

        
        
    </div>
    <div class="">

        <small class="text-color">&copy; 2017 - 2024 The Apache Software Foundation All Rights Reserved</small>
        
	
    </div>
    <div class="">
      <small class="text-color mt-4">Apache SkyWalking, SkyWalking, Apache, the Apache feather logo, and the Apache SkyWalking project logo are either registered trademarks or trademarks of the Apache Software Foundation.</small>
    </div>
  </div>
</footer>


    </div>
    





























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































    
<div id="popup">
    <div class="mask">
        <img src=""/>
    </div>
</div>

    <div class="sidebar-mask"></div>
<div class="sidebar">
    <nav class="nav-links">
        <div class="nav-item"><a href="/docs/" class="nav-link">Projects and Documentation</a></div>
        <div class="nav-item"><a href="/events/" class="nav-link">Events</a></div>
        <div class="nav-item"><a href="/blog/" class="nav-link router-link-exact-active router-link-active">Blog</a>
        </div>
        <div class="nav-item"><a href="/downloads/" class="nav-link">Downloads</a></div>
        <div class="nav-item"><a href="/team/" class="nav-link">Team</a></div>
        <div class="nav-item"><a href="/users/" class="nav-link">Users</a></div>
        <div class="nav-item">
            <div class="dropdown-wrapper open">
                <a class="dropdown-title"><span>中文资料</span>
                    <span class="arrow down"></span>
                </a>
                <ul class="nav-dropdown">
                    <li class="dropdown-item">
                        <a href="/zh/" class="nav-link external">博客</a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://space.bilibili.com/390683219" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">B站</a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://juejin.cn/user/13673577331607" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">掘金</a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="nav-item">
            <div class="dropdown-wrapper open">
                <a class="dropdown-title">
                    <span>Links</span>
                    <span class="arrow down"></span>
                </a>
                <ul class="nav-dropdown">
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Apache Software Foundation
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://github.com/apache/skywalking/issues"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            GitHub Issue Tracker
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://lists.apache.org/list.html?dev@skywalking.apache.org" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Dev Mailing List
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/licenses/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            License
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/events/current-event"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Apache Events
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/security/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Security
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/foundation/sponsorship.html"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Sponsorship and Donate
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/foundation/thanks.html"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Thanks
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</div>

    <script src="/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>









<script src="/js/main.min.dc00f5ca911ee5aa105ea6de6b3b7e8d8169ba5a3bf156b1fcfe23dfe3e62b0a.js" integrity="sha256-3AD1ypEe5aoQXqbeazt&#43;jYFpulo78Vax/P4j3&#43;PmKwo=" crossorigin="anonymous"></script>


<script src="/js/mermaid.min.js"></script>
<script>
    window.onload = () => mermaid.init(undefined, ".language-mermaid");
</script>


<script defer
src="https://widget.kapa.ai/kapa-widget.bundle.js"
data-website-id="8a08392b-9c4d-4816-8bc4-f93e0ecdd2a7"
data-project-name="SkyWalking"
data-project-color="#2B74B8"
data-button-text="Ask AI"
data-search-mode-enabled="true"
data-modal-open-on-command-k="true"
data-modal-disclaimer="The AI supports multiple languages, but it may not be accessible in China, a proxy is required."
data-project-logo="https://miro.medium.com/v2/resize:fit:2400/0*kmS-5BQ8ShAhZ_F4.jpg"
data-modal-example-questions="What is Apache SkyWalking?,How to deploy SkyWalking?,How to inject agents non-intrusively?,How to setup trace sampling?"
data-button-position-top=""
data-button-position-right="20px"
data-button-position-bottom="200px"
data-button-position-left=""
></script>




  </body>
</html>
