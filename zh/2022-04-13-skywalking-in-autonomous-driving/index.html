<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="twitter:site" content="skywalking.apache.org">
<meta name="twitter:image:src" content="https://skywalking.apache.org/images/skywalking_400x400.png">
<meta property="og:image" content="https://skywalking.apache.org/images/skywalking_400x400.png">

<meta http-equiv="Content-Security-Policy" content="frame-src 'self' https://www.google.com https://app.netlify.com;">

<meta name="generator" content="Hugo 0.80.0" />


<script async src="https://www.googletagmanager.com/gtag/js?id=G-GR8N6PGRJ3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);};
  gtag('js', new Date());gtag('config', 'G-GR8N6PGRJ3');
</script>
<META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
<link rel="stylesheet" href="//at.alicdn.com/t/c/font_3007530_pvozs1rz2wn.css">



<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
<link rel="manifest" href="/favicons/site.webmanifest">
<link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<title>SkyWalking 在无人驾驶领域的实践 | Apache SkyWalking</title><meta property="og:title" content="SkyWalking 在无人驾驶领域的实践" />
<meta property="og:description" content="本文由此前于 KubeSphere 直播上的分享整理而成，主要介绍 SkyWalking 的基本概念和使用方法，以及在无人驾驶领域的一系列实践。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/zh/2022-04-13-skywalking-in-autonomous-driving/" />
<meta property="article:published_time" content="2022-04-13T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-02-19T22:02:37-05:00" />
<meta itemprop="name" content="SkyWalking 在无人驾驶领域的实践">
<meta itemprop="description" content="本文由此前于 KubeSphere 直播上的分享整理而成，主要介绍 SkyWalking 的基本概念和使用方法，以及在无人驾驶领域的一系列实践。">
<meta itemprop="datePublished" content="2022-04-13T00:00:00+00:00" />
<meta itemprop="dateModified" content="2024-02-19T22:02:37-05:00" />
<meta itemprop="wordCount" content="967">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SkyWalking 在无人驾驶领域的实践"/>
<meta name="twitter:description" content="本文由此前于 KubeSphere 直播上的分享整理而成，主要介绍 SkyWalking 的基本概念和使用方法，以及在无人驾驶领域的一系列实践。"/>



<link rel="preload" href="/scss/main.min.592235942cb3c9f3dd697382a4e7a1fad8e1c182dad2841bdce6b43b4a346ae8.css" as="style">
<link href="/scss/main.min.592235942cb3c9f3dd697382a4e7a1fad8e1c182dad2841bdce6b43b4a346ae8.css" rel="stylesheet" integrity="">



<link rel="stylesheet" href="/css/docSearch.css" />


<script src="/js/jquery-3.6.0.min.js"></script>





    <title>SkyWalking 在无人驾驶领域的实践 | Apache SkyWalking</title>
  </head>
  <body class="td-page td-blog">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand  flex-column flex-md-row td-navbar">
    <div class="sidebar-button">
      <i class="iconfont icon-menu"></i>
    </div>
    <a class="navbar-brand" href="/">
        <span class="navbar-logo"><img width="130" src="/images/logo.svg" alt="SkyWalking"></span> 
    </a>
    <div class="td-navbar-nav-scroll navbar-nav-wrapper" id="navigation">
        <ul class="navbar-nav mt-lg-0">
             
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/docs" ><span>Projects and Docs</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/events" ><span>Events</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/blog" ><span>Blogs</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/downloads" ><span>Downloads</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/team" ><span>Team</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/users" ><span>Users</span></a>
			</li>
            
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
                <span class="link dropdown blog">
                    <a class="link-name nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">中文资料</a>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="/zh/">博客</a>
                        <a class="dropdown-item" href="https://space.bilibili.com/390683219" target="_blank" rel="noopener noreferrer">
                            B站
                        </a>
                        <a class="dropdown-item" href="https://juejin.cn/user/13673577331607" target="_blank" rel="noopener noreferrer">
                            掘金
                        </a>
                    </div>
                </span>
            </li>

            
			
        </ul>
    </div>
    <div class="navbar-nav d-none d-lg-block search-input-box">
         
            
        
            
        
            
        
            
        
            
        
            
        
            
            <span class="link dropdown">
                <a class="link-name dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Links
                </a>
                <div class="dropdown-menu">
                    
                    <a class="dropdown-item" href="http://www.apache.org/">Apache Software Foundation</a> 
                    <a class="dropdown-item" href="https://github.com/apache/skywalking/issues">GitHub Issue Tracker</a> 
                    <a class="dropdown-item" href="https://github.com/apache/skywalking/discussions">Discussion</a> 
                    <a class="dropdown-item" href="https://lists.apache.org/list.html?dev@skywalking.apache.org">Dev Mailing List</a> 
                    <a class="dropdown-item" href="https://cwiki.apache.org/confluence/display/SKYWALKING/Home">WIKI</a> 
                    <a class="dropdown-item" href="http://www.apache.org/licenses/">License</a> 
                    <a class="dropdown-item" href="http://www.apache.org/events/current-event">Apache Events</a> 
                    <a class="dropdown-item" href="http://www.apache.org/security/">Security</a> 
                    <a class="dropdown-item" href="http://www.apache.org/foundation/sponsorship.html">Sponsor and Donate</a> 
                    <a class="dropdown-item" href="http://www.apache.org/foundation/thanks.html">Thanks</a> 
                    <a class="dropdown-item" href="https://apache.org/foundation/policies/privacy.html">Privacy</a> 
                </div>
            </span>
            
        
        
<div id="docsearch"></div>


    </div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row container container-center">
          <main class="col-12 col-md-12 col-xl-10 pl-md-4 pr-md-4" role="main">
            
<div class="td-content">
	<h1>SkyWalking 在无人驾驶领域的实践</h1>
	<div class="lead">本文由此前于 KubeSphere 直播上的分享整理而成，主要介绍 SkyWalking 的基本概念和使用方法，以及在无人驾驶领域的一系列实践。</div>
	<div class="td-byline mb-4">
		By <b>李可卉</b> |
		<time datetime="2022-04-13" class="text-muted">Wednesday, April 13, 2022</time>

	    

	</div>
	<p>随着无人驾驶在行业的不断发展和技术的持续革新，规范化、常态化的真无人运营逐渐成为事实标准，而要保障各个场景下的真无人业务运作，一个迫切需要解决的现状就是业务链路长，出现问题难以定位。本文由此前于 KubeSphere 直播上的分享整理而成，主要介绍 SkyWalking 的基本概念和使用方法，以及在无人驾驶领域的一系列实践。</p>




<div class="bilibili-container"><iframe id="biliplayer" src="//player.bilibili.com/player.html?bvid=BV1qY41137ZT&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" loading="lazy"> </iframe></div>


<h2 id="行业背景">行业背景</h2>
<p>驭势科技（UISEE）是国内领先的无人驾驶公司。致力于为全行业、全场景提供 AI 驾驶服务,做赋能出行和物流新生态的 AI 驾驶员。早在三年前， 驭势科技已在机场和厂区领域实现了“去安全员” 无人驾驶常态化运营的重大突破，落地“全场景、真无人、全天候”的自动驾驶技术，并由此迈向大规模商用。要保证各个场景下没有安全员参与的业务运作，我们在链路追踪上做了一系列实践。</p>
<p>对于无人驾驶来说，从云端到车端的链路长且复杂，任何一层出问题都会导致严重的后果；然而在如下图所示的链路中，准确迅速地定位故障服务并不容易，经常遇到多个服务层层排查的情况。我们希望做到的事情，就是在出现问题以后，能够尽快定位到源头，从而快速解决问题，以绝后患。</p>
<p><img src="./uisee-arch.png" alt="image.png"></p>
<h2 id="前提条件">前提条件</h2>
<h3 id="skywalking-简介">SkyWalking 简介</h3>
<p><img src="./skywalking-arch.png" alt="image.png"></p>
<p><a href="https://skywalking.apache.org/">Apache SkyWalking</a> 是一个开源的可观察性平台，用于收集、分析、聚集和可视化来自服务和云原生基础设施的数据。SkyWalking 通过简单的方法，提拱了分布式系统的清晰视图，甚至跨云。它是一个现代的 APM（Application Performence Management），专门为云原生、基于容器的分布式系统设计。它在逻辑上被分成四个部分。探针、平台后端、存储和用户界面。</p>
<ul>
<li><strong>探针</strong>收集数据并根据 SkyWalking 的要求重新格式化（不同的探针支持不同的来源）。</li>
<li><strong>平台后端</strong>支持数据聚合、分析以及从探针接收数据流的过程，包括 Tracing、Logging、Metrics。</li>
<li><strong>存储系统</strong>通过一个开放/可插拔接口容纳 SkyWalking 数据。用户可以选择一个现有的实现，如 ElasticSearch、H2、MySQL、TiDB、InfluxDB，或实现自定义的存储。</li>
<li><strong>UI</strong>是一个高度可定制的基于网络的界面，允许 SkyWalking 终端用户可视化和管理 SkyWalking 数据。</li>
</ul>
<p>综合考虑了对各语言、各框架的支持性、可观测性的全面性以及社区环境等因素，我们选择了 SkyWalking 进行链路追踪。</p>
<h3 id="链路追踪简介">链路追踪简介</h3>
<p>关于链路追踪的基本概念，可以参看吴晟老师翻译的 <a href="https://link.segmentfault.com/?enc=q1lzCJRhfh95RIedPCDqGw%3D%3D.b%2BljJx4TgV4x%2BL8GhbAFQBIcNDkcjjdwXDSg8sC%2FVstKogfnXaU6Gi2pYyp4ib%2BOL4VKmRmMhysiLsRyw2gvFDhsryXKVeddg5djhaqM01s%3D">OpenTracing 概念和术语</a> 以及 <a href="https://opentelemetry.io/">OpenTelemetry</a>。在这里，择取几个重要的概念供大家参考：</p>
<ul>
<li><strong>Trace</strong>：代表一个潜在的分布式的存在并行数据或者并行执行轨迹的系统。一个 Trace 可以认为是多个 Span 的有向无环图（DAG）。简单来说，在微服务体系下，一个 Trace 代表从第一个服务到最后一个服务经历的一系列的服务的调用链。</li>
</ul>
<p><img src="./trace.png" alt="image.png"></p>
<ul>
<li><strong>Span</strong>：在服务中埋点时，最需要关注的内容。一个 Span 代表系统中具有开始时间和执行时长的逻辑运行单元。举例来说，在一个服务发出请求时，可以认为是一个 Span 的开始；在这个服务接收到上游服务的返回值时，可以认为是这个 Span 的结束。Span 之间通过嵌套或者顺序排列建立逻辑因果关系。在 SkyWalking 中，Span 被区分为：
<ul>
<li>LocalSpan：服务内部调用方法时创建的 Span 类型</li>
<li>EntrySpan：请求进入服务时会创建的 Span 类型（例如处理其他服务对于本服务接口的调用）</li>
<li>ExitSpan：请求离开服务时会创建的 Span 类型（例如调用其他服务的接口）</li>
</ul>
</li>
<li><strong>TraceSegment</strong>：SkyWalking 中的概念，介于 Trace 和 Span 之间，是一条 Trace 的一段，可以包含多个 Span。一个 TraceSegment 记录了一个线程中的执行过程，一个 Trace 由一个或多个 TraceSegment 组成，一个 TraceSegment 又由一个或多个 Span 组成。</li>
<li><strong>SpanContext</strong>：代表跨越进程上下文，传递到下级 Span 的状态。一般包含 Trace ID、Span ID 等信息。</li>
<li><strong>Baggage</strong>：存储在 SpanContext 中的一个键值对集合。它会在一条追踪链路上的所有 Span 内全局传输，包含这些 Span 对应的 SpanContext。Baggage 会随着 Trace 一同传播。
<ul>
<li>SkyWalking 中，上下文数据通过名为 <code>sw8</code> 的头部项进行传递，值中包含 8 个字段，由 <code>-</code> 进行分割（包括 Trace ID，Parent Span ID 等等）</li>
<li>另外 SkyWalking 中还提供名为 <code>sw8-correlation</code> 的扩展头部项，可以传递一些自定义的信息</li>
</ul>
</li>
</ul>
<h2 id="快速上手">快速上手</h2>
<p>以 Go 为例，介绍如何使用 SkyWalking 在服务中埋点。</p>
<h3 id="部署">部署</h3>
<p>我们选择使用 Helm Chart 在 Kubernetes 中进行部署。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#0086b3">export</span> <span style="color:#008080">SKYWALKING_RELEASE_NAME</span><span style="color:#000;font-weight:bold">=</span>skywalking  <span style="color:#998;font-style:italic"># change the release name according to your scenario</span>
<span style="color:#0086b3">export</span> <span style="color:#008080">SKYWALKING_RELEASE_NAMESPACE</span><span style="color:#000;font-weight:bold">=</span>default  <span style="color:#998;font-style:italic"># change the namespace to where you want to install SkyWalking</span>
<span style="color:#0086b3">export</span> <span style="color:#008080">REPO</span><span style="color:#000;font-weight:bold">=</span>skywalking

helm repo add <span style="color:#d14">${</span><span style="color:#008080">REPO</span><span style="color:#d14">}</span> https://apache.jfrog.io/artifactory/skywalking-helm                                
helm install <span style="color:#d14">&#34;</span><span style="color:#d14">${</span><span style="color:#008080">SKYWALKING_RELEASE_NAME</span><span style="color:#d14">}</span><span style="color:#d14">&#34;</span> <span style="color:#d14">${</span><span style="color:#008080">REPO</span><span style="color:#d14">}</span>/skywalking -n <span style="color:#d14">&#34;</span><span style="color:#d14">${</span><span style="color:#008080">SKYWALKING_RELEASE_NAMESPACE</span><span style="color:#d14">}</span><span style="color:#d14">&#34;</span> <span style="color:#d14">\
</span><span style="color:#d14"></span>  --set oap.image.tag<span style="color:#000;font-weight:bold">=</span>8.8.1 <span style="color:#d14">\
</span><span style="color:#d14"></span>  --set oap.storageType<span style="color:#000;font-weight:bold">=</span>elasticsearch <span style="color:#d14">\
</span><span style="color:#d14"></span>  --set ui.image.tag<span style="color:#000;font-weight:bold">=</span>8.8.1 <span style="color:#d14">\
</span><span style="color:#d14"></span>  --set elasticsearch.imageTag<span style="color:#000;font-weight:bold">=</span>6.8.6
</code></pre></div><h3 id="埋点">埋点</h3>
<p>部署完以后，需要在服务中进行埋点，以生成 Span 数据：主要的方式即在服务的入口和出口创建 Span。在代码中，首先我们会创建一个 Reporter，用于向 SkyWalking 后端发送数据。接下来，我们需要创建一个名为 <code>&quot;example&quot;</code> 的 Tracer 实例。此时，我们就可以使用 Tracer 实例来创建 Span。 在 Go 中，主要利用 <code>context.Context</code> 来创建以及传递 Span。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000;font-weight:bold">import</span> <span style="color:#d14">&#34;github.com/SkyAPM/go2sky&#34;</span>
<span style="color:#998;font-style:italic">// configure to export to OAP server
</span><span style="color:#998;font-style:italic"></span>r, err <span style="color:#000;font-weight:bold">:=</span> reporter.<span style="color:#900;font-weight:bold">NewGRPCReporter</span>(<span style="color:#d14">&#34;oap-skywalking:11800&#34;</span>)
<span style="color:#000;font-weight:bold">if</span> err <span style="color:#000;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">nil</span> {
    log.<span style="color:#900;font-weight:bold">Fatalf</span>(<span style="color:#d14">&#34;new reporter error %v \n&#34;</span>, err)
}
<span style="color:#000;font-weight:bold">defer</span> r.<span style="color:#900;font-weight:bold">Close</span>()
tracer, err <span style="color:#000;font-weight:bold">:=</span> go2sky.<span style="color:#900;font-weight:bold">NewTracer</span>(<span style="color:#d14">&#34;example&#34;</span>, go2sky.<span style="color:#900;font-weight:bold">WithReporter</span>(r))
</code></pre></div><h4 id="服务内部">服务内部</h4>
<p>在下面的代码片段中，通过 <code>context.background()</code> 生成的 Context 创建了一个 Root Span，同时在创建该 Span 的时候，也会产生一个跟这 个 Span 相关联的 Context。利用这个新的 Context，就可以创建一个与 Root Span 相关联的 Child Span。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#998;font-style:italic">// create root span
</span><span style="color:#998;font-style:italic"></span>span, ctx, err <span style="color:#000;font-weight:bold">:=</span> tracer.<span style="color:#900;font-weight:bold">CreateLocalSpan</span>(context.<span style="color:#900;font-weight:bold">Background</span>())
<span style="color:#998;font-style:italic">// create sub span w/ context above
</span><span style="color:#998;font-style:italic"></span>subSpan, newCtx, err <span style="color:#000;font-weight:bold">:=</span> tracer.<span style="color:#900;font-weight:bold">CreateLocalSpan</span>(ctx)
</code></pre></div><h4 id="服务间通信">服务间通信</h4>
<p>在服务内部，我们会利用 Context 传的递来进行 Span 的创建。但是如果是服务间通信的话，这也是链路追踪最为广泛的应用场景，肯定是没有办法直接传递 Context 参数的。这种情况下，应该怎么做呢？一般来说，SkyWalking 会把 Context 中与当前 Span 相关的键值对进行编码，后续在服务通信时进行传递。例如，在 HTTP 协议中，一般利用请求头进行链路传递。再例如 gRPC 协议，一般想到的就是利用 Metadata 进行传递。</p>
<p>在服务间通信的时候，我们会利用 EntrySpan 和 ExitSpan 进行链路的串联。以 HTTP 请求为例，在创建 EntrySpan 时，会从请求头中获取到 Span 上下文信息。而在 ExitSpan 中，则在请求中注入了上下文。这里的上下文是经过了 SkyWalking 编码后的字符串，以便在服务间进行传递。除了传递 Span 信息，也可以给 Span 打上 Tag 进行标记。例如，记录 HTTP 请求的方法，URL 等等，以便于后续数据的可视化。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#998;font-style:italic">//Extract context from HTTP request header `sw8`
</span><span style="color:#998;font-style:italic"></span>span, ctx, err <span style="color:#000;font-weight:bold">:=</span> tracer.<span style="color:#900;font-weight:bold">CreateEntrySpan</span>(r.<span style="color:#900;font-weight:bold">Context</span>(), <span style="color:#d14">&#34;/api/login&#34;</span>, <span style="color:#000;font-weight:bold">func</span>(key <span style="color:#458;font-weight:bold">string</span>) (<span style="color:#458;font-weight:bold">string</span>, <span style="color:#458;font-weight:bold">error</span>) {
		<span style="color:#000;font-weight:bold">return</span> r.Header.<span style="color:#900;font-weight:bold">Get</span>(key), <span style="color:#000;font-weight:bold">nil</span>
})

<span style="color:#998;font-style:italic">// Some operation
</span><span style="color:#998;font-style:italic"></span><span style="color:#000;font-weight:bold">...</span>

<span style="color:#998;font-style:italic">// Inject context into HTTP request header `sw8`
</span><span style="color:#998;font-style:italic"></span>span, err <span style="color:#000;font-weight:bold">:=</span> tracer.<span style="color:#900;font-weight:bold">CreateExitSpan</span>(req.<span style="color:#900;font-weight:bold">Context</span>(), <span style="color:#d14">&#34;/service/validate&#34;</span>, <span style="color:#d14">&#34;tomcat-service:8080&#34;</span>, <span style="color:#000;font-weight:bold">func</span>(key, value <span style="color:#458;font-weight:bold">string</span>) <span style="color:#458;font-weight:bold">error</span> {
		req.Header.<span style="color:#900;font-weight:bold">Set</span>(key, value)
		<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>
})

<span style="color:#998;font-style:italic">// tags
</span><span style="color:#998;font-style:italic"></span>span.<span style="color:#900;font-weight:bold">Tag</span>(go2sky.TagHTTPMethod, req.Method)
span.<span style="color:#900;font-weight:bold">Tag</span>(go2sky.TagURL, req.URL.<span style="color:#900;font-weight:bold">String</span>())
</code></pre></div><p>但是，我们可能也会用到一些不那么常用的协议，比如说 MQTT 协议。在这些情况下，应该如何传递上下文呢？关于这个问题，我们在自定义插件的部分做了实践。</p>
<h4 id="ui">UI</h4>
<p>经过刚才的埋点以后，就可以在 SkyWalking 的 UI 界面看到调用链。SkyWalking 官方提供了一个 Demo 页面，有兴趣可以一探究竟：</p>
<blockquote>
<p>UI <a href="http://demo.skywalking.apache.orgUsername">http://demo.skywalking.apache.org</a><br>
Username <em>skywalking</em>   Password <em>skywalking</em></p>
</blockquote>
<p><img src="./skywalking-ui.png" alt="image.png"></p>
<h2 id="插件体系">插件体系</h2>
<p>如上述埋点的方式，其实是比较麻烦的。好在 SkyWalking 官方提供了很多插件，一般情况下，直接接入插件便能达到埋点效果。SkyWalking 官方为多种语言都是提供了丰富的插件，对一些主流框架都有插件支持。由于我们部门使用的主要是 Go 和 Python 插件，下文中便主要介绍这两种语言的插件。同时，由于我们的链路复杂，用到的协议较多，不可避免的是也需要开发一些自定义插件。下图中整理了 Go 与 Python 插件的主要思想，以及我们开发的各框架协议自定义插件的研发思路。</p>
<p><img src="./plugins.png" alt="image.png"></p>
<h3 id="官方插件">官方插件</h3>
<h4 id="go--gin-插件">Go · Gin 插件</h4>
<p>Gin 是 Go 的 Web 框架，利用其中间件，可以进行链路追踪。由于是接收请求，所以需要在中间件中，创建一个 EntrySpan，同时从请求头中获取 Span 的上下文的信息。获取到上下文信息以后，还需要再进行一步操作：把当前请求请求的上下文 <code>c.Request.Context()</code>, 设置成为刚才创建完 EntrySpan 时生成的 Context。这样一来，这个请求的 Context 就会携带有 Span 上下文信息，可以用于在后续的请求处理中进行后续传递。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">Middleware</span>(engine <span style="color:#000;font-weight:bold">*</span>gin.Engine, tracer <span style="color:#000;font-weight:bold">*</span>go2sky.Tracer) gin.HandlerFunc {
	<span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">func</span>(c <span style="color:#000;font-weight:bold">*</span>gin.Context) {
		span, ctx, err <span style="color:#000;font-weight:bold">:=</span> tracer.<span style="color:#900;font-weight:bold">CreateEntrySpan</span>(c.Request.<span style="color:#900;font-weight:bold">Context</span>(), <span style="color:#900;font-weight:bold">getOperationName</span>(c), <span style="color:#000;font-weight:bold">func</span>(key <span style="color:#458;font-weight:bold">string</span>) (<span style="color:#458;font-weight:bold">string</span>, <span style="color:#458;font-weight:bold">error</span>) {
			<span style="color:#000;font-weight:bold">return</span> c.Request.Header.<span style="color:#900;font-weight:bold">Get</span>(key), <span style="color:#000;font-weight:bold">nil</span>
		})
        <span style="color:#998;font-style:italic">// some operation
</span><span style="color:#998;font-style:italic"></span>		c.Request = c.Request.<span style="color:#900;font-weight:bold">WithContext</span>(ctx)
		c.<span style="color:#900;font-weight:bold">Next</span>()
		span.<span style="color:#900;font-weight:bold">End</span>()
	}
}
</code></pre></div><h4 id="python--requests">Python · requests</h4>
<p>Requests 插件会直接修改 Requests 库中的<code>request</code>函数，把它替换成 SkyWalking 自定义的<code>_sw_request</code>函数。在这个函数中，创建了 ExitSpan，并将 ExitSpan 上下文注入到请求头中。在服务安装该插件后，实际调用 Requests 库进行请求的时候，就会携带带有上下文的请求体进行请求。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">install</span>():
    <span style="color:#000;font-weight:bold">from</span> <span style="color:#555">requests</span> <span style="color:#000;font-weight:bold">import</span> Session
    _request <span style="color:#000;font-weight:bold">=</span> Session<span style="color:#000;font-weight:bold">.</span>request
    
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">_sw_request</span>(this: Session, method, url, other params<span style="color:#000;font-weight:bold">...</span>):
        span <span style="color:#000;font-weight:bold">=</span> get_context()<span style="color:#000;font-weight:bold">.</span>new_exit_span(op<span style="color:#000;font-weight:bold">=</span>url_param<span style="color:#000;font-weight:bold">.</span>path <span style="color:#000;font-weight:bold">or</span> <span style="color:#d14">&#39;/&#39;</span>, peer<span style="color:#000;font-weight:bold">=</span>url_param<span style="color:#000;font-weight:bold">.</span>netloc,
                                         component<span style="color:#000;font-weight:bold">=</span>Component<span style="color:#000;font-weight:bold">.</span>Requests)

        <span style="color:#000;font-weight:bold">with</span> span:
            carrier <span style="color:#000;font-weight:bold">=</span> span<span style="color:#000;font-weight:bold">.</span>inject()
            span<span style="color:#000;font-weight:bold">.</span>layer <span style="color:#000;font-weight:bold">=</span> Layer<span style="color:#000;font-weight:bold">.</span>Http

            <span style="color:#000;font-weight:bold">if</span> headers <span style="color:#000;font-weight:bold">is</span> <span style="color:#999">None</span>:
                headers <span style="color:#000;font-weight:bold">=</span> {}
            <span style="color:#000;font-weight:bold">for</span> item <span style="color:#000;font-weight:bold">in</span> carrier:
                headers[item<span style="color:#000;font-weight:bold">.</span>key] <span style="color:#000;font-weight:bold">=</span> item<span style="color:#000;font-weight:bold">.</span>val

                span<span style="color:#000;font-weight:bold">.</span>tag(TagHttpMethod(method<span style="color:#000;font-weight:bold">.</span>upper()))
                span<span style="color:#000;font-weight:bold">.</span>tag(TagHttpURL(url_param<span style="color:#000;font-weight:bold">.</span>geturl()))

                res <span style="color:#000;font-weight:bold">=</span> _request(this, method, url, , other params<span style="color:#000;font-weight:bold">...</span>n)
                <span style="color:#998;font-style:italic"># some operation</span>
                <span style="color:#000;font-weight:bold">return</span> res
                        
    Session<span style="color:#000;font-weight:bold">.</span>request <span style="color:#000;font-weight:bold">=</span> _sw_request
</code></pre></div><h3 id="自定义插件">自定义插件</h3>
<h4 id="go--gorm">Go · Gorm</h4>
<p>Gorm 框架是 Go 的 ORM 框架。我们自己在开发的时候经常用到这个框架，因此希望能对通过 Gorm 调用数据库的链路进行追踪。</p>
<p>Gorm 有自己的插件体系，会在数据库的操作前调用<code>BeforeCallback</code>函数，数据库的操作后调用<code>AfterCallback</code>函数。于是在<code>BeforeCallback</code>中，我们创建 ExitSpan，并在<code>AfterCallback</code>里结束先前在<code>BeforeCallback</code>中创建的 ExitSpan。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000;font-weight:bold">func</span> (s <span style="color:#000;font-weight:bold">*</span>SkyWalking) <span style="color:#900;font-weight:bold">BeforeCallback</span>(operation <span style="color:#458;font-weight:bold">string</span>) <span style="color:#000;font-weight:bold">func</span>(db <span style="color:#000;font-weight:bold">*</span>gorm.DB) {
    <span style="color:#998;font-style:italic">// some operation
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">func</span>(db <span style="color:#000;font-weight:bold">*</span>gorm.DB) {
        tableName <span style="color:#000;font-weight:bold">:=</span> db.Statement.Table
        operation <span style="color:#000;font-weight:bold">:=</span> fmt.<span style="color:#900;font-weight:bold">Sprintf</span>(<span style="color:#d14">&#34;%s/%s&#34;</span>, tableName, operation)
        
        span, err <span style="color:#000;font-weight:bold">:=</span> tracer.<span style="color:#900;font-weight:bold">CreateExitSpan</span>(db.Statement.Context, operation, peer, <span style="color:#000;font-weight:bold">func</span>(key, value <span style="color:#458;font-weight:bold">string</span>) <span style="color:#458;font-weight:bold">error</span> {
            <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">nil</span>
        })
        <span style="color:#998;font-style:italic">// set span from db instance&#39;s context to pass span
</span><span style="color:#998;font-style:italic"></span>        db.<span style="color:#900;font-weight:bold">Set</span>(spanKey, span)
    }
}
</code></pre></div><p>需要注意的是，因为 Gorm 的插件分为 Before 与 After 两个 Callback，所以需要在两个回调函数间传递 Span，这样我们才可以在<code>AfterCallback</code>中结束当前的 Span。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000;font-weight:bold">func</span> (s <span style="color:#000;font-weight:bold">*</span>SkyWalking) <span style="color:#900;font-weight:bold">AfterCallback</span>() <span style="color:#000;font-weight:bold">func</span>(db <span style="color:#000;font-weight:bold">*</span>gorm.DB) {
    <span style="color:#998;font-style:italic">// some operation
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">func</span>(db <span style="color:#000;font-weight:bold">*</span>gorm.DB) {
        <span style="color:#998;font-style:italic">// get span from db instance&#39;s context
</span><span style="color:#998;font-style:italic"></span>        spanInterface, _ <span style="color:#000;font-weight:bold">:=</span> db.<span style="color:#900;font-weight:bold">Get</span>(spanKey)
        span, ok <span style="color:#000;font-weight:bold">:=</span> spanInterface.(go2sky.Span)
        <span style="color:#000;font-weight:bold">if</span> !ok {
            <span style="color:#000;font-weight:bold">return</span>
        }
        
        <span style="color:#000;font-weight:bold">defer</span> span.<span style="color:#900;font-weight:bold">End</span>()
        <span style="color:#998;font-style:italic">// some operation 
</span><span style="color:#998;font-style:italic"></span>    }
}
</code></pre></div><h4 id="python--mqtt">Python · MQTT</h4>
<p>在 IoT 领域，MQTT 是非常常用的协议，无人驾驶领域自然也相当依赖这个协议。</p>
<p>以 Publish 为例，根据官方插件的示例，我们直接修改 paho.mqtt 库中的<code>publish</code>函数，改为自己定义的<code>_sw_publish</code>函数。在自定义函数中，创建 ExitSpan，并将上下文注入到 MQTT 的 Payload 中。</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">install</span>():
    <span style="color:#000;font-weight:bold">from</span> <span style="color:#555">paho.mqtt.client</span> <span style="color:#000;font-weight:bold">import</span> Client
    
    _publish <span style="color:#000;font-weight:bold">=</span> Client<span style="color:#000;font-weight:bold">.</span>publish
    Client<span style="color:#000;font-weight:bold">.</span>publish <span style="color:#000;font-weight:bold">=</span> _sw_publish_func(_publish)
    
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">_sw_publish_func</span>(_publish):
        <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">_sw_publish</span>(this, topic, payload<span style="color:#000;font-weight:bold">=</span><span style="color:#999">None</span>, qos<span style="color:#000;font-weight:bold">=</span><span style="color:#099">0</span>, retain<span style="color:#000;font-weight:bold">=</span><span style="color:#999">False</span>, properties<span style="color:#000;font-weight:bold">=</span><span style="color:#999">None</span>):
            <span style="color:#998;font-style:italic"># some operation</span>
            <span style="color:#000;font-weight:bold">with</span> get_context()<span style="color:#000;font-weight:bold">.</span>new_exit_span(op<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;EMQX/Topic/&#34;</span> <span style="color:#000;font-weight:bold">+</span> topic <span style="color:#000;font-weight:bold">+</span> <span style="color:#d14">&#34;/Producer&#34;</span> <span style="color:#000;font-weight:bold">or</span> <span style="color:#d14">&#34;/&#34;</span>,
                                       peer<span style="color:#000;font-weight:bold">=</span>peer) <span style="color:#000;font-weight:bold">as</span> span:
                carrier <span style="color:#000;font-weight:bold">=</span> span<span style="color:#000;font-weight:bold">.</span>inject()
                span<span style="color:#000;font-weight:bold">.</span>layer <span style="color:#000;font-weight:bold">=</span> Layer<span style="color:#000;font-weight:bold">.</span>MQ
                span<span style="color:#000;font-weight:bold">.</span>component <span style="color:#000;font-weight:bold">=</span> Component<span style="color:#000;font-weight:bold">.</span>RabbitmqProducer
                payload <span style="color:#000;font-weight:bold">=</span> {} <span style="color:#000;font-weight:bold">if</span> payload <span style="color:#000;font-weight:bold">is</span> <span style="color:#999">None</span> <span style="color:#000;font-weight:bold">else</span> json<span style="color:#000;font-weight:bold">.</span>loads(payload)
                payload[<span style="color:#d14">&#39;headers&#39;</span>] <span style="color:#000;font-weight:bold">=</span> {}
                <span style="color:#000;font-weight:bold">for</span> item <span style="color:#000;font-weight:bold">in</span> carrier:
                    payload[<span style="color:#d14">&#39;headers&#39;</span>][item<span style="color:#000;font-weight:bold">.</span>key] <span style="color:#000;font-weight:bold">=</span> item<span style="color:#000;font-weight:bold">.</span>val
              <span style="color:#998;font-style:italic"># ...</span>
                                    
    <span style="color:#000;font-weight:bold">return</span> _sw_publish
</code></pre></div><p>可能这个方式不是特别优雅：因为我们目前使用 MQTT 3.1 版本，此时尚未引入 Properties 属性（类似于请求头）。直到 MQTT 5.0，才对此有相关支持。我们希望在升级到 MQTT 5.0 以后，能够将上下文注入到 Properties 中进行传递。</p>
<h2 id="无人驾驶领域的实践">无人驾驶领域的实践</h2>
<p>虽然这些插件基本上涵盖了所有的场景，但是链路追踪并不是只要接入插件就万事大吉。在一些复杂场景下，尤其无人驾驶领域的链路追踪，由于微服务架构中涉及的语言环境、中间件种类以及业务诉求通常都比较丰富，导致在接入全链路追踪的过程中，难免遇到各种主观和客观的坑。下面选取了几个典型例子和大家分享。</p>
<h3 id="问题一kong-网关的插件链路接入"><strong>【问题一】Kong 网关的插件链路接入</strong></h3>
<p>我们的请求在进入服务之前，都会通过 API 网关 Kong，同时我们在 Kong 中定义了一个自定义权限插件，这个插件会调用权限服务接口进行授权。如果只是单独单纯地接入 SkyWalking Kong  插件，对于权限服务的调用无法在调用链中体现。所以我们的解决思路是，直接地在权限插件里进行埋点，而不是使用官方的插件，这样就可以把对于权限服务的调用也纳入到调用链中。</p>
<p><img src="./kong.png" alt="image.png"></p>
<h3 id="问题二-context-传递">【问题二】 Context 传递</h3>
<p>我们有这样一个场景：一个服务，使用 Gin Web 框架，同时在处理 HTTP 请求时调用上游服务的 gRPC 接口。起初以为只要接入 Gin 的插件以及 gRPC 的插件，这个场景的链路就会轻松地接上。但是结果并不如预期。</p>
<p><img src="./context.png" alt="image.png"></p>
<p>最后发现，Gin 提供一个 Context<code>c</code>；同时对于某一个请求，可以通过<code>c.Request.Context()</code>获取到请求的 Context<code>reqCtx</code>，二者不一致；接入 SkyWalking 提供的 Gin 插件后，修改的是<code>reqCtx</code>，使其包含 Span 上下文信息；而现有服务，在 gRPC 调用时传入的 Context 是<code>c</code>，所以一开始 HTTP -&gt; gRPC 无法连接。最后通过一个工具函数，复制了<code>reqCtx</code>的键值对到<code>c</code>后，解决了这个问题。</p>
<h3 id="问题三官方-pythonredis-插件-pubsub-断路">【问题三】官方 Python·Redis 插件 Pub/Sub 断路</h3>
<p>由于官方提供了 Python ·Redis 插件，所以一开始认为，安装了 Redis 插件，对于一切 Redis 操作，都能互相连接。但是实际上，对于 Pub/Sub 操作，链路会断开。</p>
<p>查看代码后发现，对于所有的 Redis 操作，插件都创建一个 ExitSpan；也就是说该插件其实仅适用于 Redis 作缓存等情况；但是在我们的场景中，需要进行 Pub/Sub 操作。这导致两个操作都会创建 ExitSpan，而使链路无法相连。通过改造插件，在 Pub 时创建 ExitSpan，在 Sub 时创建 EntrySpan 后，解决该问题。</p>
<h3 id="问题四mqtt-broker-的多种-databridge-接入"><strong>【问题四】MQTT Broker 的多种 DataBridge 接入</strong></h3>
<p>一般来说，对 MQTT 的追踪链路是 Publisher -&gt; Subscriber，但是在我们的使用场景中，存在 MQTT broker 接收到消息后，通过规则引擎调用其他服务接口这种特殊场景。这便不是 Publisher -&gt; Subscriber，而是 Publisher -&gt; HTTP。</p>
<p><img src="./data-bridge.png" alt="image.png"></p>
<p>我们希望能够从 MQTT  Payload 中取出 Span 上下文，再注入到 HTTP 的请求头中。然而规则引擎调用接口时，没有办法自定义请求头，所以我们最后的做法是，约定好参数名称，将上下文放到请求体中，在服务收到请求后，从请求体中提取 Context。</p>
<h3 id="问题五tracing-与-logging-如何结合"><strong>【问题五】Tracing 与 Logging 如何结合</strong></h3>
<p>很多时候，只有 Tracing 信息，对于问题排查来说可能还是不充分的，我们非常的期望也能够把 Tracing 和 Logging 进行结合。</p>
<p><img src="./logging.png" alt="image.png"></p>
<p>如上图所示，我们会把所有服务的 Tracing 的信息发送到 SkyWalking，同时也会把这个服务产生的日志通过 Fluent Bit 以及 Fluentd 发送到 ElasticSearch。对于这种情况，我们只需要在日志中去记录 Span 的上下文，比如记录 Trace ID 或者 Span ID 等，就可以在 Kibana 里面去进行对于 Trace ID 的搜索，来快速的查看同一次调用链中的日志。</p>
<p>当然，SkyWalking 它本身也提供了自己的日志收集和分析机制，可以利用 Fluentd 或者 Fluent Bit 等向 SkyWalking 后端发送日志（我们选用了 Fluentd）。当然，像 SkyWalking 后端发送日志的时候，也要符合其<a href="https://skywalking.apache.org/docs/main/latest/en/protocols/log-data-protocol/">日志协议</a>，即可在 UI 上查看相应日志。</p>
<p>本文介绍了 SkyWalking 的使用方法、插件体系以及实践踩坑等，希望对大家有所帮助。总结一下，SkyWalking 的使用的确是有迹可循的，一般来说我们只要接入插件，基本上可以涵盖大部分的场景，达到链路追踪的目的。但是也要注意，很多时候需要具体问题具体分析，尤其是在链路复杂的情况下，很多地方还是需要根据不同场景来进行一些特殊处理。</p>
<p>最后，我们正在使用的 FaaS 平台 <a href="https://openfunction.dev">OpenFunction</a> 近期也接入了 SkyWalking 作为其 <a href="https://openfunction.dev/docs/best-practices/skywalking-solution-for-openfunction/">链路追踪的解决方案</a>：</p>
<div style='padding:0.1em; background-color:#e8f7ff; color:black; padding:1em; border: 1px solid #abd2da;' markdown="1">
<p>OpenFunction 提供了插件体系，并预先定义了 SkyWalking <code>pre</code>/<code>post</code> 插件；编写函数时，用户无需手动埋点，只需在 OpenFunction 配置文件中简单配置，即可开启 SkyWalking 插件，达到链路追踪的目的。</p>
<p><img src="./of-topology.png" alt="image.png">  <img src="./of-tracing.png" alt="image.png"></p>
</div>
<br />
<p>在感叹 OpenFunction 动作迅速的同时，也能够看到 SkyWalking 已成为链路追踪领域的首要选择之一。</p>
<h1 id="参考资料">参考资料</h1>
<ul>
<li>OpenTracing 文档：<a href="https://wu-sheng.gitbooks.io/opentracing-io/content/pages/spec.html">https://wu-sheng.gitbooks.io/opentracing-io/content/pages/spec.html</a></li>
<li>SkyWalking 文档：<a href="https://skywalking.apache.org/docs/main/latest/readme/">https://skywalking.apache.org/docs/main/latest/readme/</a></li>
<li>SkyWalking GitHub：<a href="https://github.com/apache/skywalking">https://github.com/apache/skywalking</a></li>
<li>SkyWalking go2sky GitHub：<a href="https://github.com/SkyAPM/go2sky">https://github.com/SkyAPM/go2sky</a></li>
<li>SkyWalking Python GitHub：<a href="https://github.com/apache/skywalking-python">https://github.com/apache/skywalking-python</a></li>
<li>SkyWalking Helm Chart：<a href="https://github.com/apache/skywalking-kubernetes">https://github.com/apache/skywalking-kubernetes</a></li>
<li>SkyWalking Solution for OpenFunction <a href="https://openfunction.dev/docs/best-practices/skywalking-solution-for-openfunction/">https://openfunction.dev/docs/best-practices/skywalking-solution-for-openfunction/</a></li>
</ul>

	

	<ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5">
  <li>
    <a href="/zh/2022-03-25-skywalking-source-code-analyzation/" class="btn btn-primary "><span class="mr-1">←</span> Previous</a>
  </li>
    <a href="/zh/2022-04-14-integrating-skywalking-with-source-code/" class="btn btn-primary ">Next <span class="ml-1">→</span></a>
  </li>
</ul>

</div>


          </main>
          <div class="toc d-none d-xl-block d-md-none col-xl-2 td-toc d-print-none">
            <div class="tags-wrapper">
    <div class="font-weight-bold post-meta ">
        <i class="iconfont icon-tags pr-1" aria-hidden="true"></i>
        Tags
    </div>
    <ul class="tags-box">
        
        <li>
            <a href="/zh_tags/agent/" class="tag-link">Agent</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/zh_tags/apache-shenyu-incubating/" class="tag-link">Apache ShenYu (incubating)</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/conference/" class="tag-link">Conference</a>
            <span class="count">9</span>
        </li>
        
        <li>
            <a href="/zh_tags/course/" class="tag-link">Course</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/development/" class="tag-link">Development</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/zh_tags/dotnetcore/" class="tag-link">DotNetCore</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/ebpf/" class="tag-link">eBPF</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/elasticsearch/" class="tag-link">ElasticSearch</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/java/" class="tag-link">Java</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/zh_tags/logging/" class="tag-link">Logging</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/metrics/" class="tag-link">Metrics</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/observability/" class="tag-link">Observability</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/open-source-contribution/" class="tag-link">Open Source Contribution</a>
            <span class="count">4</span>
        </li>
        
        <li>
            <a href="/zh_tags/open-source-promotion-plan/" class="tag-link">Open Source Promotion Plan</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/zh_tags/performance/" class="tag-link">Performance</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/profiling/" class="tag-link">Profiling</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/release-blog/" class="tag-link">Release Blog</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/zh_tags/service-mesh/" class="tag-link">Service Mesh</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/shardingsphere/" class="tag-link">ShardingSphere</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/shardingsphere-proxy/" class="tag-link">ShardingSphere-proxy</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/skywalking/" class="tag-link">SkyWalking</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/source-code/" class="tag-link">Source Code</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/zh_tags/tracing/" class="tag-link">Tracing</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/zh_tags/use-case/" class="tag-link">Use Case</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/zh_tags/user-manual/" class="tag-link">User Manual</a>
            <span class="count">16</span>
        </li>
        
        <li>
            <a href="/zh_tags/video/" class="tag-link">Video</a>
            <span class="count">11</span>
        </li>
        
        <li>
            <a href="/zh_tags/web-ui/" class="tag-link">Web UI</a>
            <span class="count">1</span>
        </li>
        
    </ul>
</div>


            




<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">











</div>






<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#行业背景">行业背景</a></li>
        <li><a href="#前提条件">前提条件</a>
          <ul>
            <li><a href="#skywalking-简介">SkyWalking 简介</a></li>
            <li><a href="#链路追踪简介">链路追踪简介</a></li>
          </ul>
        </li>
        <li><a href="#快速上手">快速上手</a>
          <ul>
            <li><a href="#部署">部署</a></li>
            <li><a href="#埋点">埋点</a></li>
          </ul>
        </li>
        <li><a href="#插件体系">插件体系</a>
          <ul>
            <li><a href="#官方插件">官方插件</a></li>
            <li><a href="#自定义插件">自定义插件</a></li>
          </ul>
        </li>
        <li><a href="#无人驾驶领域的实践">无人驾驶领域的实践</a>
          <ul>
            <li><a href="#问题一kong-网关的插件链路接入"><strong>【问题一】Kong 网关的插件链路接入</strong></a></li>
            <li><a href="#问题二-context-传递">【问题二】 Context 传递</a></li>
            <li><a href="#问题三官方-pythonredis-插件-pubsub-断路">【问题三】官方 Python·Redis 插件 Pub/Sub 断路</a></li>
            <li><a href="#问题四mqtt-broker-的多种-databridge-接入"><strong>【问题四】MQTT Broker 的多种 DataBridge 接入</strong></a></li>
            <li><a href="#问题五tracing-与-logging-如何结合"><strong>【问题五】Tracing 与 Logging 如何结合</strong></a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#参考资料">参考资料</a></li>
  </ul>
</nav>




<script>
  $(function () {
    var $toc = $("#TableOfContents");
    if (!$toc || !$toc.length) {
      return;
    }
    var top = $toc.offset().top;
    $(window).on("scroll", debounce(setTop, 100))
    $(window).on("scroll", debounce(addActive, 30))

    function addActive() {
      var scrollValue = $(window).scrollTop();
      var topEle = null;
      $.each($('main h1, main h2, main h3'), function (index, item) {
        if ($(item).offset().top - 70 > scrollValue) {
          return
        }
        if (!topEle) {
          topEle = item
        } else if ($(item).offset().top >= $(topEle).offset().top) {
          topEle = item
        }
        if (topEle) {
          var id = $(item).attr('id');
          $toc.find('a').removeClass("active").end().find('a[href="' + '#' + id + '"]').addClass("active")
        }
      })
    }

    function setTop() {
      var scrollValue = $(window).scrollTop();
      if (scrollValue >= top - 70) {
        $toc.addClass('fixed')
      } else {
        $toc.removeClass('fixed')
      }
    }

    function debounce(fn, wait) {
      var timeout = null;
      return function () {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          fn.apply(this, arguments);
        }, wait);
      };
    }
  })

</script>


          </div>
        </div>
      </div>
      
<footer class="py-5 sky-row">
  <div class="container-fluid text-center">
    <div class="">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-color" target="_blank" href="https://twitter.com/asfskywalking">
      <i class="iconfont icon-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-color" target="_blank" href="http://s.apache.org/slack-invite">
      <i class="iconfont icon-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Mailing list" aria-label="Mailing list">
    <a class="text-color" target="_blank" href="https://lists.apache.org/list.html?dev@skywalking.apache.org">
      <i class="iconfont icon-email"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-color" target="_blank" href="https://github.com/apache/skywalking">
      <i class="iconfont icon-github"></i>
    </a>
  </li>
  
</ul>

        
        
    </div>
    <div class="">

        <small class="text-color">&copy; 2017 - 2024 The Apache Software Foundation All Rights Reserved</small>
        
	
    </div>
    <div class="">
      <small class="text-color mt-4">Apache SkyWalking, SkyWalking, Apache, the Apache feather logo, and the Apache SkyWalking project logo are either registered trademarks or trademarks of the Apache Software Foundation.</small>
    </div>
  </div>
</footer>


    </div>
    





























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































    
<div id="popup">
    <div class="mask">
        <img src=""/>
    </div>
</div>

    <div class="sidebar-mask"></div>
<div class="sidebar">
    <nav class="nav-links">
        <div class="nav-item"><a href="/docs/" class="nav-link">Projects and Documentation</a></div>
        <div class="nav-item"><a href="/events/" class="nav-link">Events</a></div>
        <div class="nav-item"><a href="/blog/" class="nav-link router-link-exact-active router-link-active">Blog</a>
        </div>
        <div class="nav-item"><a href="/downloads/" class="nav-link">Downloads</a></div>
        <div class="nav-item"><a href="/team/" class="nav-link">Team</a></div>
        <div class="nav-item"><a href="/users/" class="nav-link">Users</a></div>
        <div class="nav-item">
            <div class="dropdown-wrapper open">
                <a class="dropdown-title"><span>中文资料</span>
                    <span class="arrow down"></span>
                </a>
                <ul class="nav-dropdown">
                    <li class="dropdown-item">
                        <a href="/zh/" class="nav-link external">博客</a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://space.bilibili.com/390683219" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">B站</a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://juejin.cn/user/13673577331607" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">掘金</a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="nav-item">
            <div class="dropdown-wrapper open">
                <a class="dropdown-title">
                    <span>Links</span>
                    <span class="arrow down"></span>
                </a>
                <ul class="nav-dropdown">
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Apache Software Foundation
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://github.com/apache/skywalking/issues"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            GitHub Issue Tracker
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://lists.apache.org/list.html?dev@skywalking.apache.org" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Dev Mailing List
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/licenses/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            License
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/events/current-event"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Apache Events
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/security/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Security
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/foundation/sponsorship.html"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Sponsorship and Donate
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/foundation/thanks.html"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Thanks
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</div>

    <script src="/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>









<script src="/js/main.min.dc00f5ca911ee5aa105ea6de6b3b7e8d8169ba5a3bf156b1fcfe23dfe3e62b0a.js" integrity="sha256-3AD1ypEe5aoQXqbeazt&#43;jYFpulo78Vax/P4j3&#43;PmKwo=" crossorigin="anonymous"></script>


<script src="/js/mermaid.min.js"></script>
<script>
    window.onload = () => mermaid.init(undefined, ".language-mermaid");
</script>


<script defer
src="https://widget.kapa.ai/kapa-widget.bundle.js"
data-website-id="8a08392b-9c4d-4816-8bc4-f93e0ecdd2a7"
data-project-name="SkyWalking"
data-project-color="#2B74B8"
data-button-text="Ask AI"
data-search-mode-enabled="true"
data-modal-open-on-command-k="true"
data-modal-disclaimer="The AI supports multiple languages, but it may not be accessible in China, a proxy is required."
data-project-logo="https://miro.medium.com/v2/resize:fit:2400/0*kmS-5BQ8ShAhZ_F4.jpg"
data-modal-example-questions="What is Apache SkyWalking?,How to deploy SkyWalking?,How to inject agents non-intrusively?,How to setup trace sampling?"
data-button-position-top=""
data-button-position-right="20px"
data-button-position-bottom="200px"
data-button-position-left=""
></script>




  </body>
</html>
