<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="twitter:site" content="skywalking.apache.org">
<meta name="twitter:image:src" content="https://skywalking.apache.org/images/skywalking_400x400.png">
<meta property="og:image" content="https://skywalking.apache.org/images/skywalking_400x400.png">

<meta http-equiv="Content-Security-Policy" content="frame-src 'self' https://www.google.com https://app.netlify.com;">

<meta name="generator" content="Hugo 0.80.0" />


<script async src="https://www.googletagmanager.com/gtag/js?id=G-GR8N6PGRJ3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);};
  gtag('js', new Date());gtag('config', 'G-GR8N6PGRJ3');
</script>
<META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
<link rel="stylesheet" href="//at.alicdn.com/t/c/font_3007530_pvozs1rz2wn.css">



<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
<link rel="manifest" href="/favicons/site.webmanifest">
<link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<title>eBPF enhanced HTTP observability - L7 metrics and tracing | Apache SkyWalking</title><meta property="og:title" content="eBPF enhanced HTTP observability - L7 metrics and tracing" />
<meta property="og:description" content="This article will show how to use Apache SkyWalking with eBPF to enhance metrics and traces in HTTP observability." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/blog/ebpf-enhanced-http-observability-l7-metrics-and-tracing/" />
<meta property="article:published_time" content="2023-01-12T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-02-19T22:02:37-05:00" />
<meta itemprop="name" content="eBPF enhanced HTTP observability - L7 metrics and tracing">
<meta itemprop="description" content="This article will show how to use Apache SkyWalking with eBPF to enhance metrics and traces in HTTP observability.">
<meta itemprop="datePublished" content="2023-01-12T00:00:00+00:00" />
<meta itemprop="dateModified" content="2024-02-19T22:02:37-05:00" />
<meta itemprop="wordCount" content="2473">



<meta itemprop="keywords" content="Trace,Metric,eBPF,HTTP," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="eBPF enhanced HTTP observability - L7 metrics and tracing"/>
<meta name="twitter:description" content="This article will show how to use Apache SkyWalking with eBPF to enhance metrics and traces in HTTP observability."/>



<link rel="preload" href="/scss/main.min.592235942cb3c9f3dd697382a4e7a1fad8e1c182dad2841bdce6b43b4a346ae8.css" as="style">
<link href="/scss/main.min.592235942cb3c9f3dd697382a4e7a1fad8e1c182dad2841bdce6b43b4a346ae8.css" rel="stylesheet" integrity="">



<link rel="stylesheet" href="/css/docSearch.css" />


<script src="/js/jquery-3.6.0.min.js"></script>





    <title>eBPF enhanced HTTP observability - L7 metrics and tracing | Apache SkyWalking</title>
  </head>
  <body class="td-page td-blog">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand  flex-column flex-md-row td-navbar">
    <div class="sidebar-button">
      <i class="iconfont icon-menu"></i>
    </div>
    <a class="navbar-brand" href="/">
        <span class="navbar-logo"><img width="130" src="/images/logo.svg" alt="SkyWalking"></span> 
    </a>
    <div class="td-navbar-nav-scroll navbar-nav-wrapper" id="navigation">
        <ul class="navbar-nav mt-lg-0">
             
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/docs" ><span>Projects and Docs</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/events" ><span>Events</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/blog" ><span>Blogs</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/downloads" ><span>Downloads</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/team" ><span>Team</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/users" ><span>Users</span></a>
			</li>
            
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
                <span class="link dropdown blog">
                    <a class="link-name nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">中文资料</a>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="/zh/">博客</a>
                        <a class="dropdown-item" href="https://space.bilibili.com/390683219" target="_blank" rel="noopener noreferrer">
                            B站
                        </a>
                        <a class="dropdown-item" href="https://juejin.cn/user/13673577331607" target="_blank" rel="noopener noreferrer">
                            掘金
                        </a>
                    </div>
                </span>
            </li>

            
			
        </ul>
    </div>
    <div class="navbar-nav d-none d-lg-block search-input-box">
         
            
        
            
        
            
        
            
        
            
        
            
        
            
            <span class="link dropdown">
                <a class="link-name dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Links
                </a>
                <div class="dropdown-menu">
                    
                    <a class="dropdown-item" href="http://www.apache.org/">Apache Software Foundation</a> 
                    <a class="dropdown-item" href="https://github.com/apache/skywalking/issues">GitHub Issue Tracker</a> 
                    <a class="dropdown-item" href="https://github.com/apache/skywalking/discussions">Discussion</a> 
                    <a class="dropdown-item" href="https://lists.apache.org/list.html?dev@skywalking.apache.org">Dev Mailing List</a> 
                    <a class="dropdown-item" href="https://cwiki.apache.org/confluence/display/SKYWALKING/Home">WIKI</a> 
                    <a class="dropdown-item" href="http://www.apache.org/licenses/">License</a> 
                    <a class="dropdown-item" href="http://www.apache.org/events/current-event">Apache Events</a> 
                    <a class="dropdown-item" href="http://www.apache.org/security/">Security</a> 
                    <a class="dropdown-item" href="http://www.apache.org/foundation/sponsorship.html">Sponsor and Donate</a> 
                    <a class="dropdown-item" href="http://www.apache.org/foundation/thanks.html">Thanks</a> 
                    <a class="dropdown-item" href="https://apache.org/foundation/policies/privacy.html">Privacy</a> 
                </div>
            </span>
            
        
        
<div id="docsearch"></div>


    </div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row container container-center">

          <main class="col-12 col-md-12 col-xl-10 pl-md-4 pr-md-4" role="main">
            
<div class="td-content">
	<h1>eBPF enhanced HTTP observability - L7 metrics and tracing</h1>
	<div class="lead">This article will show how to use Apache SkyWalking with eBPF to enhance metrics and traces in HTTP observability.</div>
	<div class="td-byline mb-4">
		By <b>Han Liu, Sheng Wu</b> |
		<time datetime="2023-01-12" class="text-muted">Thursday, January 12, 2023</time>


		
		<p class="mt-1 tags-box">
			<i class="iconfont icon-tags"></i>Tags |
			
			<span> <a href="/tags/trace">Trace</a></span>
			
			<span> <a href="/tags/metric">Metric</a></span>
			
			<span> <a href="/tags/ebpf">eBPF</a></span>
			
			<span> <a href="/tags/http">HTTP</a></span>
			
		</p>
		


	</div>
	<p><img src="banner.jpg" alt="banner"></p>
<h2 id="background">Background</h2>
<p>Apache SkyWalking is an open-source Application Performance Management system that helps users collect and aggregate logs, traces, metrics, and events for display on a UI. In the <a href="/blog/diagnose-service-mesh-network-performance-with-ebpf/">previous article</a>, we introduced how to use Apache SkyWalking Rover to analyze the network performance issue in the service mesh environment. However, in business scenarios, users often rely on mature layer 7 protocols, such as HTTP, for interactions between systems. In this article, we will discuss how to use eBPF techniques to analyze performance bottlenecks of layer 7 protocols and how to enhance the tracing system using network sampling.</p>
<p>This article will show how to use <a href="https://github.com/apache/skywalking">Apache SkyWalking</a> with <a href="https://ebpf.io/what-is-ebpf/">eBPF</a> to enhance metrics and traces in HTTP observability.</p>
<h2 id="http-protocol-analysis">HTTP Protocol Analysis</h2>
<p>HTTP is one of the most common Layer 7 protocols and is usually used to provide services to external parties and for inter-system communication. In the following sections, we will show how to identify and analyze HTTP/1.x protocols.</p>
<h3 id="protocol-identification">Protocol Identification</h3>
<p>In HTTP/1.x, the client and server communicate through a single file descriptor (FD) on each side. Figure 1 shows the process of communication involving the following steps:</p>
<ol>
<li>Connect/accept: The client establishes a connection with the HTTP server, or the server accepts a connection from the client.</li>
<li>Read/write (multiple times): The client or server reads and writes HTTPS requests and responses. A single request-response pair occurs within the same connection on each side.</li>
<li>Close: The client and server close the connection.</li>
</ol>
<p>To obtain HTTP content, it’s necessary to read it from the second step of this process. As defined in the <a href="http://rfc-editor.org/rfc/rfc2068.html">RFC</a>, the content is contained within the data of the Layer 4 protocol and can be obtained by parsing the data. The request and response pair can be correlated because they both occur within the same connection on each side.</p>
<p><img src="f1.png" alt="Figure 1: HTTP communication timeline."></p>
<p><em>Figure 1: HTTP communication timeline.</em></p>
<h3 id="http-pipeline">HTTP Pipeline</h3>
<p><a href="https://en.wikipedia.org/wiki/HTTP_pipelining">HTTP pipelining</a> is a feature of HTTP/1.1 that enables multiple HTTP requests to be sent over a single TCP connection without waiting for the corresponding responses. This feature is important because it ensures that the order of the responses on the server side matches the order of the requests.</p>
<p>Figure 2 illustrates how this works. Consider the following scenario: an HTTP client sends multiple requests to a server, and the server responds by sending the HTTP responses in the same order as the requests. This means that the first request sent by the client will receive the first response from the server, the second request will receive the second response, and so on.</p>
<p>When designing HTTP parsing, we should follow this principle by adding request data to a list and removing the first item when parsing a response. This ensures that the responses are processed in the correct order.</p>
<p><img src="f2.png" alt="Figure 2: HTTP/1.1  pipeline."></p>
<p><em>Figure 2: HTTP/1.1  pipeline.</em></p>
<h3 id="metrics">Metrics</h3>
<p>Based on the identification of the HTTP content and process topology diagram mentioned in the previous article, we can combine these two to generate process-to-process metrics data.</p>
<p>Figure 3 shows the metrics that currently support the analysis between the two processes. Based on the HTTP request and response data, we can analyze the following data:</p>
<table>
<thead>
<tr>
<th><strong>Metrics Name</strong></th>
<th><strong>Type</strong></th>
<th><strong>Unit</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>Request CPM(Call Per Minute)</td>
<td>Counter</td>
<td>count</td>
<td>The HTTP request count</td>
</tr>
<tr>
<td>Response Status CPM(Call Per Minute)</td>
<td>Counter</td>
<td>count</td>
<td>The count of per HTTP response status code</td>
</tr>
<tr>
<td>Request Package Size</td>
<td>Counter/Histogram</td>
<td>Byte</td>
<td>The request package size</td>
</tr>
<tr>
<td>Response Package Size</td>
<td>Counter/Histogram</td>
<td>Byte</td>
<td>The response package size</td>
</tr>
<tr>
<td>Client Duration</td>
<td>Counter/Histogram</td>
<td>Millisecond</td>
<td>The duration of single HTTP response on the client side</td>
</tr>
<tr>
<td>Server Duration</td>
<td>Counter/Histogram</td>
<td>Millisecond</td>
<td>The duration of single HTTP response on the server side</td>
</tr>
</tbody>
</table>
<p><img src="f3.png" alt="Figure 3: Process-to-process metrics."></p>
<p><em>Figure 3: Process-to-process metrics.</em></p>
<h2 id="http-and-trace">HTTP and Trace</h2>
<p>During the HTTP process, if we unpack the HTTP requests and responses from raw data, we can use this data to correlate with the existing tracing system.</p>
<h3 id="trace-context-identification">Trace Context Identification</h3>
<p>In order to track the flow of requests between multiple services, the trace system usually creates a trace context when a request enters a service and passes it along to other services during the request-response process. For example, when an HTTP request is sent to another server, the trace context is included in the request header.</p>
<p>Figure 4 displays the raw content of an HTTP request intercepted by Wireshark. The trace context information generated by the Zipkin Tracing system can be identified by the “X-B3” prefix in the header. By using eBPF to intercept the trace context in the HTTP header, we can connect the current request with the trace system.</p>
<p><img src="f4.png" alt="Figure 4: View of HTTP headers in Wireshark."></p>
<p><em>Figure 4: View of HTTP headers in Wireshark.</em></p>
<h3 id="trace-event">Trace Event</h3>
<p>We have added the concept of an <em>event</em> to traces. An event can be attached to a span and consists of start and end times, tags, and summaries, allowing us to attach any desired information to the Trace.</p>
<p>When performing eBPF network profiling, two events can be generated based on the request-response data. Figure 5 illustrates what happens when a service performs an HTTP request with profiling. The trace system generates <em>trace context</em> information and sends it in the request. When the service executes in the kernel, we can generate an event for the corresponding trace span by interacting with the request-response data and execution time in the kernel space.</p>
<p>Previously, we could only observe the execution status in the user space. However, by combining traces and eBPF technologies, we can now also get more information about the current trace in the kernel space, which would impact less performance for the target service if we do similar things in the tracing SDK and agent.</p>
<p><img src="f5.png" alt="Figure 5: Logical view of profiling an HTTP request and response."></p>
<p><em>Figure 5: Logical view of profiling an HTTP request and response.</em></p>
<h3 id="sampling">Sampling</h3>
<p>To ensure efficient data storage and minimize unnecessary data sampling, we use a sampling mechanism for traces in our system. This mechanism triggers sampling only when certain conditions are met. We also provide a list of the top <em>N</em> traces, which allows users to quickly access the relevant request information for a specific trace.</p>
<p>To help users easily identify and analyze relevant events, we offer three different sampling rules:</p>
<ol>
<li><strong>Slow Traces</strong>: Sampling is triggered when the response time for a request exceeds a specified threshold.</li>
<li><strong>Response Status [400, 500)</strong>: Sampling is triggered when the response status code is greater than or equal to 400 and less than 500.</li>
<li><strong>Response Status [500, 600)</strong>: Sampling is triggered when the response status code is greater than or equal to 500 and less than 600.</li>
</ol>
<p>In addition, we recognize that not all request or response raw data may be necessary for analysis. For example, users may be more interested in requesting data when trying to identify performance issues, while they may be more interested in response data when troubleshooting errors. As such, we also provide configuration options for request or response events to allow users to specify which type of data they would like to sample.</p>
<h2 id="profiling-in-a-service-mesh">Profiling in a Service Mesh</h2>
<p>The SkyWalking and SkyWalking Rover projects have already implemented the HTTP protocol <em>analyze</em> and <em>trace</em> associations. How do they perform when running in a service mesh environment?</p>
<h3 id="deployment">Deployment</h3>
<p>Figure 6 demonstrates the deployment of SkyWalking and SkyWalking Rover in a service mesh environment. SkyWalking Rover is deployed as a DaemonSet on each machine where a service is located and communicates with the SkyWalking backend cluster. It automatically recognizes the services on the machine and reports metadata information to the SkyWalking backend cluster. When a new network profiling task arises, SkyWalking Rover senses the task and analyzes the designated processes, collecting and aggregating network data before ultimately reporting it back to the SkyWalking backend service.</p>
<p><img src="f6.png" alt="Figure 6: SkyWalking rover deployment topology in a service mesh."></p>
<p><em>Figure 6: SkyWalking rover deployment topology in a service mesh.</em></p>
<h3 id="tracing-systems">Tracing Systems</h3>
<p>Starting from version 9.3.0, the SkyWalking backend fully supports all functions in the Zipkin server. Therefore, the SkyWalking backend can collect traces from both the SkyWalking and Zipkin protocols. Similarly, SkyWalking Rover can identify and analyze trace context in both the SkyWalking and Zipkin trace systems. In the following two sections, network analysis results will be displayed in the SkyWalking and Zipkin UI respectively.</p>
<h4 id="skywalking">SkyWalking</h4>
<p>When SkyWalking performs network profiling, similar to the TCP metrics in the <a href="/blog/diagnose-service-mesh-network-performance-with-ebpf/">previous article</a>, the SkyWalking UI will first display the topology between processes. When you open the dashboard of the line representing the traffic metrics between processes, you can see the metrics of HTTP traffic from the “HTTP/1.x” tab and the sampled HTTP requests with tracing in the “HTTP Requests” tab.</p>
<p>As shown in Figure 7, there are three lists in the tab, each corresponding to a condition in the event sampling rules. Each list displays the traces that meet the pre-specified conditions. When you click on an item in the trace list, you can view the complete trace.</p>
<p><img src="f7.png" alt="Figure 7: Sampled HTTP requests within tracing context."></p>
<p><em>Figure 7: Sampled HTTP requests within tracing context.</em></p>
<p>When you click on an item in the trace list, you can quickly view the specified trace. In Figure 8, we can see that in the current service-related span, there is a tag with a number indicating how many HTTP events are related to that trace span.</p>
<p>Since we are in a service mesh environment, each service involves interacting with Envoy. Therefore, the current span includes Envoy’s request and response information. Additionally, since the current service has both incoming and outgoing requests, there are events in the corresponding span.</p>
<p><img src="f8.png" alt="Figure 8: Events in the trace detail."></p>
<p><em>Figure 8: Events in the trace detail.</em></p>
<p>When the span is clicked, the details of the span will be displayed. If there are events in the current span, the relevant event information will be displayed on a time axis. As shown in Figure 9, there are a total of 6 related events in the current Span. Each event represents a data sample of an HTTP request/response. One of the events spans multiple time ranges, indicating a longer system call time. It may be due to a blocked system call, depending on the implementation details of the HTTP request in different languages. This can also help us query the possible causes of errors.</p>
<p><img src="f9.png" alt="Figure 9: Events in one trace span."></p>
<p><em>Figure 9: Events in one trace span.</em></p>
<p>Finally, we can click on a specific event to see its complete information. As shown in Figure 10, it displays the sampling information of a request, including the SkyWalking trace context protocol contained in the request header from the HTTP raw data. The raw request data allows you to quickly re-request the request to solve any issues.</p>
<p><img src="f10.png" alt="Figure 10: The detail of the event."></p>
<p><em>Figure 10: The detail of the event.</em></p>
<h4 id="zipkin">Zipkin</h4>
<p>Zipkin is one of the most widely used distributed tracing systems in the world. SkyWalking can function as an <a href="https://zipkin.io/pages/extensions_choices.html">alternative server</a> to provide advanced features for Zipkin users. Here, we use this way to bring the feature into the Zipkin ecosystem out-of-box. The new events would also be treated as a kind of Zipkin’s tags and annotations.</p>
<p>To add events to a Zipkin span, we need to do the following:</p>
<ol>
<li>Split the start and end times of each event into two annotations with a canonical name.</li>
<li>Add the sampled HTTP raw data from the event to the Zipkin span tags, using the same event name for corresponding purposes.</li>
</ol>
<p>Figures 11 and 12 show annotations and tags in the same span. In these figures, we can see that the span includes at least two events with the same event name and sequence suffix (e.g., “Start/Finished HTTP Request/Response Sampling-x” in the figure). Both events have separate timestamps to represent their relative times within the span. In the tags, the data content of the corresponding event is represented by the event name and sequence number, respectively.</p>
<p><img src="f11.png" alt="Figure 11: Event timestamp in the Zipkin span annotation."></p>
<p><em>Figure 11: Event timestamp in the Zipkin span annotation.</em></p>
<p><img src="f12.png" alt="Figure 12: Event raw data in the Zipkin span tag."></p>
<p><em>Figure 12: Event raw data in the Zipkin span tag.</em></p>
<h2 id="demo">Demo</h2>
<p>In this section, we demonstrate how to perform network profiling in a service mesh and complete metrics collection and HTTP raw data sampling. To follow along, you will need a running Kubernetes environment.</p>
<h3 id="deploy-skywalking-showcase">Deploy SkyWalking Showcase</h3>
<p>SkyWalking Showcase contains a complete set of example services and can be monitored using SkyWalking. For more information, please check the <a href="https://skywalking.apache.org/docs/skywalking-showcase/next/readme/">official documentation</a>.</p>
<p>In this demo, we only deploy service, the latest released SkyWalking OAP, and UI.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#0086b3">export</span> <span style="color:#008080">SW_OAP_IMAGE</span><span style="color:#000;font-weight:bold">=</span>apache/skywalking-oap-server:9.3.0
<span style="color:#0086b3">export</span> <span style="color:#008080">SW_UI_IMAGE</span><span style="color:#000;font-weight:bold">=</span>apache/skywalking-ui:9.3.0
<span style="color:#0086b3">export</span> <span style="color:#008080">SW_ROVER_IMAGE</span><span style="color:#000;font-weight:bold">=</span>apache/skywalking-rover:0.4.0

<span style="color:#0086b3">export</span> <span style="color:#008080">FEATURE_FLAGS</span><span style="color:#000;font-weight:bold">=</span>mesh-with-agent,single-node,elasticsearch,rover
make deploy.kubernetes
</code></pre></div><p>After deployment is complete, please run the following script to open SkyWalking UI: http://localhost:8080/.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">kubectl port-forward svc/ui 8080:8080 --namespace default
</code></pre></div><h3 id="start-network-profiling-task">Start Network Profiling Task</h3>
<p>Currently, we can select the specific instances that we wish to monitor by clicking the <strong>Data Plane</strong> item in the <strong>Service Mesh</strong> panel and the <strong>Service</strong> item in the <strong>Kubernetes</strong> panel.</p>
<p>In figure 13, we have selected an instance with a list of tasks in the network profiling tab.</p>
<p><img src="f13.png" alt="Figure 13: Network Profiling tab in the Data Plane."></p>
<p><em>Figure 13: Network Profiling tab in the Data Plane.</em></p>
<p>When we click the Start button, as shown in Figure 14, we need to specify the sampling rules for the profiling task. The sampling rules consist of one or more rules, each of which is distinguished by a different URI regular expression. When the HTTP request URI matches the regular expression, the rule is used. If the URI regular expression is empty, the default rule is used. Using multiple rules can help us make different sampling configurations for different requests.</p>
<p>Each rule has three parameters to determine if sampling is needed:</p>
<ol>
<li><strong>Minimal Request Duration (ms)</strong>: requests with a response time exceeding the specified time will be sampled.</li>
<li><strong>Sampling response status code between 400 and 499</strong>: all status codes in the range [400-499) will be sampled.</li>
<li><strong>Sampling response status code between 500 and 599</strong>: all status codes in the range [500-599) will be sampled.</li>
</ol>
<p>Once the sampling configuration is complete, we can create the task.</p>
<p><img src="f14.png" alt="Figure 14: Create network profiling task page."></p>
<p><em>Figure 14: Create network profiling task page.</em></p>
<h3 id="done">Done!</h3>
<p>After a few seconds, you will see the process topology appear on the right side of the page.</p>
<p><img src="f15.png" alt="Figure 15"></p>
<p>When you click on the line between processes, you can view the data between the two processes, which is divided into three tabs:</p>
<ol>
<li><strong>TCP</strong>: displays TCP-related metrics.</li>
<li><strong>HTTP/1.x</strong>: displays metrics in the HTTP 1 protocol.</li>
<li><strong>HTTP Requests</strong>: displays the analyzed request and saves it to a list according to the sampling rule.</li>
</ol>
<p><img src="f16.png" alt="Figure 16: TCP metrics in a network profiling task."></p>
<p><em>Figure 16: TCP metrics in a network profiling task.</em></p>
<p><img src="f17.png" alt="Figure 17: HTTP/1.x metrics in a network profiling task."></p>
<p><em>Figure 17: HTTP/1.x metrics in a network profiling task.</em></p>
<p><img src="f18.png" alt="Figure 18: HTTP sampled requests in a network profiling task."></p>
<p><em>Figure 18: HTTP sampled requests in a network profiling task.</em></p>
<h2 id="conclusion">Conclusion</h2>
<p>In this article, we detailed the overview of how to analyze the Layer 7 HTTP/1.x protocol in network analysis, and how to associate it with existing trace systems. This allows us to extend the scope of data we can observe from just user space to also include kernel-space data.</p>
<p>In the future, we will delve further into the analysis of kernel data, such as collecting information on TCP packet size, transmission frequency, network card, and help on enhancing distributed tracing from another perspective.</p>
<h2 id="additional-resources">Additional Resources</h2>
<ol>
<li><a href="https://github.com/apache/skywalking">SkyWalking Github Repo ›</a></li>
<li><a href="https://github.com/apache/skywalking-rover">SkyWalking Rover Github Repo ›</a></li>
<li><a href="https://skywalking.apache.org/docs/skywalking-rover/next/readme/">SkyWalking Rover Documentation ›</a></li>
<li><a href="https://skywalking.apache.org/blog/diagnose-service-mesh-network-performance-with-ebpf/">Diagnose Service Mesh Network Performance with eBPF blog post &gt;</a></li>
<li><a href="https://skywalking.apache.org/docs/main/next/en/concepts-and-designs/profiling/">SkyWalking Profiling Documentation &gt;</a></li>
<li><a href="https://skywalking.apache.org/docs/main/next/en/api/x-process-propagation-headers-v3/">SkyWalking Trace Context Propagation &gt;</a></li>
<li><a href="https://github.com/openzipkin/b3-propagation">Zipkin Trace Context Propagation &gt;</a></li>
<li><a href="https://www.rfc-editor.org/rfc/rfc2068.html">RFC - Hypertext Transfer Protocol – HTTP/1.1 &gt;</a></li>
</ol>

	

	<ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5">
  <li>
    <a href="/blog/2023-01-03-aliyun-copy-page/" class="btn btn-primary "><span class="mr-1">←</span> Previous</a>
  </li>
    <a href="/blog/2023-03-12-skywalking-aws-s3-eks/" class="btn btn-primary ">Next <span class="ml-1">→</span></a>
  </li>
</ul>

</div>


          </main>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">

            <div class="tags-wrapper">
    <div class="font-weight-bold post-meta ">
        <i class="iconfont icon-tags pr-1" aria-hidden="true"></i>
        Tags
    </div>
    <ul class="tags-box">
        
        <li>
            <a href="/tags/agent/" class="tag-link">Agent</a>
            <span class="count">10</span>
        </li>
        
        <li>
            <a href="/tags/apache-shenyu-incubating/" class="tag-link">Apache ShenYu (incubating)</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/apisix/" class="tag-link">APISIX</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/apm/" class="tag-link">APM</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/arthas/" class="tag-link">Arthas</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/aurora/" class="tag-link">Aurora</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/aws/" class="tag-link">AWS</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/browser/" class="tag-link">Browser</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/chaos-engineering/" class="tag-link">Chaos Engineering</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/chaos-mesh/" class="tag-link">Chaos Mesh</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/conference/" class="tag-link">Conference</a>
            <span class="count">6</span>
        </li>
        
        <li>
            <a href="/tags/database/" class="tag-link">Database</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/demo/" class="tag-link">Demo</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/tags/design/" class="tag-link">Design</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/dotnetcore/" class="tag-link">DotNetCore</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/ebpf/" class="tag-link">eBPF</a>
            <span class="count">6</span>
        </li>
        
        <li>
            <a href="/tags/golang/" class="tag-link">Golang</a>
            <span class="count">5</span>
        </li>
        
        <li>
            <a href="/tags/grafana/" class="tag-link">Grafana</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/http/" class="tag-link">HTTP</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/infrastructure-monitoring/" class="tag-link">Infrastructure Monitoring</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/iotdb/" class="tag-link">IoTDB</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/istio/" class="tag-link">Istio</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/java/" class="tag-link">Java</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/kafka/" class="tag-link">Kafka</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/kong/" class="tag-link">Kong</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/lal/" class="tag-link">LAL</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/license/" class="tag-link">License</a>
            <span class="count">5</span>
        </li>
        
        <li>
            <a href="/tags/logging/" class="tag-link">Logging</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/tags/logs/" class="tag-link">Logs</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/metric/" class="tag-link">Metric</a>
            <span class="count">6</span>
        </li>
        
        <li>
            <a href="/tags/metrics/" class="tag-link">Metrics</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/nginx/" class="tag-link">Nginx</a>
            <span class="count">5</span>
        </li>
        
        <li>
            <a href="/tags/observability/" class="tag-link">Observability</a>
            <span class="count">10</span>
        </li>
        
        <li>
            <a href="/tags/ospp/" class="tag-link">OSPP</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/performance/" class="tag-link">Performance</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/tags/profiling/" class="tag-link">Profiling</a>
            <span class="count">5</span>
        </li>
        
        <li>
            <a href="/tags/promql/" class="tag-link">PromQL</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/python/" class="tag-link">Python</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/rds/" class="tag-link">RDS</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/release-blog/" class="tag-link">Release Blog</a>
            <span class="count">4</span>
        </li>
        
        <li>
            <a href="/tags/satellite/" class="tag-link">Satellite</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/service-mesh/" class="tag-link">Service Mesh</a>
            <span class="count">6</span>
        </li>
        
        <li>
            <a href="/tags/sharding-sphere/" class="tag-link">Sharding-Sphere</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/sharding-sphere-proxy/" class="tag-link">Sharding-Sphere-proxy</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/skywalking/" class="tag-link">SkyWalking</a>
            <span class="count">5</span>
        </li>
        
        <li>
            <a href="/tags/spring/" class="tag-link">Spring</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/storage/" class="tag-link">Storage</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/testing/" class="tag-link">Testing</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/tags/trace/" class="tag-link">Trace</a>
            <span class="count">4</span>
        </li>
        
        <li>
            <a href="/tags/tracing/" class="tag-link">Tracing</a>
            <span class="count">10</span>
        </li>
        
        <li>
            <a href="/tags/tutorial/" class="tag-link">Tutorial</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/user-manual/" class="tag-link">User Manual</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/video/" class="tag-link">Video</a>
            <span class="count">8</span>
        </li>
        
        <li>
            <a href="/tags/web-performance/" class="tag-link">Web-performance</a>
            <span class="count">1</span>
        </li>
        
    </ul>
</div>



            




<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">











</div>






<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#background">Background</a></li>
        <li><a href="#http-protocol-analysis">HTTP Protocol Analysis</a>
          <ul>
            <li><a href="#protocol-identification">Protocol Identification</a></li>
            <li><a href="#http-pipeline">HTTP Pipeline</a></li>
            <li><a href="#metrics">Metrics</a></li>
          </ul>
        </li>
        <li><a href="#http-and-trace">HTTP and Trace</a>
          <ul>
            <li><a href="#trace-context-identification">Trace Context Identification</a></li>
            <li><a href="#trace-event">Trace Event</a></li>
            <li><a href="#sampling">Sampling</a></li>
          </ul>
        </li>
        <li><a href="#profiling-in-a-service-mesh">Profiling in a Service Mesh</a>
          <ul>
            <li><a href="#deployment">Deployment</a></li>
            <li><a href="#tracing-systems">Tracing Systems</a></li>
          </ul>
        </li>
        <li><a href="#demo">Demo</a>
          <ul>
            <li><a href="#deploy-skywalking-showcase">Deploy SkyWalking Showcase</a></li>
            <li><a href="#start-network-profiling-task">Start Network Profiling Task</a></li>
            <li><a href="#done">Done!</a></li>
          </ul>
        </li>
        <li><a href="#conclusion">Conclusion</a></li>
        <li><a href="#additional-resources">Additional Resources</a></li>
      </ul>
    </li>
  </ul>
</nav>




<script>
  $(function () {
    var $toc = $("#TableOfContents");
    if (!$toc || !$toc.length) {
      return;
    }
    var top = $toc.offset().top;
    $(window).on("scroll", debounce(setTop, 100))
    $(window).on("scroll", debounce(addActive, 30))

    function addActive() {
      var scrollValue = $(window).scrollTop();
      var topEle = null;
      $.each($('main h1, main h2, main h3'), function (index, item) {
        if ($(item).offset().top - 70 > scrollValue) {
          return
        }
        if (!topEle) {
          topEle = item
        } else if ($(item).offset().top >= $(topEle).offset().top) {
          topEle = item
        }
        if (topEle) {
          var id = $(item).attr('id');
          $toc.find('a').removeClass("active").end().find('a[href="' + '#' + id + '"]').addClass("active")
        }
      })
    }

    function setTop() {
      var scrollValue = $(window).scrollTop();
      if (scrollValue >= top - 70) {
        $toc.addClass('fixed')
      } else {
        $toc.removeClass('fixed')
      }
    }

    function debounce(fn, wait) {
      var timeout = null;
      return function () {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          fn.apply(this, arguments);
        }, wait);
      };
    }
  })

</script>

          </div>
        </div>
      </div>
      
<footer class="py-5 sky-row">
  <div class="container-fluid text-center">
    <div class="">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-color" target="_blank" href="https://twitter.com/asfskywalking">
      <i class="iconfont icon-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-color" target="_blank" href="http://s.apache.org/slack-invite">
      <i class="iconfont icon-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Mailing list" aria-label="Mailing list">
    <a class="text-color" target="_blank" href="https://lists.apache.org/list.html?dev@skywalking.apache.org">
      <i class="iconfont icon-email"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-color" target="_blank" href="https://github.com/apache/skywalking">
      <i class="iconfont icon-github"></i>
    </a>
  </li>
  
</ul>

        
        
    </div>
    <div class="">

        <small class="text-color">&copy; 2017 - 2024 The Apache Software Foundation All Rights Reserved</small>
        
	
    </div>
    <div class="">
      <small class="text-color mt-4">Apache SkyWalking, SkyWalking, Apache, the Apache feather logo, and the Apache SkyWalking project logo are either registered trademarks or trademarks of the Apache Software Foundation.</small>
    </div>
  </div>
</footer>


    </div>
    





























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































    
<div id="popup">
    <div class="mask">
        <img src=""/>
    </div>
</div>

    <div class="sidebar-mask"></div>
<div class="sidebar">
    <nav class="nav-links">
        <div class="nav-item"><a href="/docs/" class="nav-link">Projects and Documentation</a></div>
        <div class="nav-item"><a href="/events/" class="nav-link">Events</a></div>
        <div class="nav-item"><a href="/blog/" class="nav-link router-link-exact-active router-link-active">Blog</a>
        </div>
        <div class="nav-item"><a href="/downloads/" class="nav-link">Downloads</a></div>
        <div class="nav-item"><a href="/team/" class="nav-link">Team</a></div>
        <div class="nav-item"><a href="/users/" class="nav-link">Users</a></div>
        <div class="nav-item">
            <div class="dropdown-wrapper open">
                <a class="dropdown-title"><span>中文资料</span>
                    <span class="arrow down"></span>
                </a>
                <ul class="nav-dropdown">
                    <li class="dropdown-item">
                        <a href="/zh/" class="nav-link external">博客</a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://space.bilibili.com/390683219" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">B站</a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://juejin.cn/user/13673577331607" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">掘金</a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="nav-item">
            <div class="dropdown-wrapper open">
                <a class="dropdown-title">
                    <span>Links</span>
                    <span class="arrow down"></span>
                </a>
                <ul class="nav-dropdown">
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Apache Software Foundation
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://github.com/apache/skywalking/issues"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            GitHub Issue Tracker
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://lists.apache.org/list.html?dev@skywalking.apache.org" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Dev Mailing List
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/licenses/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            License
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/events/current-event"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Apache Events
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/security/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Security
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/foundation/sponsorship.html"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Sponsorship and Donate
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/foundation/thanks.html"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Thanks
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</div>

    <script src="/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>









<script src="/js/main.min.dc00f5ca911ee5aa105ea6de6b3b7e8d8169ba5a3bf156b1fcfe23dfe3e62b0a.js" integrity="sha256-3AD1ypEe5aoQXqbeazt&#43;jYFpulo78Vax/P4j3&#43;PmKwo=" crossorigin="anonymous"></script>


<script src="/js/mermaid.min.js"></script>
<script>
    window.onload = () => mermaid.init(undefined, ".language-mermaid");
</script>


<script defer
src="https://widget.kapa.ai/kapa-widget.bundle.js"
data-website-id="8a08392b-9c4d-4816-8bc4-f93e0ecdd2a7"
data-project-name="SkyWalking"
data-project-color="#2B74B8"
data-button-text="Ask AI"
data-search-mode-enabled="true"
data-modal-open-on-command-k="true"
data-modal-disclaimer="The AI supports multiple languages, but it may not be accessible in China, a proxy is required."
data-project-logo="https://miro.medium.com/v2/resize:fit:2400/0*kmS-5BQ8ShAhZ_F4.jpg"
data-modal-example-questions="What is Apache SkyWalking?,How to deploy SkyWalking?,How to inject agents non-intrusively?,How to setup trace sampling?"
data-button-position-top=""
data-button-position-right="20px"
data-button-position-bottom="200px"
data-button-position-left=""
></script>




  </body>
</html>
