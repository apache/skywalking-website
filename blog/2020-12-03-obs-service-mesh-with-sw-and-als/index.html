<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="twitter:site" content="skywalking.apache.org">
<meta name="twitter:image:src" content="https://skywalking.apache.org/images/skywalking_400x400.png">
<meta property="og:image" content="https://skywalking.apache.org/images/skywalking_400x400.png">

<meta http-equiv="Content-Security-Policy" content="frame-src 'self' https://www.google.com https://app.netlify.com;">

<meta name="generator" content="Hugo 0.80.0" />


<script async src="https://www.googletagmanager.com/gtag/js?id=G-GR8N6PGRJ3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);};
  gtag('js', new Date());gtag('config', 'G-GR8N6PGRJ3');
</script>
<META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
<link rel="stylesheet" href="//at.alicdn.com/t/c/font_3007530_pvozs1rz2wn.css">



<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
<link rel="manifest" href="/favicons/site.webmanifest">
<link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<title>Observe Service Mesh with SkyWalking and Envoy Access Log Service | Apache SkyWalking</title><meta property="og:title" content="Observe Service Mesh with SkyWalking and Envoy Access Log Service" />
<meta property="og:description" content="In this tutorial, learn how to use Apache SkyWalking for service mesh observability without Istio Mixer" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/blog/2020-12-03-obs-service-mesh-with-sw-and-als/" />
<meta property="article:published_time" content="2020-12-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2024-02-19T22:02:37-05:00" />
<meta itemprop="name" content="Observe Service Mesh with SkyWalking and Envoy Access Log Service">
<meta itemprop="description" content="In this tutorial, learn how to use Apache SkyWalking for service mesh observability without Istio Mixer">
<meta itemprop="datePublished" content="2020-12-03T00:00:00+00:00" />
<meta itemprop="dateModified" content="2024-02-19T22:02:37-05:00" />
<meta itemprop="wordCount" content="1703">



<meta itemprop="keywords" content="Service Mesh," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Observe Service Mesh with SkyWalking and Envoy Access Log Service"/>
<meta name="twitter:description" content="In this tutorial, learn how to use Apache SkyWalking for service mesh observability without Istio Mixer"/>



<link rel="preload" href="/scss/main.min.592235942cb3c9f3dd697382a4e7a1fad8e1c182dad2841bdce6b43b4a346ae8.css" as="style">
<link href="/scss/main.min.592235942cb3c9f3dd697382a4e7a1fad8e1c182dad2841bdce6b43b4a346ae8.css" rel="stylesheet" integrity="">



<link rel="stylesheet" href="/css/docSearch.css" />


<script src="/js/jquery-3.6.0.min.js"></script>





    <title>Observe Service Mesh with SkyWalking and Envoy Access Log Service | Apache SkyWalking</title>
  </head>
  <body class="td-page td-blog">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand  flex-column flex-md-row td-navbar">
    <div class="sidebar-button">
      <i class="iconfont icon-menu"></i>
    </div>
    <a class="navbar-brand" href="/">
        <span class="navbar-logo"><img width="130" src="/images/logo.svg" alt="SkyWalking"></span> 
    </a>
    <div class="td-navbar-nav-scroll navbar-nav-wrapper" id="navigation">
        <ul class="navbar-nav mt-lg-0">
             
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/docs" ><span>Projects and Docs</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/events" ><span>Events</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/blog" ><span>Blogs</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/downloads" ><span>Downloads</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/team" ><span>Team</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/users" ><span>Users</span></a>
			</li>
            
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
                <span class="link dropdown blog">
                    <a class="link-name nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">中文资料</a>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="/zh/">博客</a>
                        <a class="dropdown-item" href="https://space.bilibili.com/390683219" target="_blank" rel="noopener noreferrer">
                            B站
                        </a>
                        <a class="dropdown-item" href="https://juejin.cn/user/13673577331607" target="_blank" rel="noopener noreferrer">
                            掘金
                        </a>
                    </div>
                </span>
            </li>

            
			
        </ul>
    </div>
    <div class="navbar-nav d-none d-lg-block search-input-box">
         
            
        
            
        
            
        
            
        
            
        
            
        
            
            <span class="link dropdown">
                <a class="link-name dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Links
                </a>
                <div class="dropdown-menu">
                    
                    <a class="dropdown-item" href="http://www.apache.org/">Apache Software Foundation</a> 
                    <a class="dropdown-item" href="https://github.com/apache/skywalking/issues">GitHub Issue Tracker</a> 
                    <a class="dropdown-item" href="https://github.com/apache/skywalking/discussions">Discussion</a> 
                    <a class="dropdown-item" href="https://lists.apache.org/list.html?dev@skywalking.apache.org">Dev Mailing List</a> 
                    <a class="dropdown-item" href="https://cwiki.apache.org/confluence/display/SKYWALKING/Home">WIKI</a> 
                    <a class="dropdown-item" href="http://www.apache.org/licenses/">License</a> 
                    <a class="dropdown-item" href="http://www.apache.org/events/current-event">Apache Events</a> 
                    <a class="dropdown-item" href="http://www.apache.org/security/">Security</a> 
                    <a class="dropdown-item" href="http://www.apache.org/foundation/sponsorship.html">Sponsor and Donate</a> 
                    <a class="dropdown-item" href="http://www.apache.org/foundation/thanks.html">Thanks</a> 
                    <a class="dropdown-item" href="https://apache.org/foundation/policies/privacy.html">Privacy</a> 
                </div>
            </span>
            
        
        
<div id="docsearch"></div>


    </div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row container container-center">

          <main class="col-12 col-md-12 col-xl-10 pl-md-4 pr-md-4" role="main">
            
<div class="td-content">
	<h1>Observe Service Mesh with SkyWalking and Envoy Access Log Service</h1>
	<div class="lead">In this tutorial, learn how to use Apache SkyWalking for service mesh observability without Istio Mixer</div>
	<div class="td-byline mb-4">
		By <b>Zhenxu Ke, Sheng Wu, and Tevah Platt. tetrate.io</b> |
		<time datetime="2020-12-03" class="text-muted">Thursday, December 03, 2020</time>


		
		<p class="mt-1 tags-box">
			<i class="iconfont icon-tags"></i>Tags |
			
			<span> <a href="/tags/service-mesh">Service Mesh</a></span>
			
		</p>
		


	</div>
	<p><img src="canyonhorseshoe.jpg" alt=""></p>
<ul>
<li>Author: Zhenxu Ke, Sheng Wu, and Tevah Platt. tetrate.io</li>
<li>Original link, <a href="https://www.tetrate.io/blog/observe-service-mesh-with-skywalking-and-envoy-access-log-service/">Tetrate.io blog</a></li>
<li>Dec. 03th, 2020</li>
</ul>
<p><a href="https://github.com/apache/skywalking">Apache SkyWalking</a>: an APM (application performance monitor) system, especially designed for microservices, cloud native, and container-based (Docker, Kubernetes, Mesos) architectures.</p>
<p><a href="https://www.envoyproxy.io/docs/envoy/latest/api-v2/service/accesslog/v2/als.proto">Envoy Access Log Service</a>: Access Log Service (ALS) is an Envoy extension that emits detailed access logs of all requests going through Envoy.</p>
<h2 id="background">Background</h2>
<p>Apache SkyWalking has long supported observability in service mesh with Istio Mixer adapter. But since v1.5, Istio began to deprecate Mixer due to its poor performance in large scale clusters. Mixer’s functionalities have been moved into the Envoy proxies, and is supported only through the 1.7 Istio release.
On the other hand, <a href="https://github.com/wu-sheng">Sheng Wu</a> and <a href="https://github.com/lizan">Lizan Zhou</a> presented a better solution based on the Apache SkyWalking and Envoy ALS on <a href="https://kccncosschn19eng.sched.com/event/NroB/observability-in-service-mesh-powered-by-envoy-and-apache-skywalking-sheng-wu-lizan-zhou-tetrate">KubeCon China 2019</a>,  to reduce the performance impact brought by Mixer, while retaining the same observability in service mesh. This solution was initially implemented by Sheng Wu, <a href="https://github.com/hanahmily">Hongtao Gao</a>, Lizan Zhou, and <a href="https://github.com/dio">Dhi Aurrahman</a> at Tetrate.io.
If you are looking for a more efficient solution to observe your service mesh instead of using a Mixer-based solution, this is exactly what you need. In this tutorial, we will explain a little bit how the new solution works, and apply it to the bookinfo application in practice.</p>
<h2 id="how-it-works">How it works</h2>
<p>From a perspective of observability, Envoy can be typically deployed in 2 modes, sidecar, and router. As a sidecar, Envoy mostly represents a single service to receive and send requests (2 and 3 in the picture below). While as a proxy, Envoy may represent many services (1 in the picture below).</p>
<p><img src="Screen-Shot-2020-12-02-at-2.25.17-PM.png" alt="Example of Envoy deployment, as front proxy and sidecar"></p>
<p>In both modes, the logs emitted by ALS include a node identifier. The identifier starts with <code>router~</code> (or <code>ingress~</code>) in router mode and <code>sidecar~</code> in sidecar proxy mode.</p>
<p>Apart from the node identifier, there are <a href="https://github.com/envoyproxy/envoy/blob/549164c42cae84b59154ca4c36009e408aa10b52/generated_api_shadow/envoy/data/accesslog/v2/accesslog.proto">several noteworthy properties in the access logs</a> that will be used in this solution:</p>
<ul>
<li>
<p><code>downstream_direct_remote_address</code>: This field is the downstream direct remote address on which the request from the user was received. Note: This is always the physical peer, even if the remote address is inferred from for example the <code>x-forwarded-for</code> header, proxy protocol, etc.</p>
</li>
<li>
<p><code>downstream_remote_address</code>: The remote/origin address on which the request from the user was received.</p>
</li>
<li>
<p><code>downstream_local_address</code>: The local/destination address on which the request from the user was received.</p>
</li>
<li>
<p><code>upstream_remote_address</code>: The upstream remote/destination address that handles this exchange.</p>
</li>
<li>
<p><code>upstream_local_address</code>: The upstream local/origin address that handles this exchange.</p>
</li>
<li>
<p><code>upstream_cluster</code>: The upstream cluster that <em>upstream_remote_address</em> belongs to.</p>
</li>
</ul>
<p>We will discuss more about the properties in the following sections.</p>
<h3 id="sidecar">Sidecar</h3>
<p>When serving as a sidecar, Envoy is deployed alongside a service, and delegates all the incoming/outgoing requests to/from the service.</p>
<ol>
<li>
<p><strong>Delegating incoming requests:</strong> in this case, Envoy acts as a server side sidecar, and sets the <code>upstream_cluster</code> in form of <code>inbound|portNumber|portName|Hostname[or]SidecarScopeID</code>.</p>
<p><img src="Screen-Shot-2020-12-02-at-2.37.49-PM.png" alt=""></p>
<p>The SkyWalking analyzer checks whether either <code>downstream_remote_address</code> can be mapped to a Kubernetes service:</p>
<p>a. If there is a service (say <code>Service B</code>) whose implementation is running in this IP(and port), then we have a service-to-service relation, <code>Service B -&gt; Service A</code>, which can be used to build the topology. Together with the <code>start_time</code> and <code>duration</code> fields in the access log, we have the latency metrics now.</p>
<p>b. If there is no service that can be mapped to <code>downstream_remote_address</code>, then the request may come from a service out of the mesh. Since SkyWalking cannot identify the source service where the requests come from, it simply generates the metrics without source service, according to the <a href="https://wu-sheng.github.io/STAM/">topology analysis method</a>. The topology can be built as accurately as possible, and the metrics detected from server side are still correct.</p>
</li>
<li>
<p><strong>Delegating outgoing requests:</strong> in this case, Envoy acts as a client-side sidecar, and sets the <code>upstream_cluster</code> in form of <code>outbound|&lt;port&gt;|&lt;subset&gt;|&lt;serviceFQDN&gt;</code>.</p>
<p><img src="Screen-Shot-2020-12-02-at-2.43.16-PM.png" alt=""></p>
<p>Client side detection is relatively simpler than (1. Delegating incoming requests). If <code>upstream_remote_address</code> is another sidecar or proxy, we simply get the mapped service name and generate the topology and metrics. Otherwise, we have no idea what it is and consider it an <code>UNKNOWN</code> service.</p>
</li>
</ol>
<h3 id="proxy-role">Proxy role</h3>
<p>When Envoy is deployed as a proxy, it is an independent service itself and doesn&rsquo;t represent any other service like a sidecar does. Therefore, we can build client-side metrics as well as server-side metrics.</p>
<p><img src="Screen-Shot-2020-12-02-at-2.46.56-PM.png" alt=""></p>
<h2 id="example">Example</h2>
<p>In this section, we will use the typical <a href="https://istio.io/latest/docs/examples/bookinfo/">bookinfo application</a> to demonstrate how  Apache SkyWalking 8.3.0+ (the latest version up to Nov. 30th, 2020) works together with Envoy ALS to observe a service mesh.</p>
<h3 id="installing-kubernetes">Installing Kubernetes</h3>
<p>SkyWalking 8.3.0 supports the Envoy ALS solution under both Kubernetes environment and virtual machines (VM) environment, in this tutorial, we’ll only focus on the Kubernetes scenario, for VM solution, please stay tuned for our next blog, so we need to install Kubernetes before taking further steps.</p>
<p>In this tutorial, we will use the <a href="https://minikube.sigs.k8s.io/docs/">Minikube</a> tool to quickly set up a local Kubernetes(v1.17) cluster for testing. In order to run all the needed components, including the bookinfo application, the SkyWalking OAP and WebUI, the cluster may need up to 4GB RAM and 2 CPU cores.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">minikube start --memory<span style="color:#000;font-weight:bold">=</span><span style="color:#099">4096</span> --cpus<span style="color:#000;font-weight:bold">=</span><span style="color:#099">2</span>
</code></pre></div><p>Next, run <code>kubectl get pods --namespace=kube-system --watch</code> to check whether all the Kubernetes components are ready. If not, wait for the readiness before going on.</p>
<h3 id="installing-istio">Installing Istio</h3>
<p>Istio provides a very convenient way to configure the Envoy proxy and enable the access log service. The built-in configuration profiles free us from lots of manual operations. So, for demonstration purposes, we will use Istio through this tutorial.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#0086b3">export</span> <span style="color:#008080">ISTIO_VERSION</span><span style="color:#000;font-weight:bold">=</span>1.7.1
curl -L https://istio.io/downloadIstio | sh - 
sudo mv <span style="color:#008080">$PWD</span>/istio-<span style="color:#008080">$ISTIO_VERSION</span>/bin/istioctl /usr/local/bin/
istioctl  install --set <span style="color:#008080">profile</span><span style="color:#000;font-weight:bold">=</span>demo
kubectl label namespace default istio-injection<span style="color:#000;font-weight:bold">=</span>enabled
</code></pre></div><p>Run <code>kubectl get pods --namespace=istio-system --watch</code> to check whether all the Istio components are ready. If not, wait for the readiness before going on.</p>
<h3 id="enabling-als">Enabling ALS</h3>
<p>The <code>demo</code> profile doesn’t enable ALS by default. We need to reconfigure it to enable ALS via some configuration.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">istioctl  manifest install <span style="color:#d14">\
</span><span style="color:#d14"></span>               --set meshConfig.enableEnvoyAccessLogService<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> <span style="color:#d14">\
</span><span style="color:#d14"></span>               --set meshConfig.defaultConfig.envoyAccessLogService.address<span style="color:#000;font-weight:bold">=</span>skywalking-oap.istio-system:11800
</code></pre></div><p>The example command <code>--set meshConfig.enableEnvoyAccessLogService=true</code> enables the Envoy access log service in the mesh. And as we said earlier, ALS is essentially a gRPC service that emits requests logs. The config <code>meshConfig.defaultConfig.envoyAccessLogService.address=skywalking-oap.istio-system:11800</code> tells this gRPC service  where to emit the logs, say <code>skywalking-oap.istio-system:11800</code>, where we will deploy the SkyWalking ALS receiver later.</p>
<p>NOTE:
You can also enable the ALS when installing Istio so that you don’t need to restart Istio after installation:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">istioctl install --set <span style="color:#008080">profile</span><span style="color:#000;font-weight:bold">=</span>demo <span style="color:#d14">\
</span><span style="color:#d14"></span>               --set meshConfig.enableEnvoyAccessLogService<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> <span style="color:#d14">\
</span><span style="color:#d14"></span>               --set meshConfig.defaultConfig.envoyAccessLogService.address<span style="color:#000;font-weight:bold">=</span>skywalking-oap.istio-system:11800
kubectl label namespace default istio-injection<span style="color:#000;font-weight:bold">=</span>enabled
</code></pre></div><h3 id="deploying-apache-skywalking">Deploying Apache SkyWalking</h3>
<p>The SkyWalking community provides a <a href="https://helm.sh">Helm</a> Chart to make it easier to deploy SkyWalking and its dependent services in Kubernetes. The Helm Chart can be found at the <a href="https://github.com/apache/skywalking-kubernetes">GitHub repository</a>.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#998;font-style:italic"># Install Helm</span>
curl -sSLO https://get.helm.sh/helm-v3.0.0-linux-amd64.tar.gz
sudo tar xz -C /usr/local/bin --strip-components<span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span> linux-amd64/helm -f helm-v3.0.0-linux-amd64.tar.gz
<span style="color:#998;font-style:italic"># Clone SkyWalking Helm Chart</span>
git clone https://github.com/apache/skywalking-kubernetes
<span style="color:#0086b3">cd</span> skywalking-kubernetes/chart
git reset --hard dd749f25913830c47a97430618cefc4167612e75
<span style="color:#998;font-style:italic"># Update dependencies</span>
helm dep up skywalking
<span style="color:#998;font-style:italic"># Deploy SkyWalking</span>
helm -n istio-system install skywalking skywalking <span style="color:#d14">\
</span><span style="color:#d14"></span>               --set oap.storageType<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;h2&#39;</span><span style="color:#d14">\
</span><span style="color:#d14"></span>               --set ui.image.tag<span style="color:#000;font-weight:bold">=</span>8.3.0 <span style="color:#d14">\
</span><span style="color:#d14"></span>               --set oap.image.tag<span style="color:#000;font-weight:bold">=</span>8.3.0-es7 <span style="color:#d14">\
</span><span style="color:#d14"></span>               --set oap.replicas<span style="color:#000;font-weight:bold">=</span><span style="color:#099">1</span> <span style="color:#d14">\
</span><span style="color:#d14"></span>               --set oap.env.SW_ENVOY_METRIC_ALS_HTTP_ANALYSIS<span style="color:#000;font-weight:bold">=</span>k8s-mesh <span style="color:#d14">\
</span><span style="color:#d14"></span>               --set oap.env.JAVA_OPTS<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;-Dmode=&#39;</span> <span style="color:#d14">\
</span><span style="color:#d14"></span>               --set oap.envoy.als.enabled<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">true</span> <span style="color:#d14">\
</span><span style="color:#d14"></span>               --set elasticsearch.enabled<span style="color:#000;font-weight:bold">=</span><span style="color:#0086b3">false</span>
</code></pre></div><p>We deploy SkyWalking to the namespace <code>istio-system</code>, so that SkyWalking OAP service can be accessed by <code>skywalking-oap.istio-system:11800</code>, to which we told ALS to emit their logs, in the previous step.</p>
<p>We also enable the ALS analyzer in the SkyWalking OAP: <code>oap.env.SW_ENVOY_METRIC_ALS_HTTP_ANALYSIS=k8s-mesh</code>. The analyzer parses the access logs and maps the IP addresses in the logs to the real service names in the Kubernetes, to build a topology.</p>
<p>In order to retrieve the metadata (such as Pod IP and service names) from a Kubernetes cluster for IP mappings, we also set <code>oap.envoy.als.enabled=true</code>, to apply for a <code>ClusterRole</code> that has access to the metadata.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#0086b3">export</span> <span style="color:#008080">POD_NAME</span><span style="color:#000;font-weight:bold">=</span><span style="color:#000;font-weight:bold">$(</span>kubectl get pods -A -l <span style="color:#d14">&#34;app=skywalking,release=skywalking,component=ui&#34;</span> -o name<span style="color:#000;font-weight:bold">)</span>
<span style="color:#0086b3">echo</span> <span style="color:#008080">$POD_NAME</span>
kubectl -n istio-system port-forward <span style="color:#008080">$POD_NAME</span> 8080:8080
</code></pre></div><p>Now navigate your browser to http://localhost:8080 . You should be able to see the SkyWalking dashboard. The dashboard is empty for now, but after we deploy the demo application and generate traffic, it should be filled up later.</p>
<p><img src="Screen-Shot-2020-12-02-at-3.01.03-PM.png" alt=""></p>
<h3 id="deploying-bookinfo-application">Deploying Bookinfo application</h3>
<p>Run:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#0086b3">export</span> <span style="color:#008080">ISTIO_VERSION</span><span style="color:#000;font-weight:bold">=</span>1.7.1
kubectl apply -f https://raw.githubusercontent.com/istio/istio/<span style="color:#008080">$ISTIO_VERSION</span>/samples/bookinfo/platform/kube/bookinfo.yaml
kubectl apply -f https://raw.githubusercontent.com/istio/istio/<span style="color:#008080">$ISTIO_VERSION</span>/samples/bookinfo/networking/bookinfo-gateway.yaml
kubectl <span style="color:#0086b3">wait</span> --for<span style="color:#000;font-weight:bold">=</span><span style="color:#008080">condition</span><span style="color:#000;font-weight:bold">=</span>Ready pods --all --timeout<span style="color:#000;font-weight:bold">=</span>1200s
minikube tunnel
</code></pre></div><p>Then navigate your browser to http://localhost/productpage. You should be able to see the typical bookinfo application. Refresh the webpage several times to generate enough access logs.</p>
<h3 id="done">Done!</h3>
<p>And you’re all done! Check out the SkyWalking WebUI again. You should see the topology of the bookinfo application, as well the metrics of each individual service of the bookinfo application.</p>
<p><img src="Screen-Shot-2020-12-02-at-3.05.24-PM.png" alt="">
<img src="Screen-Shot-2020-12-02-at-3.11.55-PM.png" alt=""></p>
<h3 id="troubleshooting">Troubleshooting</h3>
<ul>
<li>Check all pods status: <code>kubectl get pods -A</code>.</li>
<li>SkyWalking OAP logs: <code>kubectl -n istio-system logs -f $(kubectl get pod -A -l &quot;app=skywalking,release=skywalking,component=oap&quot; -o name)</code>.</li>
<li>SkyWalking WebUI logs: <code>kubectl -n istio-system logs -f $(kubectl get pod -A -l &quot;app=skywalking,release=skywalking,component=ui&quot; -o name)</code>.</li>
<li>Make sure the time zone at the bottom-right of the WebUI is set to <code>UTC +0</code>.</li>
</ul>
<h2 id="customizing-service-names">Customizing Service Names</h2>
<p>The SkyWalking community brought more improvements to the ALS solution in the 8.3.0 version. You can decide how to compose the service names when mapping from the IP addresses, with variables <code>service</code> and <code>pod</code>. For instance, configuring <code>K8S_SERVICE_NAME_RULE</code> to the expression <code>${service.metadata.name}-${pod.metadata.labels.version}</code> gets service names with version label such as <code>reviews-v1</code>, <code>reviews-v2</code>, and <code>reviews-v3</code>, instead of a single service <code>reviews</code>, see <a href="https://github.com/apache/skywalking/pull/5722">the PR</a>.</p>
<h2 id="working-als-with-vm">Working ALS with VM</h2>
<p>Kubernetes is popular, but what about VMs? From what we discussed above, in order to map the IPs to services, SkyWalking needs access to the Kubernetes cluster, fetching service metadata and Pod IPs. But in a VM environment, there is no source from which we can fetch those metadata.
In the next post, we will introduce another ALS analyzer based on the Envoy metadata exchange mechanism. With this analyzer, you are able to observe a service mesh in the VM environment. Stay tuned!
If you want to  have commercial support for the ALS solution or hybrid mesh observability, <a href="https://www.tetrate.io/tetrate-service-bridge/">Tetrate Service Bridge, TSB</a> is another good option out there.</p>
<h2 id="additional-resources">Additional Resources</h2>
<ul>
<li>KubeCon 2019 Recorded <a href="https://www.youtube.com/watch?v=tERm39ju9ew">Video</a>.</li>
<li>Get more SkyWalking updates on <a href="https://skywalking.apache.org">the official website</a>.</li>
</ul>
<p><em>Apache SkyWalking founder Sheng Wu, SkyWalking core maintainer Zhenxu Ke are Tetrate engineers, and Tevah Platt is a content writer for Tetrate. Tetrate helps organizations adopt open source service mesh tools, including Istio, Envoy, and Apache SkyWalking, so they can manage microservices, run service mesh on any infrastructure, and modernize their applications.</em></p>

	

	<ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5">
  <li>
    <a href="/blog/2020-11-25-skywalking-satellite-0.1.0-design/" class="btn btn-primary "><span class="mr-1">←</span> Previous</a>
  </li>
    <a href="/blog/e2e-design/" class="btn btn-primary ">Next <span class="ml-1">→</span></a>
  </li>
</ul>

</div>


          </main>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">

            <div class="tags-wrapper">
    <div class="font-weight-bold post-meta ">
        <i class="iconfont icon-tags pr-1" aria-hidden="true"></i>
        Tags
    </div>
    <ul class="tags-box">
        
        <li>
            <a href="/tags/agent/" class="tag-link">Agent</a>
            <span class="count">10</span>
        </li>
        
        <li>
            <a href="/tags/apache-shenyu-incubating/" class="tag-link">Apache ShenYu (incubating)</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/apisix/" class="tag-link">APISIX</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/apm/" class="tag-link">APM</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/arthas/" class="tag-link">Arthas</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/aurora/" class="tag-link">Aurora</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/aws/" class="tag-link">AWS</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/browser/" class="tag-link">Browser</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/chaos-engineering/" class="tag-link">Chaos Engineering</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/chaos-mesh/" class="tag-link">Chaos Mesh</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/conference/" class="tag-link">Conference</a>
            <span class="count">6</span>
        </li>
        
        <li>
            <a href="/tags/database/" class="tag-link">Database</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/demo/" class="tag-link">Demo</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/tags/design/" class="tag-link">Design</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/dotnetcore/" class="tag-link">DotNetCore</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/ebpf/" class="tag-link">eBPF</a>
            <span class="count">6</span>
        </li>
        
        <li>
            <a href="/tags/golang/" class="tag-link">Golang</a>
            <span class="count">5</span>
        </li>
        
        <li>
            <a href="/tags/grafana/" class="tag-link">Grafana</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/http/" class="tag-link">HTTP</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/infrastructure-monitoring/" class="tag-link">Infrastructure Monitoring</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/iotdb/" class="tag-link">IoTDB</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/istio/" class="tag-link">Istio</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/java/" class="tag-link">Java</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/kafka/" class="tag-link">Kafka</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/kong/" class="tag-link">Kong</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/lal/" class="tag-link">LAL</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/license/" class="tag-link">License</a>
            <span class="count">5</span>
        </li>
        
        <li>
            <a href="/tags/logging/" class="tag-link">Logging</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/tags/logs/" class="tag-link">Logs</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/metric/" class="tag-link">Metric</a>
            <span class="count">6</span>
        </li>
        
        <li>
            <a href="/tags/metrics/" class="tag-link">Metrics</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/nginx/" class="tag-link">Nginx</a>
            <span class="count">5</span>
        </li>
        
        <li>
            <a href="/tags/observability/" class="tag-link">Observability</a>
            <span class="count">10</span>
        </li>
        
        <li>
            <a href="/tags/ospp/" class="tag-link">OSPP</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/performance/" class="tag-link">Performance</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/tags/profiling/" class="tag-link">Profiling</a>
            <span class="count">5</span>
        </li>
        
        <li>
            <a href="/tags/promql/" class="tag-link">PromQL</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/python/" class="tag-link">Python</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/rds/" class="tag-link">RDS</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/release-blog/" class="tag-link">Release Blog</a>
            <span class="count">4</span>
        </li>
        
        <li>
            <a href="/tags/satellite/" class="tag-link">Satellite</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/service-mesh/" class="tag-link">Service Mesh</a>
            <span class="count">6</span>
        </li>
        
        <li>
            <a href="/tags/sharding-sphere/" class="tag-link">Sharding-Sphere</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/sharding-sphere-proxy/" class="tag-link">Sharding-Sphere-proxy</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/skywalking/" class="tag-link">SkyWalking</a>
            <span class="count">5</span>
        </li>
        
        <li>
            <a href="/tags/spring/" class="tag-link">Spring</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/storage/" class="tag-link">Storage</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/testing/" class="tag-link">Testing</a>
            <span class="count">3</span>
        </li>
        
        <li>
            <a href="/tags/trace/" class="tag-link">Trace</a>
            <span class="count">4</span>
        </li>
        
        <li>
            <a href="/tags/tracing/" class="tag-link">Tracing</a>
            <span class="count">10</span>
        </li>
        
        <li>
            <a href="/tags/tutorial/" class="tag-link">Tutorial</a>
            <span class="count">1</span>
        </li>
        
        <li>
            <a href="/tags/user-manual/" class="tag-link">User Manual</a>
            <span class="count">2</span>
        </li>
        
        <li>
            <a href="/tags/video/" class="tag-link">Video</a>
            <span class="count">8</span>
        </li>
        
        <li>
            <a href="/tags/web-performance/" class="tag-link">Web-performance</a>
            <span class="count">1</span>
        </li>
        
    </ul>
</div>



            




<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">











</div>






<nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#background">Background</a></li>
        <li><a href="#how-it-works">How it works</a>
          <ul>
            <li><a href="#sidecar">Sidecar</a></li>
            <li><a href="#proxy-role">Proxy role</a></li>
          </ul>
        </li>
        <li><a href="#example">Example</a>
          <ul>
            <li><a href="#installing-kubernetes">Installing Kubernetes</a></li>
            <li><a href="#installing-istio">Installing Istio</a></li>
            <li><a href="#enabling-als">Enabling ALS</a></li>
            <li><a href="#deploying-apache-skywalking">Deploying Apache SkyWalking</a></li>
            <li><a href="#deploying-bookinfo-application">Deploying Bookinfo application</a></li>
            <li><a href="#done">Done!</a></li>
            <li><a href="#troubleshooting">Troubleshooting</a></li>
          </ul>
        </li>
        <li><a href="#customizing-service-names">Customizing Service Names</a></li>
        <li><a href="#working-als-with-vm">Working ALS with VM</a></li>
        <li><a href="#additional-resources">Additional Resources</a></li>
      </ul>
    </li>
  </ul>
</nav>




<script>
  $(function () {
    var $toc = $("#TableOfContents");
    if (!$toc || !$toc.length) {
      return;
    }
    var top = $toc.offset().top;
    $(window).on("scroll", debounce(setTop, 100))
    $(window).on("scroll", debounce(addActive, 30))

    function addActive() {
      var scrollValue = $(window).scrollTop();
      var topEle = null;
      $.each($('main h1, main h2, main h3'), function (index, item) {
        if ($(item).offset().top - 70 > scrollValue) {
          return
        }
        if (!topEle) {
          topEle = item
        } else if ($(item).offset().top >= $(topEle).offset().top) {
          topEle = item
        }
        if (topEle) {
          var id = $(item).attr('id');
          $toc.find('a').removeClass("active").end().find('a[href="' + '#' + id + '"]').addClass("active")
        }
      })
    }

    function setTop() {
      var scrollValue = $(window).scrollTop();
      if (scrollValue >= top - 70) {
        $toc.addClass('fixed')
      } else {
        $toc.removeClass('fixed')
      }
    }

    function debounce(fn, wait) {
      var timeout = null;
      return function () {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          fn.apply(this, arguments);
        }, wait);
      };
    }
  })

</script>

          </div>
        </div>
      </div>
      
<footer class="py-5 sky-row">
  <div class="container-fluid text-center">
    <div class="">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-color" target="_blank" href="https://twitter.com/asfskywalking">
      <i class="iconfont icon-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-color" target="_blank" href="http://s.apache.org/slack-invite">
      <i class="iconfont icon-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Mailing list" aria-label="Mailing list">
    <a class="text-color" target="_blank" href="https://lists.apache.org/list.html?dev@skywalking.apache.org">
      <i class="iconfont icon-email"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-color" target="_blank" href="https://github.com/apache/skywalking">
      <i class="iconfont icon-github"></i>
    </a>
  </li>
  
</ul>

        
        
    </div>
    <div class="">

        <small class="text-color">&copy; 2017 - 2024 The Apache Software Foundation All Rights Reserved</small>
        
	
    </div>
    <div class="">
      <small class="text-color mt-4">Apache SkyWalking, SkyWalking, Apache, the Apache feather logo, and the Apache SkyWalking project logo are either registered trademarks or trademarks of the Apache Software Foundation.</small>
    </div>
  </div>
</footer>


    </div>
    





























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































    
<div id="popup">
    <div class="mask">
        <img src=""/>
    </div>
</div>

    <div class="sidebar-mask"></div>
<div class="sidebar">
    <nav class="nav-links">
        <div class="nav-item"><a href="/docs/" class="nav-link">Projects and Documentation</a></div>
        <div class="nav-item"><a href="/events/" class="nav-link">Events</a></div>
        <div class="nav-item"><a href="/blog/" class="nav-link router-link-exact-active router-link-active">Blog</a>
        </div>
        <div class="nav-item"><a href="/downloads/" class="nav-link">Downloads</a></div>
        <div class="nav-item"><a href="/team/" class="nav-link">Team</a></div>
        <div class="nav-item"><a href="/users/" class="nav-link">Users</a></div>
        <div class="nav-item">
            <div class="dropdown-wrapper open">
                <a class="dropdown-title"><span>中文资料</span>
                    <span class="arrow down"></span>
                </a>
                <ul class="nav-dropdown">
                    <li class="dropdown-item">
                        <a href="/zh/" class="nav-link external">博客</a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://space.bilibili.com/390683219" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">B站</a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://juejin.cn/user/13673577331607" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">掘金</a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="nav-item">
            <div class="dropdown-wrapper open">
                <a class="dropdown-title">
                    <span>Links</span>
                    <span class="arrow down"></span>
                </a>
                <ul class="nav-dropdown">
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Apache Software Foundation
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://github.com/apache/skywalking/issues"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            GitHub Issue Tracker
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://lists.apache.org/list.html?dev@skywalking.apache.org" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Dev Mailing List
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/licenses/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            License
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/events/current-event"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Apache Events
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/security/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Security
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/foundation/sponsorship.html"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Sponsorship and Donate
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/foundation/thanks.html"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Thanks
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</div>

    <script src="/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>









<script src="/js/main.min.dc00f5ca911ee5aa105ea6de6b3b7e8d8169ba5a3bf156b1fcfe23dfe3e62b0a.js" integrity="sha256-3AD1ypEe5aoQXqbeazt&#43;jYFpulo78Vax/P4j3&#43;PmKwo=" crossorigin="anonymous"></script>


<script src="/js/mermaid.min.js"></script>
<script>
    window.onload = () => mermaid.init(undefined, ".language-mermaid");
</script>


<script defer
src="https://widget.kapa.ai/kapa-widget.bundle.js"
data-website-id="8a08392b-9c4d-4816-8bc4-f93e0ecdd2a7"
data-project-name="SkyWalking"
data-project-color="#2B74B8"
data-button-text="Ask AI"
data-search-mode-enabled="true"
data-modal-open-on-command-k="true"
data-modal-disclaimer="The AI supports multiple languages, but it may not be accessible in China, a proxy is required."
data-project-logo="https://miro.medium.com/v2/resize:fit:2400/0*kmS-5BQ8ShAhZ_F4.jpg"
data-modal-example-questions="What is Apache SkyWalking?,How to deploy SkyWalking?,How to inject agents non-intrusively?,How to setup trace sampling?"
data-button-position-top=""
data-button-position-right="20px"
data-button-position-bottom="200px"
data-button-position-left=""
></script>




  </body>
</html>
