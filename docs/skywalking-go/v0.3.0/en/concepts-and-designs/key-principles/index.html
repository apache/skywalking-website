<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="twitter:site" content="skywalking.apache.org">
<meta name="twitter:image:src" content="https://skywalking.apache.org/images/skywalking_400x400.png">
<meta property="og:image" content="https://skywalking.apache.org/images/skywalking_400x400.png">

<meta http-equiv="Content-Security-Policy" content="frame-src 'self' https://www.google.com https://app.netlify.com;">

<meta name="generator" content="Hugo 0.80.0" />


<script async src="https://www.googletagmanager.com/gtag/js?id=G-GR8N6PGRJ3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);};
  gtag('js', new Date());gtag('config', 'G-GR8N6PGRJ3');
</script>
<META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
<link rel="stylesheet" href="//at.alicdn.com/t/c/font_3007530_pvozs1rz2wn.css">



<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
<link rel="manifest" href="/favicons/site.webmanifest">
<link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<title>Key Principle | Apache SkyWalking</title><meta property="og:title" content="Key Principle" />
<meta property="og:description" content="Key Principle Introduce the key technical processes used in the SkyWalking Go Agent, to help the developers and end users understand how the agent works easier.
Method Interceptor Method interception is particularly important in SkyWalking Go, as it enables the creation of plugins. In SkyWalking Go, method interception mainly involves the following key points:
 Finding Method: Using AST to find method information in the target code to be enhanced. Modifying Methods: Enhancing the specified methods and embedding interceptor code." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/docs/skywalking-go/v0.3.0/en/concepts-and-designs/key-principles/" />

<meta itemprop="name" content="Key Principle">
<meta itemprop="description" content="Key Principle Introduce the key technical processes used in the SkyWalking Go Agent, to help the developers and end users understand how the agent works easier.
Method Interceptor Method interception is particularly important in SkyWalking Go, as it enables the creation of plugins. In SkyWalking Go, method interception mainly involves the following key points:
 Finding Method: Using AST to find method information in the target code to be enhanced. Modifying Methods: Enhancing the specified methods and embedding interceptor code.">

<meta itemprop="wordCount" content="1792">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Key Principle"/>
<meta name="twitter:description" content="Key Principle Introduce the key technical processes used in the SkyWalking Go Agent, to help the developers and end users understand how the agent works easier.
Method Interceptor Method interception is particularly important in SkyWalking Go, as it enables the creation of plugins. In SkyWalking Go, method interception mainly involves the following key points:
 Finding Method: Using AST to find method information in the target code to be enhanced. Modifying Methods: Enhancing the specified methods and embedding interceptor code."/>



<link rel="preload" href="/scss/main.min.592235942cb3c9f3dd697382a4e7a1fad8e1c182dad2841bdce6b43b4a346ae8.css" as="style">
<link href="/scss/main.min.592235942cb3c9f3dd697382a4e7a1fad8e1c182dad2841bdce6b43b4a346ae8.css" rel="stylesheet" integrity="">



<link rel="stylesheet" href="/css/docSearch.css" />


<script src="/js/jquery-3.6.0.min.js"></script>





    <title>Key Principle | Apache SkyWalking</title>
  </head>
  <body class="td-page  project-doc">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand  flex-column flex-md-row td-navbar">
    <div class="sidebar-button">
      <i class="iconfont icon-menu"></i>
    </div>
    <a class="navbar-brand" href="/">
        <span class="navbar-logo"><img width="130" src="/images/logo.svg" alt="SkyWalking"></span> 
    </a>
    <div class="td-navbar-nav-scroll navbar-nav-wrapper" id="navigation">
        <ul class="navbar-nav mt-lg-0">
             
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/docs" ><span>Projects and Docs</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/events" ><span>Events</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/blog" ><span>Blogs</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/downloads" ><span>Downloads</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/team" ><span>Team</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/users" ><span>Users</span></a>
			</li>
            
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
                <span class="link dropdown blog">
                    <a class="link-name nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">中文资料</a>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="/zh/">博客</a>
                        <a class="dropdown-item" href="https://space.bilibili.com/390683219" target="_blank" rel="noopener noreferrer">
                            B站
                        </a>
                        <a class="dropdown-item" href="https://juejin.cn/user/13673577331607" target="_blank" rel="noopener noreferrer">
                            掘金
                        </a>
                    </div>
                </span>
            </li>

            
			
        </ul>
    </div>
    <div class="navbar-nav d-none d-lg-block search-input-box">
         
            
        
            
        
            
        
            
        
            
        
            
        
            
            <span class="link dropdown">
                <a class="link-name dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Links
                </a>
                <div class="dropdown-menu">
                    
                    <a class="dropdown-item" href="http://www.apache.org/">Apache Software Foundation</a> 
                    <a class="dropdown-item" href="https://github.com/apache/skywalking/issues">GitHub Issue Tracker</a> 
                    <a class="dropdown-item" href="https://github.com/apache/skywalking/discussions">Discussion</a> 
                    <a class="dropdown-item" href="https://lists.apache.org/list.html?dev@skywalking.apache.org">Dev Mailing List</a> 
                    <a class="dropdown-item" href="https://cwiki.apache.org/confluence/display/SKYWALKING/Home">WIKI</a> 
                    <a class="dropdown-item" href="http://www.apache.org/licenses/">License</a> 
                    <a class="dropdown-item" href="http://www.apache.org/events/current-event">Apache Events</a> 
                    <a class="dropdown-item" href="http://www.apache.org/security/">Security</a> 
                    <a class="dropdown-item" href="http://www.apache.org/foundation/sponsorship.html">Sponsor and Donate</a> 
                    <a class="dropdown-item" href="http://www.apache.org/foundation/thanks.html">Thanks</a> 
                    <a class="dropdown-item" href="https://apache.org/foundation/policies/privacy.html">Privacy</a> 
                </div>
            </span>
            
        
        
<div id="docsearch"></div>


    </div>
</nav>

    </header>
    <div class="container-fluid td-outer">

      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 d-print-none scroll-bar td-sidebar">
























                  <div class="description-wrapper">
                    <h5>
                    <img width="26" height="26" src="/images/project/skywalking-go.svg">
                    Go Agent
                    </h5>
                    <p>The Go Agent for Apache SkyWalking, which provides the native tracing/metrics/logging abilities for Golang projects.</p>
                  </div>
                  
                  <div class="version-wrapper">Version: 
                  <select class="version-select">
                  
                    
                    
                    <option ZgotmplZ value="next">
                    
                      next
                    
                    </option>
                  
                    
                    
                    <option ZgotmplZ value="latest">
                    
                      latest
                    
                    </option>
                  
                    
                    
                    <option selected value="v0.3.0">
                    
                      v0.3.0
                    
                    </option>
                  
                  </select>
                  </div>
                  
                  <ul class="sidebar-menu">
    
    <li>
        
            
            <a href="#">Concepts and Designs<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/skywalking-go/v0.3.0/en/concepts-and-designs/hybrid-compilation">Hybrid Compilation</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-go/v0.3.0/en/concepts-and-designs/key-principles">How SkyWalking Agent Works</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-go/v0.3.0/en/concepts-and-designs/project-structure">Project Structure</a>
        
    </li>

    

</ul>

        
    </li>
    
    <li>
        
            
            <a href="#">Setup<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/skywalking-go/v0.3.0/en/setup/gobuild">Quick Start</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-go/v0.3.0/en/setup/docker">Docker</a>
        
    </li>

    

</ul>

        
    </li>
    
    <li>
        
            
            <a href="#">Advanced Features<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/skywalking-go/v0.3.0/en/advanced-features/settings-override">Setting Override</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-go/v0.3.0/en/advanced-features/logging-setup">Logging Setup</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-go/v0.3.0/en/advanced-features/plugin-exclusion">Plugin Exclusion</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-go/v0.3.0/en/agent/plugin-configurations">Plugin Configuration</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-go/v0.3.0/en/advanced-features/grpc-tls">Transport Layer Security (TLS)</a>
        
    </li>

    

    <li>
        

            
            <a href="#">Manual APIs<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/skywalking-go/v0.3.0/en/advanced-features/manual-apis/toolkit-trace.md">Tracing APIs</a>
        
    </li>

    

</ul>

        
    </li>

    

</ul>

        
    </li>
    
    <li>
        
            
            <a href="#">Plugins<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/skywalking-go/v0.3.0/en/agent/support-plugins">Supported Libraries</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-go/v0.3.0/en/agent/tracing-metrics-logging">Tracing, Metrics and Logging</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-go/v0.3.0/en/agent/performance-tests">Go Agent Performance Test</a>
        
    </li>

    

</ul>

        
    </li>
    
    <li>
        
            
            <a href="#">Development and Contribution<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/skywalking-go/v0.3.0/en/development-and-contribution/development-guide">Plugin Development Guide</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-go/v0.3.0/en/development-and-contribution/write-plugin-testing">Write Plugin Testing</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-go/v0.3.0/en/development-and-contribution/running-and-debugging">Running And Debugging</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-go/v0.3.0/en/development-and-contribution/build-and-use-agent">Build and Use Agent from source codes</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-go/v0.3.0/en/development-and-contribution/how-to-release">How to Release</a>
        
    </li>

    

</ul>

        
    </li>
    
</ul>
<script src="/js/sidebar-menu.js"></script>
<script>
  (function (){
    $.sidebarMenu($('.sidebar-menu'))
    var path = window.location.pathname;
    var hash = window.location.hash;
    var $a = $('.sidebar-menu a')
    $a.each(function (e){
      if($(this).attr('href')+'/' === path || $(this).attr('href').replace('#','/#') === path+hash){
        $(this).parents('li').addClass('active').show()
      }
    })
    $a.on('click',function (){
      var url = $(this).attr('href')
      if(url!=='#'){
        window.location.href = url
      }
    })
  })()
</script>

                  <div class="commit-id">Commit Id: 316433e</div>
                



















</div>
            <main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role="main">
              <i class="iconfont icon-menu-doc doc-menu-button"></i>
              
<div class="td-content">











	<h1 id="key-principle">Key Principle</h1>
<p>Introduce the key technical processes used in the SkyWalking Go Agent, to help the developers and end users understand how the agent works easier.</p>
<h2 id="method-interceptor">Method Interceptor</h2>
<p>Method interception is particularly important in SkyWalking Go, as it enables the creation of plugins. In SkyWalking Go, method interception mainly involves the following key points:</p>
<ol>
<li><strong>Finding Method</strong>: Using <code>AST</code> to find method information in the target code to be enhanced.</li>
<li><strong>Modifying Methods</strong>: Enhancing the specified methods and embedding interceptor code.</li>
<li><strong>Saving and Compiling</strong>: Updating the modified files in the compilation arguments.</li>
</ol>
<h3 id="finding-method">Finding Method</h3>
<p>When looking for methods, the SkyWalking Go Agent requires to search according to the provided compilation arguments, which mainly include the following two parts:</p>
<ol>
<li><strong>Package information</strong>: Based on the package name provided by the arguments, the Agent can find the specific plugin.</li>
<li><strong>Go files</strong>: When a matching plugin is found, the Agent reads the <code>.go</code> files and uses <code>AST</code> to parse the method information from these source files. When the method information matches the method information required by the plugin for the interception, the agent would consider the method found.</li>
</ol>
<h3 id="modifying-methods">Modifying Methods</h3>
<p>After finding the method, the SkyWalking Go Agent needs to modify the method implication and embed the interceptor code.</p>
<h4 id="change-method-body">Change Method Body</h4>
<p>When intercepting a method, the first thing to do is to modify the method and <a href="https://github.com/apache/skywalking-go/tree/316433e71808ec6a130e81c287caa8b2a98f45a5/tools/go-agent/instrument/plugins/templates/method_inserts.tmpl">embed the template code</a>.
This code segment includes two method executions:</p>
<ol>
<li><strong>Before method execution</strong>: Pass in the current method&rsquo;s arguments, instances, and other information.</li>
<li><strong>After method execution</strong>: Using the <code>defer</code> method, intercept the result parameters after the code execution is completed.</li>
</ol>
<p>Based on these two methods, the agent can intercept before and after method execution.</p>
<p>In order not to affect the line of code execution, this code segment will only be executed in the <strong>same line as the first statement in the method</strong>.
This ensures that when an exception occurs in the framework code execution, the exact location can still be found without being affected by the enhanced code.</p>
<h4 id="write-delegator-file">Write Delegator File</h4>
<p>After the agent enhances the method body, it needs to implement the above two methods and write them into a single file, called the <strong>delegator file</strong>. These two methods would do the following:</p>
<ol>
<li><strong>Before method execution</strong>: <a href="https://github.com/apache/skywalking-go/tree/316433e71808ec6a130e81c287caa8b2a98f45a5/tools/go-agent/instrument/plugins/templates/method_intercept_before.tmpl">Build by the template</a>. Build the context for before and after interception, and pass the parameter information during execution to the interceptor in each plugin.</li>
<li><strong>After method execution</strong>: <a href="https://github.com/apache/skywalking-go/tree/316433e71808ec6a130e81c287caa8b2a98f45a5/tools/go-agent/instrument/plugins/templates/method_intercept_after.tmpl">Build by the template</a>. Pass the method return value to the interceptor and execute the method.</li>
</ol>
<h4 id="copy-files">Copy Files</h4>
<p>After completing the delegator file, the agent would perform the following copy operations:</p>
<ol>
<li><strong>Plugin Code</strong>: Copy the Go files containing the interceptors in the plugin to the same level directory as the current framework.</li>
<li><strong>Plugin Development API Code</strong>: Copy the operation APIs required by the interceptors in the plugin to the same level directory as the current framework, such as <code>tracing</code>.</li>
</ol>
<p>After copying the files, they cannot be immediately added to the compilation parameters, because they may have the same name as the existing framework code. Therefore, we need to perform some rewriting operations, which include the following parts:</p>
<ol>
<li><strong>Types</strong>: Rename created structures, interfaces, methods, and other types by adding a unified prefix.</li>
<li><strong>Static Methods</strong>: Add a prefix to non-instance methods. Static methods do not need to be rewritten since they have already been processed in the types.</li>
<li><strong>Variables</strong>: Add a prefix to global variables. It&rsquo;s not necessary to add a prefix to variables inside methods because they can ensure no conflicts would arise and are helpful for debugging.</li>
</ol>
<p>In the Tracing API, we can see several methods, such as:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000;font-weight:bold">var</span> (
	errParameter = operator.<span style="color:#900;font-weight:bold">NewError</span>(<span style="color:#d14">&#34;parameter are nil&#34;</span>)
)

<span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">CreateLocalSpan</span>(operationName <span style="color:#458;font-weight:bold">string</span>, opts <span style="color:#000;font-weight:bold">...</span>SpanOption) (s Span, err <span style="color:#458;font-weight:bold">error</span>)

<span style="color:#000;font-weight:bold">type</span> SpanOption <span style="color:#000;font-weight:bold">interface</span> {
    <span style="color:#900;font-weight:bold">Apply</span>(<span style="color:#000;font-weight:bold">interface</span>{})
}
</code></pre></div><p>After performed rewriting operations, they would become:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#000;font-weight:bold">var</span> (
	skywalkingOperatorVarTracingerrParameter = <span style="color:#900;font-weight:bold">skywalkingOperatorStaticMethodOperatorNewError</span>(<span style="color:#d14">&#34;parameter are nil&#34;</span>)
)

<span style="color:#000;font-weight:bold">func</span> <span style="color:#900;font-weight:bold">skywalkingOperatorStaticMethodTracingCreateLocalSpan</span>(operationName <span style="color:#458;font-weight:bold">string</span>, opts <span style="color:#000;font-weight:bold">...</span>skywalkingOperatorTypeTracingSpanOption) (s skywalkingOperatorTypeTracingSpan, err <span style="color:#458;font-weight:bold">error</span>)

<span style="color:#000;font-weight:bold">type</span> skywalkingOperatorTypeTracingSpanOption <span style="color:#000;font-weight:bold">interface</span> {
    <span style="color:#900;font-weight:bold">Apply</span>(<span style="color:#000;font-weight:bold">interface</span>{})
}
</code></pre></div><h3 id="saving-and-compiling">Saving and Compiling</h3>
<p>After the above steps are completed, the agent needs to save the modified files and add them to the compilation parameters.</p>
<p>At this point, when the framework executes the enhanced method, it can have the following capabilities:</p>
<ol>
<li><strong>Execute Plugin Code</strong>: Custom code can be embedded before and after the method execution, and real-time parameter information can be obtained.</li>
<li><strong>Operate Agent</strong>: By calling the Agent API, interaction with the Agent Core can be achieved, enabling functions such as distributed tracing.</li>
</ol>
<h2 id="propagation-context">Propagation Context</h2>
<p>SkyWalking uses a new and internal mechanism to propagate context(e.g. tracing context) instead of
relying on go native <code>context.Context</code>. This reduces the requirement for the target codes.</p>
<h3 id="context-propagation-between-methods">Context Propagation between Methods</h3>
<p>In the agent, it would enhance the <code>g</code> structure in the <code>runtime</code> package.
The <code>g</code> structure in Golang represents the internal data of the current goroutine.
By enhancing this structure and using the <code>runtime.getg()</code> method, we can obtain the enhanced data in the current structure in real-time.</p>
<p>Enhancement includes the following steps:</p>
<ol>
<li><strong>Add Attributes to g</strong>: Add a new field to the <code>g</code> struct, and value as <code>interface{}</code>.</li>
<li><strong>Export Methods</strong>: Export methods for real-time setting and getting of custom field values in the current goroutine through <code>go:linkname</code>.</li>
<li><strong>Import methods</strong>: In the Agent Core, import the setting and getting methods for custom fields.</li>
</ol>
<p>Through these, the agent has a shared context in any place within the same goroutine, similar to Java&rsquo;s <code>Thread Local</code>.</p>
<h3 id="context-propagation-between-goroutines">Context Propagation between Goroutines</h3>
<p>Besides using <code>g</code> object as the in-goroutine context propagation, SkyWalking builds a mechanism
to propagate context between Goroutines.</p>
<p>When a new goroutine is started on an existing goroutine, the <code>runtime.newproc1</code> method is called to create a new goroutine based on the existing one.
The agent would do <code>context-copy</code> from the previous goroutine to the newly created goroutine.
The new context in the <code>goroutine</code> only shares limited information to help continues tracing.</p>
<p>The specific operation process is as follows:</p>
<ol>
<li><strong>Write the copy method</strong>: Create a method for copying data from the previous goroutine.</li>
<li><strong>Insert code into newproc1</strong>: Insert the <code>defer</code> code, intercept the <code>g</code> objects before and after the execution, and call the copy method to assign values to the custom fields' data.</li>
</ol>
<h2 id="agent-with-dependency">Agent with Dependency</h2>
<p>Since SkyWalking Go Agent is based on compile-time enhancement, it cannot introduce third-party modules.
For example, when SkyWalking Agent communicates with OAP, it needs to exchange data through the <code>gRPC</code> protocol.
If the user does not introduce the gRPC module, it cannot be completed.</p>
<p>Due to resolve this problem, users need to introduce relevant modules to complete the basic dependency functions. This is why <code>import _ &quot;github.com/apache/skywalking-go&quot;</code> is required.
The main key modules that users currently need to introduce include:</p>
<ol>
<li><strong>uuid</strong>: Used to generate UUIDs, mainly for <code>TraceID</code> generation.</li>
<li><strong>errors</strong>: To encapsulate error content.</li>
<li><strong>gRPC</strong>: The basic library used for communication between SkyWalking Go Agent and the Server.</li>
<li><strong>skywalking-goapi</strong>: The data protocol for communication between Agent and Server in SkyWalking.</li>
</ol>
<h3 id="agent-core-copy">Agent Core Copy</h3>
<p>To simplify the complexity of using Agent, the SkyWalking Go introduced by users only contains the user usage API and code import.
The Agent Core code would be dynamically added during hybrid compilation, so when the Agent releases new features,
users only need to upgrade the Agent enhancement program without modifying the references in the program.</p>
<h3 id="code-import">Code Import</h3>
<p>You can see a lot of <code>imports.go</code> files anywhere in the SkyWalking Go, such as <a href="https://github.com/apache/skywalking-go/tree/316433e71808ec6a130e81c287caa8b2a98f45a5/imports.go">imports.go in the root directory</a>, but there is no actual code.
This is because, during hybrid compilation, if the code to be compiled references other libraries,
such as <code>os</code>, <code>fmt</code>, etc., they need to be referenced through the <strong>importcfg</strong> file during compilation.</p>
<p>The content of the <code>importcfg</code> file is shown below, which specifies the package dependency information required for all Go files to be compiled in the current package path.</p>
<pre><code>packagefile errors=/var/folders/wz/s5m922z15vz4fjhf5l4458xm0000gn/T/go-build2774248373/b006/_pkg_.a
packagefile internal/itoa=/var/folders/wz/s5m922z15vz4fjhf5l4458xm0000gn/T/go-build2774248373/b027/_pkg_.a
packagefile internal/oserror=/var/folders/wz/s5m922z15vz4fjhf5l4458xm0000gn/T/go-build2774248373/b035/_pkg_.a
</code></pre><p>So when the file is copied and added to the compilation process, the relevant dependency libraries need to be declared in <code>importcfg</code>.
Therefore, by predefining <code>import</code> in the project, the compiler can be forced to introduce the relevant libraries during compilation,
thus completing the dynamic enhancement operation.</p>
<h2 id="plugin-with-agent-core">Plugin with Agent Core</h2>
<p>As mentioned in the previous section, it is not possible to dynamically add dependencies between modules.
Agent can only modify the <code>importcfg</code> file to reference dependencies if we are sure that the previous dependencies have already been loaded,
but this is often impractical. For example, Agent cannot introduce dependencies from the plugin code into the Agent Core,
because the plugin is unaware of the Agent&rsquo;s existence. This raises a question: how can agent enable communication between plugins and Agent Core?</p>
<p>Currently, agent employ the following method: a global object is introduced in the <code>runtime</code> package, provided by Agent Core.
When a plugin needs to interact with Agent Core, it simply searches for this global object from <code>runtime</code> package. The specific steps are as follows:</p>
<ol>
<li><strong>Global object definition</strong>: Add a global variable when the <code>runtime</code> package is loaded and provide corresponding set and get methods.</li>
<li><strong>Set the variable when the Agent loads</strong>: When the Agent Core is copied and enhanced, import the method for setting the global variable and initialize the object in the global variable.</li>
<li><strong>Plugins</strong>: When the plugin is built, import the methods for reading the global variables and APIs.
At this point, we can access the object set in Agent Core and use the defined interface for the plugin to access methods in Agent Core.</li>
</ol>
<h3 id="limitation">Limitation</h3>
<p>Since the communication between the plugin API and Agent Core is through an interface, and the plugin API is copied in each plugin,
they can only transfer <strong>basic data types or any(<code>interface{}</code>) type</strong>. The reason is that when additional types are transferred,
agent would be copied multiple times, so the types transferred in the plugin are not consistent with the types in Agent Core,
as the types also need to be defined multiple times.</p>
<p>Therefore, when communicating, they only pass structured data through <strong>any type</strong>, and when the Agent Core or plugin obtains the data, a type cast is simply required.</p>
<h2 id="debugging">Debugging</h2>
<p>Based on the introductions in the previous sections, both Agent Core and plugin code are <strong>dynamically copied/modified</strong> into the target package.
So, how can we debug the program during development to identify issues?</p>
<p>Our current approach consists of the following steps:</p>
<ol>
<li><strong>Inform the source code location during flag</strong>: Enhance the debug parameters during compilation and inform the system path, for example: <code>-toolexec &quot;/path/to/agent -debug /path/to/code&quot;</code></li>
<li><strong>Get the original file path</strong>: Find the absolute location of the source code of the file to be copied based on the rules.</li>
<li><strong>Introduce the <code>//line</code> directive</strong>: Add the <code>//line</code> directive to the copied target file to inform the compiler of the location of the original file after copying.</li>
</ol>
<p>At this point, when the program is executed, developer can find the original file to be copied in the source code.</p>




</div>


            </main>
          <div id="toc" class="d-none d-xl-block col-xl-2 td-toc d-print-none">
            




<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">











</div>






<nav id="TableOfContents">
  <ul>
    <li><a href="#key-principle">Key Principle</a>
      <ul>
        <li><a href="#method-interceptor">Method Interceptor</a>
          <ul>
            <li><a href="#finding-method">Finding Method</a></li>
            <li><a href="#modifying-methods">Modifying Methods</a></li>
            <li><a href="#saving-and-compiling">Saving and Compiling</a></li>
          </ul>
        </li>
        <li><a href="#propagation-context">Propagation Context</a>
          <ul>
            <li><a href="#context-propagation-between-methods">Context Propagation between Methods</a></li>
            <li><a href="#context-propagation-between-goroutines">Context Propagation between Goroutines</a></li>
          </ul>
        </li>
        <li><a href="#agent-with-dependency">Agent with Dependency</a>
          <ul>
            <li><a href="#agent-core-copy">Agent Core Copy</a></li>
            <li><a href="#code-import">Code Import</a></li>
          </ul>
        </li>
        <li><a href="#plugin-with-agent-core">Plugin with Agent Core</a>
          <ul>
            <li><a href="#limitation">Limitation</a></li>
          </ul>
        </li>
        <li><a href="#debugging">Debugging</a></li>
      </ul>
    </li>
  </ul>
</nav>




<script>
  $(function () {
    var $toc = $("#TableOfContents");
    if (!$toc || !$toc.length) {
      return;
    }
    var top = $toc.offset().top;
    $(window).on("scroll", debounce(setTop, 100))
    $(window).on("scroll", debounce(addActive, 30))

    function addActive() {
      var scrollValue = $(window).scrollTop();
      var topEle = null;
      $.each($('main h1, main h2, main h3'), function (index, item) {
        if ($(item).offset().top - 70 > scrollValue) {
          return
        }
        if (!topEle) {
          topEle = item
        } else if ($(item).offset().top >= $(topEle).offset().top) {
          topEle = item
        }
        if (topEle) {
          var id = $(item).attr('id');
          $toc.find('a').removeClass("active").end().find('a[href="' + '#' + id + '"]').addClass("active")
        }
      })
    }

    function setTop() {
      var scrollValue = $(window).scrollTop();
      if (scrollValue >= top - 70) {
        $toc.addClass('fixed')
      } else {
        $toc.removeClass('fixed')
      }
    }

    function debounce(fn, wait) {
      var timeout = null;
      return function () {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          fn.apply(this, arguments);
        }, wait);
      };
    }
  })

</script>

          </div>

        </div>
      </div>

      
<footer class="py-5 sky-row">
  <div class="container-fluid text-center">
    <div class="">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-color" target="_blank" href="https://twitter.com/asfskywalking">
      <i class="iconfont icon-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-color" target="_blank" href="http://s.apache.org/slack-invite">
      <i class="iconfont icon-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Mailing list" aria-label="Mailing list">
    <a class="text-color" target="_blank" href="https://lists.apache.org/list.html?dev@skywalking.apache.org">
      <i class="iconfont icon-email"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-color" target="_blank" href="https://github.com/apache/skywalking">
      <i class="iconfont icon-github"></i>
    </a>
  </li>
  
</ul>

        
        
    </div>
    <div class="">

        <small class="text-color">&copy; 2017 - 2024 The Apache Software Foundation All Rights Reserved</small>
        
	
    </div>
    <div class="">
      <small class="text-color mt-4">Apache SkyWalking, SkyWalking, Apache, the Apache feather logo, and the Apache SkyWalking project logo are either registered trademarks or trademarks of the Apache Software Foundation.</small>
    </div>
  </div>
</footer>


    </div>
    





























































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































    
<div id="popup">
    <div class="mask">
        <img src=""/>
    </div>
</div>

    <div class="sidebar-mask"></div>
<div class="sidebar">
    <nav class="nav-links">
        <div class="nav-item"><a href="/docs/" class="nav-link">Projects and Documentation</a></div>
        <div class="nav-item"><a href="/events/" class="nav-link">Events</a></div>
        <div class="nav-item"><a href="/blog/" class="nav-link router-link-exact-active router-link-active">Blog</a>
        </div>
        <div class="nav-item"><a href="/downloads/" class="nav-link">Downloads</a></div>
        <div class="nav-item"><a href="/team/" class="nav-link">Team</a></div>
        <div class="nav-item"><a href="/users/" class="nav-link">Users</a></div>
        <div class="nav-item">
            <div class="dropdown-wrapper open">
                <a class="dropdown-title"><span>中文资料</span>
                    <span class="arrow down"></span>
                </a>
                <ul class="nav-dropdown">
                    <li class="dropdown-item">
                        <a href="/zh/" class="nav-link external">博客</a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://space.bilibili.com/390683219" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">B站</a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://juejin.cn/user/13673577331607" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">掘金</a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="nav-item">
            <div class="dropdown-wrapper open">
                <a class="dropdown-title">
                    <span>Links</span>
                    <span class="arrow down"></span>
                </a>
                <ul class="nav-dropdown">
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Apache Software Foundation
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://github.com/apache/skywalking/issues"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            GitHub Issue Tracker
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://lists.apache.org/list.html?dev@skywalking.apache.org" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Dev Mailing List
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/licenses/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            License
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/events/current-event"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Apache Events
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/security/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Security
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/foundation/sponsorship.html"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Sponsorship and Donate
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/foundation/thanks.html"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Thanks
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</div>

    <script src="/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>









<script src="/js/main.min.dc00f5ca911ee5aa105ea6de6b3b7e8d8169ba5a3bf156b1fcfe23dfe3e62b0a.js" integrity="sha256-3AD1ypEe5aoQXqbeazt&#43;jYFpulo78Vax/P4j3&#43;PmKwo=" crossorigin="anonymous"></script>


<script src="/js/mermaid.min.js"></script>
<script>
    window.onload = () => mermaid.init(undefined, ".language-mermaid");
</script>


<script defer
src="https://widget.kapa.ai/kapa-widget.bundle.js"
data-website-id="8a08392b-9c4d-4816-8bc4-f93e0ecdd2a7"
data-project-name="SkyWalking"
data-project-color="#2B74B8"
data-button-text="Ask AI"
data-search-mode-enabled="true"
data-modal-open-on-command-k="true"
data-modal-disclaimer="The AI supports multiple languages, but it may not be accessible in China, a proxy is required."
data-project-logo="https://miro.medium.com/v2/resize:fit:2400/0*kmS-5BQ8ShAhZ_F4.jpg"
data-modal-example-questions="What is Apache SkyWalking?,How to deploy SkyWalking?,How to inject agents non-intrusively?,How to setup trace sampling?"
data-button-position-top=""
data-button-position-right="20px"
data-button-position-bottom="200px"
data-button-position-left=""
></script>




  </body>
  <script>
    $(function (){
      $('.doc-menu-button').on('click',function (){
        $('.td-sidebar').toggleClass('active')
      })
      $('.version-select').on('change', function (){
        var selectVersion = $(this).val().toLowerCase();
        var prefix = '';
        var url = location.href.replace(/(\/docs\/[a-zA-Z\-]+\/)([\w|\.]+)(\/.*)/, function (match, p1, p2, p3){
          prefix = p1 + selectVersion;
          return p1 + selectVersion + p3
        })
        go2SelectVersion(url, prefix)

      })
      function go2SelectVersion(url, prefix){
        $.ajax({
          url: url,
          type: "get",
          success:function(){
            location.href = url;
          },
          statusCode: {
            404:function(){
              location.href = prefix + '/readme/';
            }
          }
        });
      }
    })
  </script>
</html>
