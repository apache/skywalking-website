<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="twitter:site" content="skywalking.apache.org">
<meta name="twitter:image:src" content="https://skywalking.apache.org/images/skywalking_400x400.png">
<meta property="og:image" content="https://skywalking.apache.org/images/skywalking_400x400.png">

<meta name="generator" content="Hugo 0.80.0" />


<script async src="https://www.googletagmanager.com/gtag/js?id=G-GR8N6PGRJ3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);};
  gtag('js', new Date());gtag('config', 'G-GR8N6PGRJ3');
</script>
<META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
<link rel="stylesheet" href="//at.alicdn.com/t/c/font_3007530_pvozs1rz2wn.css">



<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
<link rel="manifest" href="/favicons/site.webmanifest">
<link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<title>Plugin Development Guide | Apache SkyWalking</title><meta property="og:title" content="Plugin Development Guide" />
<meta property="og:description" content="Plugin Development Guide This document describes how to understand, develop and contribute a plugin.
There are 2 kinds of plugin:
 Tracing plugin. Follow the distributed tracing concept to collect spans with tags and logs. Meter plugin. Collect numeric metrics in Counter, Gauge, and Histogram formats.  We also provide the plugin test tool to verify the data collected and reported by the plugin. If you plan to contribute any plugin to our main repo, the data would be verified by this tool too." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/java-plugin-development-guide/" />

<meta itemprop="name" content="Plugin Development Guide">
<meta itemprop="description" content="Plugin Development Guide This document describes how to understand, develop and contribute a plugin.
There are 2 kinds of plugin:
 Tracing plugin. Follow the distributed tracing concept to collect spans with tags and logs. Meter plugin. Collect numeric metrics in Counter, Gauge, and Histogram formats.  We also provide the plugin test tool to verify the data collected and reported by the plugin. If you plan to contribute any plugin to our main repo, the data would be verified by this tool too.">

<meta itemprop="wordCount" content="3545">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Plugin Development Guide"/>
<meta name="twitter:description" content="Plugin Development Guide This document describes how to understand, develop and contribute a plugin.
There are 2 kinds of plugin:
 Tracing plugin. Follow the distributed tracing concept to collect spans with tags and logs. Meter plugin. Collect numeric metrics in Counter, Gauge, and Histogram formats.  We also provide the plugin test tool to verify the data collected and reported by the plugin. If you plan to contribute any plugin to our main repo, the data would be verified by this tool too."/>



<link rel="preload" href="/scss/main.min.592235942cb3c9f3dd697382a4e7a1fad8e1c182dad2841bdce6b43b4a346ae8.css" as="style">
<link href="/scss/main.min.592235942cb3c9f3dd697382a4e7a1fad8e1c182dad2841bdce6b43b4a346ae8.css" rel="stylesheet" integrity="">



<link rel="stylesheet" href="/css/docSearch.css" />


<script src="/js/jquery-3.6.0.min.js"></script>





    <title>Plugin Development Guide | Apache SkyWalking</title>
  </head>
  <body class="td-page  project-doc">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand  flex-column flex-md-row td-navbar">
    <div class="sidebar-button">
      <i class="iconfont icon-menu"></i>
    </div>
    <a class="navbar-brand" href="/">
        <span class="navbar-logo"><img width="130" src="/images/logo.svg" alt="SkyWalking"></span> 
    </a>
    <div class="td-navbar-nav-scroll navbar-nav-wrapper" id="navigation">
        <ul class="navbar-nav mt-lg-0">
             
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/docs" ><span>Projects and Docs</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/events" ><span>Events</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/blog" ><span>Blogs</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/downloads" ><span>Downloads</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/team" ><span>Team</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/users" ><span>Users</span></a>
			</li>
            
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
                <span class="link dropdown blog">
                    <a class="link-name nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">中文资料</a>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="/zh/">博客</a>
                        <a class="dropdown-item" href="https://space.bilibili.com/390683219" target="_blank" rel="noopener noreferrer">
                            B站
                        </a>
                        <a class="dropdown-item" href="https://juejin.cn/user/13673577331607" target="_blank" rel="noopener noreferrer">
                            掘金
                        </a>
                    </div>
                </span>
            </li>

            
			
        </ul>
    </div>
    <div class="navbar-nav d-none d-lg-block search-input-box">
         
            
        
            
        
            
        
            
        
            
        
            
        
            
            <span class="link dropdown">
                <a class="link-name dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Links
                </a>
                <div class="dropdown-menu">
                    
                    <a class="dropdown-item" href="http://www.apache.org/">Apache Software Foundation</a> 
                    <a class="dropdown-item" href="https://github.com/apache/skywalking/issues">GitHub Issue Tracker</a> 
                    <a class="dropdown-item" href="https://github.com/apache/skywalking/discussions">Discussion</a> 
                    <a class="dropdown-item" href="https://lists.apache.org/list.html?dev@skywalking.apache.org">Dev Mailing List</a> 
                    <a class="dropdown-item" href="https://cwiki.apache.org/confluence/display/SKYWALKING/Home">WIKI</a> 
                    <a class="dropdown-item" href="http://www.apache.org/licenses/">License</a> 
                    <a class="dropdown-item" href="http://www.apache.org/events/current-event">Apache Events</a> 
                    <a class="dropdown-item" href="http://www.apache.org/security/">Security</a> 
                    <a class="dropdown-item" href="http://www.apache.org/foundation/sponsorship.html">Sponsor and Donate</a> 
                    <a class="dropdown-item" href="http://www.apache.org/foundation/thanks.html">Thanks</a> 
                    <a class="dropdown-item" href="https://apache.org/foundation/policies/privacy.html">Privacy</a> 
                </div>
            </span>
            
        
        
<div id="docsearch"></div>


    </div>
</nav>

    </header>
    <div class="container-fluid td-outer">

      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 d-print-none scroll-bar td-sidebar">













                  <div class="description-wrapper">
                    <h5>
                    <img width="26" height="26" src="/images/project/java-agent.svg">
                    Java Agent
                    </h5>
                    <p>The Java Agent for Apache SkyWalking, which provides the native tracing/metrics/logging/event/profiling abilities for Java projects.</p>
                  </div>
                  
                  <div class="version-wrapper">Version: 
                  <select class="version-select">
                  
                    
                    
                    <option ZgotmplZ value="next">
                    
                      next
                    
                    </option>
                  
                    
                    
                    <option selected value="latest">
                    
                      latest
                    
                    </option>
                  
                    
                    
                    <option ZgotmplZ value="v9.1.0">
                    
                      v9.1.0
                    
                    </option>
                  
                    
                    
                    <option ZgotmplZ value="v9.0.0">
                    
                      v9.0.0
                    
                    </option>
                  
                    
                    
                    <option ZgotmplZ value="v8.16.0">
                    
                      v8.16.0
                    
                    </option>
                  
                    
                    
                    <option ZgotmplZ value="v8.15.0">
                    
                      v8.15.0
                    
                    </option>
                  
                    
                    
                    <option ZgotmplZ value="v8.14.0">
                    
                      v8.14.0
                    
                    </option>
                  
                  </select>
                  </div>
                  
                  <ul class="sidebar-menu">
    
    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/readme">Java Agent Setup</a>
        
    </li>
    
    <li>
        
            
            <a href="#">Container Environment<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/containerization#docker">Setup in Docker</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/containerization#kubernetes">Setup in Kubernetes</a>
        
    </li>

    

</ul>

        
    </li>
    
    <li>
        
            
            <a href="#">Advanced Features<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/advanced-features">Guidance</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/setting-override">Setting Override</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/tls">Transport Layer Security (TLS)</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/token-auth">Token Authentication</a>
        
    </li>

    

    <li>
        

            
            <a href="#">Manual APIs<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        

            
            <a href="#">Tracing APIs<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/application-toolkit-dependency">Add Trace Toolkit Dependencies</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/application-toolkit-tracer">Use Native Tracer</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/application-toolkit-trace-read-context">Read Tracing Context</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/application-toolkit-trace-annotation">Annotations</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/application-toolkit-trace-correlation-context">Use Correlation Context</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/application-toolkit-trace-cross-thread">Across Thread Solution</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/opentracing">OpenTracing (Deprecated)</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/application-toolkit-meter">Meter APIs</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/application-toolkit-micrometer">Micrometer Registry</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/application-toolkit-micrometer-1.10">Micrometer 1.10 Observation</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/application-toolkit-webflux">Webflux Tracing Assistant APIs</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/application-toolkit-kafka">Kafka Tracing Assistant APIs</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/how-to-tolerate-exceptions">Tolerate Custom Exceptions</a>
        
    </li>

    

    <li>
        

            
            <a href="#">Log &amp; Trace Correlation<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/application-toolkit-log4j-1.x">Log4j</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/application-toolkit-log4j-2.x">Log4j2</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/application-toolkit-logback-1.x/">Logback</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/logic-endpoint">Logic Endpoint</a>
        
    </li>

    

</ul>

        
    </li>
    
    <li>
        
            
            <a href="#">Plugins<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/supported-list">Supported middleware, framework and library</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/optional-plugins">Optional Plugins</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/bootstrap-plugins">Bootstrap/JVM class plugin</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/configurations">Agent Configuration Properties</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/configuration-discovery">Dynamic Configurations</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/advanced-reporters">Advanced reporters</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/setup/service-agent/java-agent/java-plugin-development-guide/">Plugin development guide</a>
        
    </li>

    

    <li>
        
            <a href="https://skyapmtest.github.io/Agent-Benchmarks/">Java Agent Performance Test</a>
        
    </li>

    

</ul>

        
    </li>
    
    <li>
        
            
            <a href="#">FAQs<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/faq/ext-dirs">Why is java.ext.dirs not supported?</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/faq/osgi">How to make SkyWalking agent works in `OSGI` environment?</a>
        
    </li>

    

</ul>

        
    </li>
    
    <li>
        
            
            <a href="#">Contribution<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/contribution/compiling/">Compiling Guidance</a>
        
    </li>

    

    <li>
        
            <a href="/docs/skywalking-java/latest/en/contribution/release-java-agent/">Java Agent Release Guidance</a>
        
    </li>

    

</ul>

        
    </li>
    
    <li>
        
            <a href="https://github.com/apache/skywalking-java/tree/master/changes">Changelog</a>
        
    </li>
    
</ul>
<script src="/js/sidebar-menu.js"></script>
<script>
  (function (){
    $.sidebarMenu($('.sidebar-menu'))
    var path = window.location.pathname;
    var hash = window.location.hash;
    var $a = $('.sidebar-menu a')
    $a.each(function (e){
      if($(this).attr('href')+'/' === path || $(this).attr('href').replace('#','/#') === path+hash){
        $(this).parents('li').addClass('active').show()
      }
    })
    $a.on('click',function (){
      var url = $(this).attr('href')
      if(url!=='#'){
        window.location.href = url
      }
    })
  })()
</script>

                  <div class="commit-id">Commit Id: bf18ab1</div>
                






























</div>
            <main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role="main">
              <i class="iconfont icon-menu-doc doc-menu-button"></i>
              
<div class="td-content">











	<h1 id="plugin-development-guide">Plugin Development Guide</h1>
<p>This document describes how to understand, develop and contribute a plugin.</p>
<p>There are 2 kinds of plugin:</p>
<ol>
<li><a href="#tracing-plugin">Tracing plugin</a>. Follow the distributed tracing concept to collect spans with tags and logs.</li>
<li><a href="#meter-plugin">Meter plugin</a>. Collect numeric metrics in Counter, Gauge, and Histogram formats.</li>
</ol>
<p>We also provide the <a href="#plugin-test-tool">plugin test tool</a> to verify the data collected and reported by the plugin. If you plan to contribute any plugin to our main repo, the data would be verified by this tool too.</p>
<h1 id="tracing-plugin">Tracing plugin</h1>
<h2 id="concepts">Concepts</h2>
<h3 id="span">Span</h3>
<p>The span is an important and recognized concept in the distributed tracing system. Learn about the <strong>span</strong> from the
<a href="https://research.google.com/pubs/pub36356.html">Google Dapper Paper</a>  and
<a href="http://opentracing.io">OpenTracing</a></p>
<p>SkyWalking has supported OpenTracing and OpenTracing-Java API since 2017. Our concepts of the span are similar to that of the Google Dapper Paper and OpenTracing. We have also extended the span.</p>
<p>There are three types of span:</p>
<p>1.1 EntrySpan
The EntrySpan represents a service provider. It is also an endpoint on the server end. As an APM system, our target is the
application servers. Therefore, almost all the services and MQ-consumers are EntrySpan.</p>
<p>1.2 LocalSpan
The LocalSpan represents a normal Java method that does not concern remote services. It is neither a MQ producer/consumer
nor a service (e.g. HTTP service) provider/consumer.</p>
<p>1.3 ExitSpan
The ExitSpan represents a client of service or MQ-producer. It is named the <code>LeafSpan</code> in the early versions of SkyWalking.
For example, accessing DB through JDBC and reading Redis/Memcached are classified as an ExitSpan.</p>
<h3 id="contextcarrier">ContextCarrier</h3>
<p>In order to implement distributed tracing, cross-process tracing has to be bound, and the context must propagate
across the process. This is where the ContextCarrier comes in.</p>
<p>Here are the steps on how to use the <strong>ContextCarrier</strong> in an <code>A-&gt;B</code> distributed call.</p>
<ol>
<li>Create a new and empty <code>ContextCarrier</code> on the client end.</li>
<li>Create an ExitSpan by <code>ContextManager#createExitSpan</code> or use <code>ContextManager#inject</code> to initalize the <code>ContextCarrier</code>.</li>
<li>Place all items of <code>ContextCarrier</code> into heads (e.g. HTTP HEAD), attachments (e.g. Dubbo RPC framework) or messages (e.g. Kafka).</li>
<li>The <code>ContextCarrier</code> propagates to the server end through the service call.</li>
<li>On the server end, obtain all items from the heads, attachments or messages.</li>
<li>Create an EntrySpan by <code>ContextManager#createEntrySpan</code> or use <code>ContextManager#extract</code> to bind the client and server ends.</li>
</ol>
<p>See the following examples, where we use the Apache HTTPComponent client plugin and Tomcat 7 server plugin:</p>
<ol>
<li>Using the Apache HTTPComponent client plugin on the client end</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">            span <span style="color:#000;font-weight:bold">=</span> ContextManager<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">createExitSpan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;/span/operation/name&#34;</span><span style="color:#000;font-weight:bold">,</span> contextCarrier<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;ip:port&#34;</span><span style="color:#000;font-weight:bold">);</span>
            CarrierItem next <span style="color:#000;font-weight:bold">=</span> contextCarrier<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">items</span><span style="color:#000;font-weight:bold">();</span>
            <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span>next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hasNext</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
                next <span style="color:#000;font-weight:bold">=</span> next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">();</span>
                httpRequest<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setHeader</span><span style="color:#000;font-weight:bold">(</span>next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHeadKey</span><span style="color:#000;font-weight:bold">(),</span> next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHeadValue</span><span style="color:#000;font-weight:bold">());</span>
            <span style="color:#000;font-weight:bold">}</span>
</code></pre></div><ol start="2">
<li>Using the Tomcat 7 server plugin on the server end</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">            ContextCarrier contextCarrier <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ContextCarrier<span style="color:#000;font-weight:bold">();</span>
            CarrierItem next <span style="color:#000;font-weight:bold">=</span> contextCarrier<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">items</span><span style="color:#000;font-weight:bold">();</span>
            <span style="color:#000;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">(</span>next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">hasNext</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#000;font-weight:bold">{</span>
                next <span style="color:#000;font-weight:bold">=</span> next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">next</span><span style="color:#000;font-weight:bold">();</span>
                next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">setHeadValue</span><span style="color:#000;font-weight:bold">(</span>request<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHeader</span><span style="color:#000;font-weight:bold">(</span>next<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getHeadKey</span><span style="color:#000;font-weight:bold">()));</span>
            <span style="color:#000;font-weight:bold">}</span>

            span <span style="color:#000;font-weight:bold">=</span> ContextManager<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">createEntrySpan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#a61717;background-color:#e3d2d2">“</span><span style="color:#000;font-weight:bold">/</span>span<span style="color:#000;font-weight:bold">/</span>operation<span style="color:#000;font-weight:bold">/</span>name<span style="color:#a61717;background-color:#e3d2d2">”</span><span style="color:#000;font-weight:bold">,</span> contextCarrier<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><h3 id="contextsnapshot">ContextSnapshot</h3>
<p>Besides cross-process tracing, cross-thread tracing has to be supported as well. For instance, both async process (in-memory MQ)
and batch process are common in Java. Cross-process and cross-thread tracing are very similar in that they both require propagating
context, except that cross-thread tracing does not require serialization.</p>
<p>Here are the three steps on cross-thread propagation:</p>
<ol>
<li>Use <code>ContextManager#capture</code> to get the ContextSnapshot object.</li>
<li>Let the sub-thread access the ContextSnapshot through method arguments or being carried by existing arguments</li>
<li>Use <code>ContextManager#continued</code> in sub-thread.</li>
</ol>
<h2 id="core-apis">Core APIs</h2>
<h3 id="contextmanager">ContextManager</h3>
<p>ContextManager provides all major and primary APIs.</p>
<ol>
<li>Create EntrySpan</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> AbstractSpan <span style="color:#900;font-weight:bold">createEntrySpan</span><span style="color:#000;font-weight:bold">(</span>String endpointName<span style="color:#000;font-weight:bold">,</span> ContextCarrier carrier<span style="color:#000;font-weight:bold">)</span>
</code></pre></div><p>Create EntrySpan according to the operation name (e.g. service name, uri) and <strong>ContextCarrier</strong>.</p>
<ol start="2">
<li>Create LocalSpan</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> AbstractSpan <span style="color:#900;font-weight:bold">createLocalSpan</span><span style="color:#000;font-weight:bold">(</span>String endpointName<span style="color:#000;font-weight:bold">)</span>
</code></pre></div><p>Create LocalSpan according to the operation name (e.g. full method signature).</p>
<ol start="3">
<li>Create ExitSpan</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> AbstractSpan <span style="color:#900;font-weight:bold">createExitSpan</span><span style="color:#000;font-weight:bold">(</span>String endpointName<span style="color:#000;font-weight:bold">,</span> ContextCarrier carrier<span style="color:#000;font-weight:bold">,</span> String remotePeer<span style="color:#000;font-weight:bold">)</span>
</code></pre></div><p>Create ExitSpan according to the operation name (e.g. service name, uri) and the new <strong>ContextCarrier</strong> and peer address
(e.g. ip+port, hostname+port).</p>
<h3 id="abstractspan">AbstractSpan</h3>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Set the component id, which defines in {@link ComponentsDefine}
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param component
</span><span style="color:#998;font-style:italic">     * @return the span for chaining.
</span><span style="color:#998;font-style:italic">     */</span>
    AbstractSpan <span style="color:#900;font-weight:bold">setComponent</span><span style="color:#000;font-weight:bold">(</span>Component component<span style="color:#000;font-weight:bold">);</span>

    AbstractSpan <span style="color:#900;font-weight:bold">setLayer</span><span style="color:#000;font-weight:bold">(</span>SpanLayer layer<span style="color:#000;font-weight:bold">);</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Set a key:value tag on the Span.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @return this Span instance, for chaining
</span><span style="color:#998;font-style:italic">     */</span>
    AbstractSpan <span style="color:#900;font-weight:bold">tag</span><span style="color:#000;font-weight:bold">(</span>String key<span style="color:#000;font-weight:bold">,</span> String value<span style="color:#000;font-weight:bold">);</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Record an exception event of the current walltime timestamp.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param t any subclass of {@link Throwable}, which occurs in this span.
</span><span style="color:#998;font-style:italic">     * @return the Span, for chaining
</span><span style="color:#998;font-style:italic">     */</span>
    AbstractSpan <span style="color:#900;font-weight:bold">log</span><span style="color:#000;font-weight:bold">(</span>Throwable t<span style="color:#000;font-weight:bold">);</span>

    AbstractSpan <span style="color:#900;font-weight:bold">errorOccurred</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Record an event at a specific timestamp.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param timestamp The explicit timestamp for the log record.
</span><span style="color:#998;font-style:italic">     * @param event the events
</span><span style="color:#998;font-style:italic">     * @return the Span, for chaining
</span><span style="color:#998;font-style:italic">     */</span>
    AbstractSpan <span style="color:#900;font-weight:bold">log</span><span style="color:#000;font-weight:bold">(</span><span style="color:#458;font-weight:bold">long</span> timestamp<span style="color:#000;font-weight:bold">,</span> Map<span style="color:#000;font-weight:bold">&lt;</span>String<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">?&gt;</span> event<span style="color:#000;font-weight:bold">);</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Sets the string name for the logical operation this span represents.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @return this Span instance, for chaining
</span><span style="color:#998;font-style:italic">     */</span>
    AbstractSpan <span style="color:#900;font-weight:bold">setOperationName</span><span style="color:#000;font-weight:bold">(</span>String endpointName<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>Besides setting the operation name, tags and logs, two attributes must be set, namely the component and layer. This is especially important for the EntrySpan and ExitSpan.</p>
<p>SpanLayer is the type of span. There are 5 values:</p>
<ol>
<li>UNKNOWN (default)</li>
<li>DB</li>
<li>RPC_FRAMEWORK (designed for the RPC framework, rather than an ordinary HTTP call)</li>
<li>HTTP</li>
<li>MQ</li>
</ol>
<p>Component IDs are defined and reserved by the SkyWalking project.
For extension of the component name/ID, please follow the OAP server <code>Component library settings</code> document.</p>
<h3 id="special-span-tags">Special Span Tags</h3>
<p>All tags are available in the trace view. Meanwhile, in the OAP backend analysis, some special tags or tag combinations provide other advanced features.</p>
<h4 id="tag-key-httpstatus_code">Tag key <code>http.status_code</code></h4>
<p>The value should be an integer. The response code of OAL entities corresponds to this value.</p>
<h4 id="tag-keys-dbstatement-and-dbtype">Tag keys <code>db.statement</code> and <code>db.type</code>.</h4>
<p>The value of <code>db.statement</code> should be a string that represents the database statement, such as SQL, or <code>[No statement]/</code>+span#operationName if the value is empty.
When the exit span contains this tag, OAP samples the slow statements based on <code>agent-analyzer/default/maxSlowSQLLength</code>.
The threshold of slow statement is defined in accordance with <code>agent-analyzer/default/slowDBAccessThreshold</code>.
Check <strong>Slow Database Statement</strong> document of OAP server for details.</p>
<h4 id="extension-logic-endpoint-tag-key-x-le">Extension logic endpoint: Tag key <code>x-le</code></h4>
<p>The logic endpoint is a concept that doesn&rsquo;t represent a real RPC call, but requires the statistic.
The value of <code>x-le</code> should be in JSON format. There are two options:</p>
<ol>
<li>Define a separated logic endpoint. Provide its own endpoint name, latency and status. Suitable for entry and local span.</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#000080">&#34;name&#34;</span>: <span style="color:#d14">&#34;GraphQL-service&#34;</span>,
  <span style="color:#000080">&#34;latency&#34;</span>: <span style="color:#099">100</span>,
  <span style="color:#000080">&#34;status&#34;</span>: <span style="color:#000;font-weight:bold">true</span>
}
</code></pre></div><ol start="2">
<li>Declare the current local span representing a logic endpoint.</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#000080">&#34;logic-span&#34;</span>: <span style="color:#000;font-weight:bold">true</span>
}
</code></pre></div><h4 id="virtual-database-relative-tags">Virtual Database Relative Tags</h4>
<p>SkyWalking analysis Database(SQL-like) performance metrics through the following tags.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> StringTag DB_TYPE <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> StringTag<span style="color:#000;font-weight:bold">(</span>3<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;db.type&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> StringTag DB_STATEMENT <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> StringTag<span style="color:#000;font-weight:bold">(</span>5<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;db.statement&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><ul>
<li><code>db.type</code> records database type, such as sql, cassandra, Elasticsearch.</li>
<li><code>db.statement</code>records the sql statement of the database access.</li>
</ul>
<p>Read <a href="https://skywalking.apache.org/docs/main/next/en/setup/service-agent/virtual-database/">backend&rsquo;s virtual database doc</a> for more details.</p>
<h4 id="virtual-cache-relative-tags">Virtual Cache Relative Tags</h4>
<p>SkyWalking analysis cache performance related metrics through the following tags.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> StringTag CACHE_TYPE <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> StringTag<span style="color:#000;font-weight:bold">(</span>15<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;cache.type&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> StringTag CACHE_CMD <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> StringTag<span style="color:#000;font-weight:bold">(</span>17<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;cache.cmd&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> StringTag CACHE_OP <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> StringTag<span style="color:#000;font-weight:bold">(</span>16<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;cache.op&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> StringTag CACHE_KEY <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> StringTag<span style="color:#000;font-weight:bold">(</span>18<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;cache.key&#34;</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><ul>
<li><code>cache.type</code> indicates the cache type , usually it&rsquo;s official name of cache (e.g. Redis)</li>
<li><code>cache.cmd</code>  indicates the cache command that would be sent to cache server (e.g. setnx)</li>
<li><code>cache.op</code>   indicates the command is used for <code>write</code> or <code>read</code> operation , usually the value is converting from <code>command</code></li>
<li><code>cache.key</code>  indicates the cache key that would be sent to cache server , this tag maybe null , as string type key would be collected usually.</li>
</ul>
<p>In order to decide which <code>op</code> should be converted to flexibly , It&rsquo;s better that providing config property .
Reference  <a href="https://github.com/apache/skywalking-java/blob/main/apm-sniffer/apm-sdk-plugin/jedis-plugins/jedis-4.x-plugin/src/main/java/org/apache/skywalking/apm/plugin/jedis/v4/JedisPluginConfig.java">Jedis-4.x-plugin</a></p>
<h4 id="virtual-message-queue-mq-relative-tags">Virtual Message Queue (MQ) Relative Tags</h4>
<p>SkyWalking analysis MQ performance related metrics through the following tags.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> StringTag MQ_QUEUE <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> StringTag<span style="color:#000;font-weight:bold">(</span>7<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;mq.queue&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> StringTag MQ_TOPIC <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> StringTag<span style="color:#000;font-weight:bold">(</span>9<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;mq.topic&#34;</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> StringTag TRANSMISSION_LATENCY <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> StringTag<span style="color:#000;font-weight:bold">(</span>15<span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;transmission.latency&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><ul>
<li><code>mq.queue</code>   indicates MQ queue name</li>
<li><code>mq.topic</code>   indicates MQ topic name , It&rsquo;s optional as some MQ don&rsquo;t hava concept of <code>topic</code></li>
<li><code>transmission.latency</code> The transmission latency from consumer to producer. Usually you needn&rsquo;t to record this tag manually, instead to call  <code>contextCarrier.extensionInjector().injectSendingTimestamp();</code> to record tag <code>sendingTimestamp</code> on producer side , and SkyWalking would record this tag on consumer side if <code>sw8-x</code> context carrier(from producer side) contains <code>sendingTimestamp</code></li>
</ul>
<p>Notice , you should set <code>peer</code> at both sides(producer and consumer). And the value of peer should represent the MQ server cluster.</p>
<h3 id="advanced-apis">Advanced APIs</h3>
<h4 id="async-span-apis">Async Span APIs</h4>
<p>There is a set of advanced APIs in Span which is specifically designed for async use cases. When tags, logs, and attributes (including end time) of the span need to be set in another thread, you should use these APIs.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * The span finish at current tracing context, but the current span is still alive, until {@link #asyncFinish}
</span><span style="color:#998;font-style:italic">     * called.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * This method must be called&lt;br/&gt;
</span><span style="color:#998;font-style:italic">     * 1. In original thread(tracing context).
</span><span style="color:#998;font-style:italic">     * 2. Current span is active span.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * During alive, tags, logs and attributes of the span could be changed, in any thread.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * The execution times of {@link #prepareForAsync} and {@link #asyncFinish()} must match.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @return the current span
</span><span style="color:#998;font-style:italic">     */</span>
    AbstractSpan <span style="color:#900;font-weight:bold">prepareForAsync</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * Notify the span, it could be finished.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * The execution times of {@link #prepareForAsync} and {@link #asyncFinish()} must match.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @return the current span
</span><span style="color:#998;font-style:italic">     */</span>
    AbstractSpan <span style="color:#900;font-weight:bold">asyncFinish</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><ol>
<li>Call <code>#prepareForAsync</code> in the original context.</li>
<li>Run <code>ContextManager#stopSpan</code> in the original context when your job in the current thread is complete.</li>
<li>Propagate the span to any other thread.</li>
<li>Once the above steps are all set, call <code>#asyncFinish</code> in any thread.</li>
<li>When <code>#prepareForAsync</code> is complete for all spans, the tracing context will be finished and will report to the backend (based on the count of API execution).</li>
</ol>
<h2 id="develop-a-plugin">Develop a plugin</h2>
<h3 id="abstract">Abstract</h3>
<p>The basic method to trace is to intercept a Java method, by using byte code manipulation tech and AOP concept.
SkyWalking has packaged the byte code manipulation tech and tracing context propagation,
so you simply have to define the intercept point (a.k.a. aspect pointcut in Spring).</p>
<h3 id="intercept">Intercept</h3>
<p>SkyWalking provides two common definitions to intercept constructor, instance method and class method.</p>
<h4 id="v1-apis">v1 APIs</h4>
<ul>
<li>Extend <code>ClassInstanceMethodsEnhancePluginDefine</code> to define <code>constructor</code> intercept points and <code>instance method</code> intercept points.</li>
<li>Extend <code>ClassStaticMethodsEnhancePluginDefine</code> to define <code>class method</code> intercept points.</li>
</ul>
<p>Of course, you can extend <code>ClassEnhancePluginDefine</code> to set all intercept points, although it is uncommon to do so.</p>
<h4 id="v2-apis">v2 APIs</h4>
<p>v2 APIs provide an enhanced interceptor, which could propagate context through MIC(MethodInvocationContext).</p>
<ul>
<li>Extend <code>ClassInstanceMethodsEnhancePluginDefineV2</code> to define <code>constructor</code> intercept points and <code>instance method</code> intercept points.</li>
<li>Extend <code>ClassStaticMethodsEnhancePluginDefineV2</code> to define <code>class method</code> intercept points.</li>
</ul>
<p>Of course, you can extend <code>ClassEnhancePluginDefineV2</code> to set all intercept points, although it is uncommon to do so.</p>
<h3 id="implement-plugin">Implement plugin</h3>
<p>See the following demonstration on how to implement a plugin by extending <code>ClassInstanceMethodsEnhancePluginDefine</code>.</p>
<ol>
<li>Define the target class name.</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">protected</span> <span style="color:#000;font-weight:bold">abstract</span> ClassMatch <span style="color:#900;font-weight:bold">enhanceClass</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><p>ClassMatch represents how to match the target classes. There are 4 ways:</p>
<ul>
<li><code>byName</code>: Based on the full class names (package name + <code>.</code> + class name).</li>
<li><code>byClassAnnotationMatch</code>: Depends on whether there are certain annotations in the target classes.</li>
<li><code>byMethodAnnotationMatch</code>: Depends on whether there are certain annotations in the methods of the target classes.</li>
<li><code>byHierarchyMatch</code>: Based on the parent classes or interfaces of the target classes.</li>
</ul>
<p><strong>Attention</strong>:</p>
<ul>
<li>Never use <code>ThirdPartyClass.class</code> in the instrumentation definitions, such as <code>takesArguments(ThirdPartyClass.class)</code>, or <code>byName(ThirdPartyClass.class.getName())</code>, because of the fact that <code>ThirdPartyClass</code> dose not necessarily exist in the target application and this will break the agent; we have <code>import</code> checks to assist in checking this in CI, but it doesn&rsquo;t cover all scenarios of this limitation, so never try to work around this limitation by something like using full-qualified-class-name (FQCN), i.e. <code>takesArguments(full.qualified.ThirdPartyClass.class)</code> and <code>byName(full.qualified.ThirdPartyClass.class.getName())</code> will pass the CI check, but are still invalid in the agent codes. Therefore, <strong>Use Full Qualified Class Name String Literature Instead</strong>.</li>
<li>Even if you are perfectly sure that the class to be intercepted exists in the target application (such as JDK classes), still, do not use <code>*.class.getName()</code> to get the class String name. We recommend you to use a literal string. This is to avoid ClassLoader issues.</li>
<li><code>by*AnnotationMatch</code> does not support inherited annotations.</li>
<li>We do not recommend using <code>byHierarchyMatch</code> unless necessary. Using it may trigger the interception of
many unexcepted methods, which would cause performance issues.</li>
</ul>
<p>Example：</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#3c5d5d;font-weight:bold">@Override</span>
<span style="color:#000;font-weight:bold">protected</span> ClassMatch <span style="color:#900;font-weight:bold">enhanceClassName</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">return</span> byName<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;org.apache.catalina.core.StandardEngineValve&#34;</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>

</code></pre></div><ol start="2">
<li>Define an instance method intercept point.</li>
</ol>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> InstanceMethodsInterceptPoint<span style="color:#000;font-weight:bold">[]</span> <span style="color:#900;font-weight:bold">getInstanceMethodsInterceptPoints</span><span style="color:#000;font-weight:bold">();</span>

<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">InstanceMethodsInterceptPoint</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * class instance methods matcher.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @return methods matcher
</span><span style="color:#998;font-style:italic">     */</span>
    ElementMatcher<span style="color:#000;font-weight:bold">&lt;</span>MethodDescription<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">getMethodsMatcher</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * @return represents a class name, the class instance must instanceof InstanceMethodsAroundInterceptor.
</span><span style="color:#998;font-style:italic">     */</span>
    String <span style="color:#900;font-weight:bold">getMethodsInterceptor</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isOverrideArgs</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>You may also use <code>Matcher</code> to set the target methods. Return <strong>true</strong> in <code>isOverrideArgs</code>, if you want to change the argument
ref in interceptor.
Please refer to <a href="https://bytebuddy.net/#/">bytebuddy</a> for details of defining <code>ElementMatcher</code>.</p>
<p>In Skywalking, we provide 3 classes to facilitate <code>ElementMatcher</code> definition:</p>
<ul>
<li><code>AnnotationTypeNameMatch</code>: Check on whether there is a certain annotation in the target method.</li>
<li><code>ReturnTypeNameMatch</code>: Check the return type name (package name + <code>.</code> + class name) of the target method.</li>
<li><code>ArgumentTypeNameMatch</code>: Check on the argument index and the type name (package name + <code>.</code> + class name) of the target method.</li>
</ul>
<p><strong>Attention</strong>:</p>
<ul>
<li>In case of using <code>ReturnTypeNameMatch</code> and <code>ArgumentTypeNameMatch</code>, use [Lxxx; (Java file format defined in <a href="https://docs.oracle.com/javase/specs/jvms/se8/html/">JVM Specification</a>) to define an Array type. For example, you should write <code>[Ljava.lang.String;</code> for <code>java.lang.String[]</code>.</li>
</ul>
<p>The following sections will tell you how to implement the interceptor.</p>
<ol start="3">
<li>Add plugin definition into the <code>skywalking-plugin.def</code> file.</li>
</ol>
<pre><code class="language-properties" data-lang="properties">tomcat-7.x/8.x=TomcatInstrumentation
</code></pre><ol start="4">
<li>
<p>Set up <code>witnessClasses</code> and/or <code>witnessMethods</code> if the instrumentation has to be activated in specific versions.</p>
<p>Example:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">// The plugin is activated only when the foo.Bar class exists.
</span><span style="color:#998;font-style:italic"></span><span style="color:#3c5d5d;font-weight:bold">@Override</span>
<span style="color:#000;font-weight:bold">protected</span> String<span style="color:#000;font-weight:bold">[]</span> <span style="color:#900;font-weight:bold">witnessClasses</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> String<span style="color:#000;font-weight:bold">[]</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#d14">&#34;foo.Bar&#34;</span>
  <span style="color:#000;font-weight:bold">};</span>
<span style="color:#000;font-weight:bold">}</span>

<span style="color:#998;font-style:italic">// The plugin is activated only when the foo.Bar#hello method exists.
</span><span style="color:#998;font-style:italic"></span><span style="color:#3c5d5d;font-weight:bold">@Override</span>
<span style="color:#000;font-weight:bold">protected</span> List<span style="color:#000;font-weight:bold">&lt;</span>WitnessMethod<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">witnessMethods</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
  List<span style="color:#000;font-weight:bold">&lt;</span>WitnessMethod<span style="color:#000;font-weight:bold">&gt;</span> witnessMethodList <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> ArrayList<span style="color:#000;font-weight:bold">&lt;&gt;();</span>
  WitnessMethod witnessMethod <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">new</span> WitnessMethod<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;foo.Bar&#34;</span><span style="color:#000;font-weight:bold">,</span> ElementMatchers<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">named</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;hello&#34;</span><span style="color:#000;font-weight:bold">));</span>
  witnessMethodList<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">add</span><span style="color:#000;font-weight:bold">(</span>witnessMethod<span style="color:#000;font-weight:bold">);</span>
  <span style="color:#000;font-weight:bold">return</span> witnessMethodList<span style="color:#000;font-weight:bold">;</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>For more examples, see <a href="https://github.com/apache/skywalking-java/tree/bf18ab1496c253cffb3663f4228e2d63586b30ed/apm-sniffer/apm-agent-core/src/test/java/org/apache/skywalking/apm/agent/core/plugin/witness/WitnessTest.java">WitnessTest.java</a></p>
</li>
</ol>
<h3 id="implement-an-interceptor">Implement an interceptor</h3>
<p>As an interceptor for an instance method, it has to implement
<code>org.apache.skywalking.apm.agent.core.plugin.interceptor.enhance.InstanceMethodsAroundInterceptor</code></p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic"> * A interceptor, which intercept method&#39;s invocation. The target methods will be defined in {@link
</span><span style="color:#998;font-style:italic"> * ClassEnhancePluginDefine}&#39;s subclass, most likely in {@link ClassInstanceMethodsEnhancePluginDefine}
</span><span style="color:#998;font-style:italic">*/</span>
<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">InstanceMethodsAroundInterceptor</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * called before target method invocation.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param result change this result, if you want to truncate the method.
</span><span style="color:#998;font-style:italic">     * @throws Throwable
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">beforeMethod</span><span style="color:#000;font-weight:bold">(</span>EnhancedInstance objInst<span style="color:#000;font-weight:bold">,</span> Method method<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">[]</span> allArguments<span style="color:#000;font-weight:bold">,</span> Class<span style="color:#000;font-weight:bold">&lt;?&gt;[]</span> argumentsTypes<span style="color:#000;font-weight:bold">,</span>
        MethodInterceptResult result<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Throwable<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * called after target method invocation. Even method&#39;s invocation triggers an exception.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param ret the method&#39;s original return value.
</span><span style="color:#998;font-style:italic">     * @return the method&#39;s actual return value.
</span><span style="color:#998;font-style:italic">     * @throws Throwable
</span><span style="color:#998;font-style:italic">     */</span>
    Object <span style="color:#900;font-weight:bold">afterMethod</span><span style="color:#000;font-weight:bold">(</span>EnhancedInstance objInst<span style="color:#000;font-weight:bold">,</span> Method method<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">[]</span> allArguments<span style="color:#000;font-weight:bold">,</span> Class<span style="color:#000;font-weight:bold">&lt;?&gt;[]</span> argumentsTypes<span style="color:#000;font-weight:bold">,</span>
        Object ret<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Throwable<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * called when occur exception.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param t the exception occur.
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">handleMethodException</span><span style="color:#000;font-weight:bold">(</span>EnhancedInstance objInst<span style="color:#000;font-weight:bold">,</span> Method method<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">[]</span> allArguments<span style="color:#000;font-weight:bold">,</span> Class<span style="color:#000;font-weight:bold">&lt;?&gt;[]</span> argumentsTypes<span style="color:#000;font-weight:bold">,</span>
        Throwable t<span style="color:#000;font-weight:bold">);</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p>Use the core APIs before and after calling the method, as well as during exception handling.</p>
<h4 id="v2-apis-1">V2 APIs</h4>
<p>The interceptor of V2 API uses <code>MethodInvocationContext context</code> to replace the <code>MethodInterceptResult result</code> in the <code>beforeMethod</code>,
and be added as a new parameter in <code>afterMethod</code> and <code>handleMethodException</code>.</p>
<p><code>MethodInvocationContext context</code> is only shared in one time execution, and safe to use when face concurrency execution.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic"> * A v2 interceptor, which intercept method&#39;s invocation. The target methods will be defined in {@link
</span><span style="color:#998;font-style:italic"> * ClassEnhancePluginDefineV2}&#39;s subclass, most likely in {@link ClassInstanceMethodsEnhancePluginDefine}
</span><span style="color:#998;font-style:italic"> */</span>
<span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">interface</span> <span style="color:#458;font-weight:bold">InstanceMethodsAroundInterceptorV2</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * called before target method invocation.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param context the method invocation context including result context.
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">beforeMethod</span><span style="color:#000;font-weight:bold">(</span>EnhancedInstance objInst<span style="color:#000;font-weight:bold">,</span> Method method<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">[]</span> allArguments<span style="color:#000;font-weight:bold">,</span> Class<span style="color:#000;font-weight:bold">&lt;?&gt;[]</span> argumentsTypes<span style="color:#000;font-weight:bold">,</span>
                      MethodInvocationContext context<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Throwable<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * called after target method invocation. Even method&#39;s invocation triggers an exception.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param ret the method&#39;s original return value. May be null if the method triggers an exception.
</span><span style="color:#998;font-style:italic">     * @return the method&#39;s actual return value.
</span><span style="color:#998;font-style:italic">     */</span>
    Object <span style="color:#900;font-weight:bold">afterMethod</span><span style="color:#000;font-weight:bold">(</span>EnhancedInstance objInst<span style="color:#000;font-weight:bold">,</span> Method method<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">[]</span> allArguments<span style="color:#000;font-weight:bold">,</span> Class<span style="color:#000;font-weight:bold">&lt;?&gt;[]</span> argumentsTypes<span style="color:#000;font-weight:bold">,</span>
                       Object ret<span style="color:#000;font-weight:bold">,</span> MethodInvocationContext context<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">throws</span> Throwable<span style="color:#000;font-weight:bold">;</span>

    <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">     * called when occur exception.
</span><span style="color:#998;font-style:italic">     *
</span><span style="color:#998;font-style:italic">     * @param t the exception occur.
</span><span style="color:#998;font-style:italic">     */</span>
    <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">handleMethodException</span><span style="color:#000;font-weight:bold">(</span>EnhancedInstance objInst<span style="color:#000;font-weight:bold">,</span> Method method<span style="color:#000;font-weight:bold">,</span> Object<span style="color:#000;font-weight:bold">[]</span> allArguments<span style="color:#000;font-weight:bold">,</span>
                               Class<span style="color:#000;font-weight:bold">&lt;?&gt;[]</span> argumentsTypes<span style="color:#000;font-weight:bold">,</span> Throwable t<span style="color:#000;font-weight:bold">,</span> MethodInvocationContext context<span style="color:#000;font-weight:bold">);</span>

<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h3 id="bootstrap-class-instrumentation">Bootstrap class instrumentation.</h3>
<p>SkyWalking has packaged the bootstrap instrumentation in the agent core. You can easily implement it by declaring it in the instrumentation definition.</p>
<p>Override the <code>public boolean isBootstrapInstrumentation()</code> and return <strong>true</strong>. Such as</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">URLInstrumentation</span> <span style="color:#000;font-weight:bold">extends</span> ClassEnhancePluginDefine <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> String CLASS_NAME <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#34;java.net.URL&#34;</span><span style="color:#000;font-weight:bold">;</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span> <span style="color:#000;font-weight:bold">protected</span> ClassMatch <span style="color:#900;font-weight:bold">enhanceClass</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> byName<span style="color:#000;font-weight:bold">(</span>CLASS_NAME<span style="color:#000;font-weight:bold">);</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span> <span style="color:#000;font-weight:bold">public</span> ConstructorInterceptPoint<span style="color:#000;font-weight:bold">[]</span> <span style="color:#900;font-weight:bold">getConstructorsInterceptPoints</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> ConstructorInterceptPoint<span style="color:#000;font-weight:bold">[]</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#000;font-weight:bold">new</span> ConstructorInterceptPoint<span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
                <span style="color:#3c5d5d;font-weight:bold">@Override</span> <span style="color:#000;font-weight:bold">public</span> ElementMatcher<span style="color:#000;font-weight:bold">&lt;</span>MethodDescription<span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#900;font-weight:bold">getConstructorMatcher</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
                    <span style="color:#000;font-weight:bold">return</span> any<span style="color:#000;font-weight:bold">();</span>
                <span style="color:#000;font-weight:bold">}</span>

                <span style="color:#3c5d5d;font-weight:bold">@Override</span> <span style="color:#000;font-weight:bold">public</span> String <span style="color:#900;font-weight:bold">getConstructorInterceptor</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
                    <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;org.apache.skywalking.apm.plugin.jre.httpurlconnection.Interceptor2&#34;</span><span style="color:#000;font-weight:bold">;</span>
                <span style="color:#000;font-weight:bold">}</span>
            <span style="color:#000;font-weight:bold">}</span>
        <span style="color:#000;font-weight:bold">};</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span> <span style="color:#000;font-weight:bold">public</span> InstanceMethodsInterceptPoint<span style="color:#000;font-weight:bold">[]</span> <span style="color:#900;font-weight:bold">getInstanceMethodsInterceptPoints</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> InstanceMethodsInterceptPoint<span style="color:#000;font-weight:bold">[</span>0<span style="color:#000;font-weight:bold">];</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span> <span style="color:#000;font-weight:bold">public</span> StaticMethodsInterceptPoint<span style="color:#000;font-weight:bold">[]</span> <span style="color:#900;font-weight:bold">getStaticMethodsInterceptPoints</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">new</span> StaticMethodsInterceptPoint<span style="color:#000;font-weight:bold">[</span>0<span style="color:#000;font-weight:bold">];</span>
    <span style="color:#000;font-weight:bold">}</span>

    <span style="color:#3c5d5d;font-weight:bold">@Override</span> <span style="color:#000;font-weight:bold">public</span> <span style="color:#458;font-weight:bold">boolean</span> <span style="color:#900;font-weight:bold">isBootstrapInstrumentation</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">true</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><p><code>ClassEnhancePluginDefineV2</code> is provided in v2 APIs, <code>#isBootstrapInstrumentation</code> works too.</p>
<p><strong>NOTE</strong>: Bootstrap instrumentation should be used only where necessary. During its actual execution, it mostly affects the JRE core(rt.jar). Defining it other than where necessary could lead to unexpected results or side effects.</p>
<h3 id="provide-custom-config-for-the-plugin">Provide custom config for the plugin</h3>
<p>The config could provide different behaviours based on the configurations. The SkyWalking plugin mechanism provides the configuration
injection and initialization system in the agent core.</p>
<p>Every plugin could declare one or more classes to represent the config by using <code>@PluginConfig</code> annotation. The agent core
could initialize this class' static field through System environments, System properties, and <code>agent.config</code> static file.</p>
<p>The <code>#root()</code> method in the <code>@PluginConfig</code> annotation requires declaring the root class for the initialization process.
Typically, SkyWalking prefers to use nested inner static classes for the hierarchy of the configuration.
We recommend using <code>Plugin</code>/<code>plugin-name</code>/<code>config-key</code> as the nested classes structure of the config class.</p>
<p><strong>NOTE</strong>: because of the Java ClassLoader mechanism, the <code>@PluginConfig</code> annotation should be added on the real class used in the interceptor codes.</p>
<p>In the following example, <code>@PluginConfig(root = SpringMVCPluginConfig.class)</code> indicates that initialization should
start with using <code>SpringMVCPluginConfig</code> as the root. Then, the config key of the attribute <code>USE_QUALIFIED_NAME_AS_ENDPOINT_NAME</code>
should be <code>plugin.springmvc.use_qualified_name_as_endpoint_name</code>.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SpringMVCPluginConfig</span> <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Plugin</span> <span style="color:#000;font-weight:bold">{</span>
        <span style="color:#998;font-style:italic">// NOTE, if move this annotation on the `Plugin` or `SpringMVCPluginConfig` class, it no longer has any effect.
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#3c5d5d;font-weight:bold">@PluginConfig</span><span style="color:#000;font-weight:bold">(</span>root <span style="color:#000;font-weight:bold">=</span> SpringMVCPluginConfig<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">SpringMVC</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">             * If true, the fully qualified method name will be used as the endpoint name instead of the request URL,
</span><span style="color:#998;font-style:italic">             * default is false.
</span><span style="color:#998;font-style:italic">             */</span>
            <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> USE_QUALIFIED_NAME_AS_ENDPOINT_NAME <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>

            <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">             * This config item controls that whether the SpringMVC plugin should collect the parameters of the
</span><span style="color:#998;font-style:italic">             * request.
</span><span style="color:#998;font-style:italic">             */</span>
            <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">boolean</span> COLLECT_HTTP_PARAMS <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span><span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>

        <span style="color:#3c5d5d;font-weight:bold">@PluginConfig</span><span style="color:#000;font-weight:bold">(</span>root <span style="color:#000;font-weight:bold">=</span> SpringMVCPluginConfig<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">class</span><span style="color:#000;font-weight:bold">)</span>
        <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Http</span> <span style="color:#000;font-weight:bold">{</span>
            <span style="color:#998;font-style:italic">/**
</span><span style="color:#998;font-style:italic">             * When either {@link Plugin.SpringMVC#COLLECT_HTTP_PARAMS} is enabled, how many characters to keep and send
</span><span style="color:#998;font-style:italic">             * to the OAP backend, use negative values to keep and send the complete parameters, NB. this config item is
</span><span style="color:#998;font-style:italic">             * added for the sake of performance
</span><span style="color:#998;font-style:italic">             */</span>
            <span style="color:#000;font-weight:bold">public</span> <span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">int</span> HTTP_PARAMS_LENGTH_THRESHOLD <span style="color:#000;font-weight:bold">=</span> 1024<span style="color:#000;font-weight:bold">;</span>
        <span style="color:#000;font-weight:bold">}</span>
    <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div><h1 id="meter-plugin">Meter Plugin</h1>
<p>Java agent plugin could use meter APIs to collect metrics for backend analysis.</p>
<ul>
<li><code>Counter</code> API represents a single monotonically increasing counter which automatically collects data and reports to the backend.
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.skywalking.apm.agent.core.meter.MeterFactory</span><span style="color:#000;font-weight:bold">;</span>

Counter counter <span style="color:#000;font-weight:bold">=</span> MeterFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">counter</span><span style="color:#000;font-weight:bold">(</span>meterName<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">tag</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;tagKey&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;tagValue&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">mode</span><span style="color:#000;font-weight:bold">(</span>Counter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">Mode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#008080">INCREMENT</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
counter<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">increment</span><span style="color:#000;font-weight:bold">(</span>1d<span style="color:#000;font-weight:bold">);</span>
</code></pre></div></li>
</ul>
<ol>
<li><code>MeterFactory.counter</code> creates a new counter builder with the meter name.</li>
<li><code>Counter.Builder.tag(String key, String value)</code> marks a tag key/value pair.</li>
<li><code>Counter.Builder.mode(Counter.Mode mode)</code> changes the counter mode. <code>RATE</code> mode means the reporting rate to the backend.</li>
<li><code>Counter.Builder.build()</code> builds a new <code>Counter</code> which is collected and reported to the backend.</li>
<li><code>Counter.increment(double count)</code> increment counts to the <code>Counter</code>. It could be a positive value.</li>
</ol>
<ul>
<li><code>Gauge</code> API represents a single numerical value.</li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.skywalking.apm.agent.core.meter.MeterFactory</span><span style="color:#000;font-weight:bold">;</span>

ThreadPoolExecutor threadPool <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">...;</span>
Gauge gauge <span style="color:#000;font-weight:bold">=</span> MeterFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">gauge</span><span style="color:#000;font-weight:bold">(</span>meterName<span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">-&gt;</span> threadPool<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">getActiveCount</span><span style="color:#000;font-weight:bold">()).</span><span style="color:#008080">tag</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;tagKey&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;tagValue&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><ol>
<li><code>MeterFactory.gauge(String name, Supplier&lt;Double&gt; getter)</code> creates a new gauge builder with the meter name and supplier function. This function must return a <code>double</code> value.</li>
<li><code>Gauge.Builder.tag(String key, String value)</code> marks a tag key/value pair.</li>
<li><code>Gauge.Builder.build()</code> builds a new <code>Gauge</code> which is collected and reported to the backend.</li>
</ol>
<ul>
<li><code>Histogram</code> API represents a summary sample observations with customized buckets.</li>
</ul>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#000;font-weight:bold">import</span> <span style="color:#555">org.apache.skywalking.apm.agent.core.meter.MeterFactory</span><span style="color:#000;font-weight:bold">;</span>

Histogram histogram <span style="color:#000;font-weight:bold">=</span> MeterFactory<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">histogram</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;test&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">tag</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;tagKey&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#d14">&#34;tagValue&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#008080">steps</span><span style="color:#000;font-weight:bold">(</span>Arrays<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">asList</span><span style="color:#000;font-weight:bold">(</span>1<span style="color:#000;font-weight:bold">,</span> 5<span style="color:#000;font-weight:bold">,</span> 10<span style="color:#000;font-weight:bold">)).</span><span style="color:#008080">minValue</span><span style="color:#000;font-weight:bold">(</span>0<span style="color:#000;font-weight:bold">).</span><span style="color:#008080">build</span><span style="color:#000;font-weight:bold">();</span>
histogram<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">addValue</span><span style="color:#000;font-weight:bold">(</span>3<span style="color:#000;font-weight:bold">);</span>
</code></pre></div><ol>
<li><code>MeterFactory.histogram(String name)</code> creates a new histogram builder with the meter name.</li>
<li><code>Histogram.Builder.tag(String key, String value)</code> marks a tag key/value pair.</li>
<li><code>Histogram.Builder.steps(List&lt;Double&gt; steps)</code> sets up the max values of every histogram buckets.</li>
<li><code>Histogram.Builder.minValue(double value)</code> sets up the minimal value of this histogram. Default is <code>0</code>.</li>
<li><code>Histogram.Builder.build()</code> builds a new <code>Histogram</code> which is collected and reported to the backend.</li>
<li><code>Histogram.addValue(double value)</code> adds value into the histogram, and automatically analyzes what bucket count needs to be incremented. Rule: count into [step1, step2).</li>
</ol>
<h1 id="plugin-test-tool">Plugin Test Tool</h1>
<p>The <a href="https://github.com/apache/skywalking-agent-test-tool">Apache SkyWalking Agent Test Tool Suite</a> is an incredibly useful test tool suite that is available in a wide variety of agent languages. It includes the mock collector and validator. The mock collector is a SkyWalking receiver, like the OAP server.</p>
<p>You could learn how to use this tool to test the plugin in <a href="../plugin-test">this doc</a>. This is a must if you want to contribute plugins to the SkyWalking official repo.</p>
<h1 id="contribute-plugins-to-the-apache-skywalking-repository">Contribute plugins to the Apache SkyWalking repository</h1>
<p>We welcome everyone to contribute their plugins.</p>
<p>Please follow these steps:</p>
<ol>
<li>Submit an issue for your plugin, including any supported versions.</li>
<li>Create sub modules under <code>apm-sniffer/apm-sdk-plugin</code> or <code>apm-sniffer/optional-plugins</code>, and the name should include supported library name and versions.</li>
<li>Follow this guide to develop. Make sure comments and test cases are provided.</li>
<li>Develop and test.</li>
<li>Provide the automatic test cases. Learn <code>how to write the plugin test case</code> from this <a href="../plugin-test">doc</a></li>
<li>Send a pull request and ask for review.</li>
<li>The plugin committers will approve your plugins, plugin CI-with-IT, e2e, and the plugin tests will be passed.</li>
<li>The plugin is accepted by SkyWalking.</li>
</ol>




</div>


            </main>
          <div id="toc" class="d-none d-xl-block col-xl-2 td-toc d-print-none">
            




<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">











</div>






<nav id="TableOfContents">
  <ul>
    <li><a href="#plugin-development-guide">Plugin Development Guide</a></li>
    <li><a href="#tracing-plugin">Tracing plugin</a>
      <ul>
        <li><a href="#concepts">Concepts</a>
          <ul>
            <li><a href="#span">Span</a></li>
            <li><a href="#contextcarrier">ContextCarrier</a></li>
            <li><a href="#contextsnapshot">ContextSnapshot</a></li>
          </ul>
        </li>
        <li><a href="#core-apis">Core APIs</a>
          <ul>
            <li><a href="#contextmanager">ContextManager</a></li>
            <li><a href="#abstractspan">AbstractSpan</a></li>
            <li><a href="#special-span-tags">Special Span Tags</a></li>
            <li><a href="#advanced-apis">Advanced APIs</a></li>
          </ul>
        </li>
        <li><a href="#develop-a-plugin">Develop a plugin</a>
          <ul>
            <li><a href="#abstract">Abstract</a></li>
            <li><a href="#intercept">Intercept</a></li>
            <li><a href="#implement-plugin">Implement plugin</a></li>
            <li><a href="#implement-an-interceptor">Implement an interceptor</a></li>
            <li><a href="#bootstrap-class-instrumentation">Bootstrap class instrumentation.</a></li>
            <li><a href="#provide-custom-config-for-the-plugin">Provide custom config for the plugin</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#meter-plugin">Meter Plugin</a></li>
    <li><a href="#plugin-test-tool">Plugin Test Tool</a></li>
    <li><a href="#contribute-plugins-to-the-apache-skywalking-repository">Contribute plugins to the Apache SkyWalking repository</a></li>
  </ul>
</nav>




<script>
  $(function () {
    var $toc = $("#TableOfContents");
    if (!$toc || !$toc.length) {
      return;
    }
    var top = $toc.offset().top;
    $(window).on("scroll", debounce(setTop, 100))
    $(window).on("scroll", debounce(addActive, 30))

    function addActive() {
      var scrollValue = $(window).scrollTop();
      var topEle = null;
      $.each($('main h1, main h2, main h3'), function (index, item) {
        if ($(item).offset().top - 70 > scrollValue) {
          return
        }
        if (!topEle) {
          topEle = item
        } else if ($(item).offset().top >= $(topEle).offset().top) {
          topEle = item
        }
        if (topEle) {
          var id = $(item).attr('id');
          $toc.find('a').removeClass("active").end().find('a[href="' + '#' + id + '"]').addClass("active")
        }
      })
    }

    function setTop() {
      var scrollValue = $(window).scrollTop();
      if (scrollValue >= top - 70) {
        $toc.addClass('fixed')
      } else {
        $toc.removeClass('fixed')
      }
    }

    function debounce(fn, wait) {
      var timeout = null;
      return function () {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          fn.apply(this, arguments);
        }, wait);
      };
    }
  })

</script>

          </div>

        </div>
      </div>

      
<footer class="py-5 sky-row">
  <div class="container-fluid text-center">
    <div class="">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-color" target="_blank" href="https://twitter.com/asfskywalking">
      <i class="iconfont icon-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-color" target="_blank" href="http://s.apache.org/slack-invite">
      <i class="iconfont icon-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Mailing list" aria-label="Mailing list">
    <a class="text-color" target="_blank" href="https://lists.apache.org/list.html?dev@skywalking.apache.org">
      <i class="iconfont icon-email"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-color" target="_blank" href="https://github.com/apache/skywalking">
      <i class="iconfont icon-github"></i>
    </a>
  </li>
  
</ul>

        
        
    </div>
    <div class="">

        <small class="text-color">&copy; 2017 - 2024 The Apache Software Foundation All Rights Reserved</small>
        
	
    </div>
    <div class="">
      <small class="text-color mt-4">Apache SkyWalking, SkyWalking, Apache, the Apache feather logo, and the Apache SkyWalking project logo are either registered trademarks or trademarks of the Apache Software Foundation.</small>
    </div>
  </div>
</footer>


    </div>
    



















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































    
<div id="popup">
    <div class="mask">
        <img src=""/>
    </div>
</div>

    <div class="sidebar-mask"></div>
<div class="sidebar">
    <nav class="nav-links">
        <div class="nav-item"><a href="/docs/" class="nav-link">Projects and Documentation</a></div>
        <div class="nav-item"><a href="/events/" class="nav-link">Events</a></div>
        <div class="nav-item"><a href="/blog/" class="nav-link router-link-exact-active router-link-active">Blog</a>
        </div>
        <div class="nav-item"><a href="/downloads/" class="nav-link">Downloads</a></div>
        <div class="nav-item"><a href="/team/" class="nav-link">Team</a></div>
        <div class="nav-item"><a href="/users/" class="nav-link">Users</a></div>
        <div class="nav-item">
            <div class="dropdown-wrapper open">
                <a class="dropdown-title"><span>中文资料</span>
                    <span class="arrow down"></span>
                </a>
                <ul class="nav-dropdown">
                    <li class="dropdown-item">
                        <a href="/zh/" class="nav-link external">博客</a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://space.bilibili.com/390683219" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">B站</a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://juejin.cn/user/13673577331607" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">掘金</a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="nav-item">
            <div class="dropdown-wrapper open">
                <a class="dropdown-title">
                    <span>Links</span>
                    <span class="arrow down"></span>
                </a>
                <ul class="nav-dropdown">
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Apache Software Foundation
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://github.com/apache/skywalking/issues"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            GitHub Issue Tracker
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://lists.apache.org/list.html?dev@skywalking.apache.org" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Dev Mailing List
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/licenses/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            License
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/events/current-event"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Apache Events
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/security/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Security
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/foundation/sponsorship.html"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Sponsorship and Donate
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/foundation/thanks.html"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Thanks
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</div>

    <script src="/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>









<script src="/js/main.min.dc00f5ca911ee5aa105ea6de6b3b7e8d8169ba5a3bf156b1fcfe23dfe3e62b0a.js" integrity="sha256-3AD1ypEe5aoQXqbeazt&#43;jYFpulo78Vax/P4j3&#43;PmKwo=" crossorigin="anonymous"></script>


<script src="/js/mermaid.min.js"></script>
<script>
    window.onload = () => mermaid.init(undefined, ".language-mermaid");
</script>


<script defer
src="https://widget.kapa.ai/kapa-widget.bundle.js"
data-website-id="8a08392b-9c4d-4816-8bc4-f93e0ecdd2a7"
data-project-name="SkyWalking"
data-project-color="#2B74B8"
data-button-text="Ask AI"
data-search-mode-enabled="true"
data-modal-open-on-command-k="true"
data-modal-disclaimer="The AI supports multiple languages, but it may not be accessible in China, a proxy is required."
data-project-logo="https://miro.medium.com/v2/resize:fit:2400/0*kmS-5BQ8ShAhZ_F4.jpg"
data-modal-example-questions="What is Apache SkyWalking?,How to deploy SkyWalking?,How to inject agents non-intrusively?,How to setup trace sampling?"
data-button-position-top=""
data-button-position-right="20px"
data-button-position-bottom="200px"
data-button-position-left=""
></script>




  </body>
  <script>
    $(function (){
      $('.doc-menu-button').on('click',function (){
        $('.td-sidebar').toggleClass('active')
      })
      $('.version-select').on('change', function (){
        var selectVersion = $(this).val().toLowerCase();
        var prefix = '';
        var url = location.href.replace(/(\/docs\/[a-zA-Z\-]+\/)([\w|\.]+)(\/.*)/, function (match, p1, p2, p3){
          prefix = p1 + selectVersion;
          return p1 + selectVersion + p3
        })
        go2SelectVersion(url, prefix)

      })
      function go2SelectVersion(url, prefix){
        $.ajax({
          url: url,
          type: "get",
          success:function(){
            location.href = url;
          },
          statusCode: {
            404:function(){
              location.href = prefix + '/readme/';
            }
          }
        });
      }
    })
  </script>
</html>
