<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="twitter:site" content="skywalking.apache.org">
<meta name="twitter:image:src" content="https://skywalking.apache.org/images/skywalking_400x400.png">
<meta property="og:image" content="https://skywalking.apache.org/images/skywalking_400x400.png">

<meta name="generator" content="Hugo 0.80.0" />


<script async src="https://www.googletagmanager.com/gtag/js?id=G-GR8N6PGRJ3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);};
  gtag('js', new Date());gtag('config', 'G-GR8N6PGRJ3');
</script>
<META NAME="ROBOTS" CONTENT="INDEX, FOLLOW">
<link rel="stylesheet" href="//at.alicdn.com/t/c/font_3007530_pvozs1rz2wn.css">



<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
<link rel="manifest" href="/favicons/site.webmanifest">
<link rel="mask-icon" href="/favicons/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">

<title>Pinpoint Service Mesh Critical Performance Impact by using eBPF | Apache SkyWalking</title><meta property="og:title" content="Pinpoint Service Mesh Critical Performance Impact by using eBPF" />
<meta property="og:description" content="Pinpoint Service Mesh Critical Performance Impact by using eBPF Background Apache SkyWalking observes metrics, logs, traces, and events for services deployed into the service mesh. When troubleshooting, SkyWalking error analysis can be an invaluable tool helping to pinpoint where an error occurred. However, performance problems are more difficult: It’s often impossible to locate the root cause of performance problems with pre-existing observation data. To move beyond the status quo, dynamic debugging and troubleshooting are essential service performance tools." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/docs/main/v9.7.0/en/concepts-and-designs/ebpf-cpu-profiling/" />

<meta itemprop="name" content="Pinpoint Service Mesh Critical Performance Impact by using eBPF">
<meta itemprop="description" content="Pinpoint Service Mesh Critical Performance Impact by using eBPF Background Apache SkyWalking observes metrics, logs, traces, and events for services deployed into the service mesh. When troubleshooting, SkyWalking error analysis can be an invaluable tool helping to pinpoint where an error occurred. However, performance problems are more difficult: It’s often impossible to locate the root cause of performance problems with pre-existing observation data. To move beyond the status quo, dynamic debugging and troubleshooting are essential service performance tools.">

<meta itemprop="wordCount" content="1939">



<meta itemprop="keywords" content="" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Pinpoint Service Mesh Critical Performance Impact by using eBPF"/>
<meta name="twitter:description" content="Pinpoint Service Mesh Critical Performance Impact by using eBPF Background Apache SkyWalking observes metrics, logs, traces, and events for services deployed into the service mesh. When troubleshooting, SkyWalking error analysis can be an invaluable tool helping to pinpoint where an error occurred. However, performance problems are more difficult: It’s often impossible to locate the root cause of performance problems with pre-existing observation data. To move beyond the status quo, dynamic debugging and troubleshooting are essential service performance tools."/>



<link rel="preload" href="/scss/main.min.592235942cb3c9f3dd697382a4e7a1fad8e1c182dad2841bdce6b43b4a346ae8.css" as="style">
<link href="/scss/main.min.592235942cb3c9f3dd697382a4e7a1fad8e1c182dad2841bdce6b43b4a346ae8.css" rel="stylesheet" integrity="">



<link rel="stylesheet" href="/css/docSearch.css" />


<script src="/js/jquery-3.6.0.min.js"></script>





    <title>Pinpoint Service Mesh Critical Performance Impact by using eBPF | Apache SkyWalking</title>
  </head>
  <body class="td-page  project-doc">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand  flex-column flex-md-row td-navbar">
    <div class="sidebar-button">
      <i class="iconfont icon-menu"></i>
    </div>
    <a class="navbar-brand" href="/">
        <span class="navbar-logo"><img width="130" src="/images/logo.svg" alt="SkyWalking"></span> 
    </a>
    <div class="td-navbar-nav-scroll navbar-nav-wrapper" id="navigation">
        <ul class="navbar-nav mt-lg-0">
             
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/docs" ><span>Projects and Docs</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/events" ><span>Events</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/blog" ><span>Blogs</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/downloads" ><span>Downloads</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/team" ><span>Team</span></a>
			</li>
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
				
				
				
				
				<a class="nav-link" href="/users" ><span>Users</span></a>
			</li>
            
            
            
            
            
            <li class="nav-item mr-3 mb-lg-0">
                <span class="link dropdown blog">
                    <a class="link-name nav-link dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">中文资料</a>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="/zh/">博客</a>
                        <a class="dropdown-item" href="https://space.bilibili.com/390683219" target="_blank" rel="noopener noreferrer">
                            B站
                        </a>
                        <a class="dropdown-item" href="https://juejin.cn/user/13673577331607" target="_blank" rel="noopener noreferrer">
                            掘金
                        </a>
                    </div>
                </span>
            </li>

            
			
        </ul>
    </div>
    <div class="navbar-nav d-none d-lg-block search-input-box">
         
            
        
            
        
            
        
            
        
            
        
            
        
            
            <span class="link dropdown">
                <a class="link-name dropdown-toggle" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Links
                </a>
                <div class="dropdown-menu">
                    
                    <a class="dropdown-item" href="http://www.apache.org/">Apache Software Foundation</a> 
                    <a class="dropdown-item" href="https://github.com/apache/skywalking/issues">GitHub Issue Tracker</a> 
                    <a class="dropdown-item" href="https://github.com/apache/skywalking/discussions">Discussion</a> 
                    <a class="dropdown-item" href="https://lists.apache.org/list.html?dev@skywalking.apache.org">Dev Mailing List</a> 
                    <a class="dropdown-item" href="https://cwiki.apache.org/confluence/display/SKYWALKING/Home">WIKI</a> 
                    <a class="dropdown-item" href="http://www.apache.org/licenses/">License</a> 
                    <a class="dropdown-item" href="http://www.apache.org/events/current-event">Apache Events</a> 
                    <a class="dropdown-item" href="http://www.apache.org/security/">Security</a> 
                    <a class="dropdown-item" href="http://www.apache.org/foundation/sponsorship.html">Sponsor and Donate</a> 
                    <a class="dropdown-item" href="http://www.apache.org/foundation/thanks.html">Thanks</a> 
                    <a class="dropdown-item" href="https://apache.org/foundation/policies/privacy.html">Privacy</a> 
                </div>
            </span>
            
        
        
<div id="docsearch"></div>


    </div>
</nav>

    </header>
    <div class="container-fluid td-outer">

      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 d-print-none scroll-bar td-sidebar">




                  <div class="description-wrapper">
                    <h5>
                    <img width="26" height="26" src="/images/project/skywalking.svg">
                    SkyWalking
                    </h5>
                    <p>SkyWalking primary repository and docs.</p>
                  </div>
                  
                  <div class="version-wrapper">Version: 
                  <select class="version-select">
                  
                    
                    
                    <option ZgotmplZ value="next">
                    
                      next
                    
                    </option>
                  
                    
                    
                    <option ZgotmplZ value="latest">
                    
                      latest
                    
                    </option>
                  
                    
                    
                    <option selected value="v9.7.0">
                    
                      v9.7.0
                    
                    </option>
                  
                    
                    
                    <option ZgotmplZ value="v9.6.0">
                    
                      v9.6.0
                    
                    </option>
                  
                    
                    
                    <option ZgotmplZ value="v9.5.0">
                    
                      v9.5.0
                    
                    </option>
                  
                    
                    
                    <option ZgotmplZ value="v9.4.0">
                    
                      v9.4.0
                    
                    </option>
                  
                    
                    
                    <option ZgotmplZ value="v9.3.0">
                    
                      v9.3.0
                    
                    </option>
                  
                    
                    
                    <option ZgotmplZ value="v9.2.0">
                    
                      v9.2.0
                    
                    </option>
                  
                    
                    
                    <option ZgotmplZ value="v9.1.0">
                    
                      v9.1.0
                    
                    </option>
                  
                    
                    
                    <option ZgotmplZ value="v9.0.0">
                    
                      v9.0.0
                    
                    </option>
                  
                  </select>
                  </div>
                  
                  <ul class="sidebar-menu">
    
    <li>
        
            <a href="/docs/main/v9.7.0/readme">Welcome</a>
        
    </li>
    
    <li>
        
            
            <a href="#">Concepts and Designs<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        

            
            <a href="#">What is SkyWalking?<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/concepts-and-designs/overview">Overview and Core concepts</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/concepts-and-designs/project-goals">Project Goals</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">Agents<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/concepts-and-designs/probe-introduction">Introduction</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/concepts-and-designs/service-agent">Service Auto Instrument Agent</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/concepts-and-designs/manual-sdk">Manual Instrument SDK</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">Observability Analysis Platform<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/concepts-and-designs/backend-overview">Overview</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/concepts-and-designs/oal">Analysis Traces and Mesh Traffic</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/concepts-and-designs/mal">Analysis Metrics and Meters</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/concepts-and-designs/lal">Analysis Logs</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/concepts-and-designs/profiling">Profiling</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/concepts-and-designs/event/">Event</a>
        
    </li>

    

</ul>

        
    </li>
    
    <li>
        
            
            <a href="#">Setup<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        

            
            <a href="#">Quick Start<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-setup">Introduction</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-docker">Run with Docker</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-k8s">Run with Kubernetes</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/configuration-vocabulary">Configuration Vocabulary</a>
        
    </li>

    

    <li>
        

            
            <a href="#">Advanced Setup<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/service-auto-grouping">Service Grouping</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-setting-override">Overriding Settings</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-ip-port">IP And Port Setting</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-init-mode">Backend Init Mode Startup</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-cluster">Cluster Management</a>
        
    </li>

    

    <li>
        

            
            <a href="#">Choose Storage<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-storage">Introduction</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/storages/h2">H2</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/storages/elasticsearch">Elasticsearch &amp; OpenSearch</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/storages/mysql">MySQL</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/storages/postgresql">PostgreSQL</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/storages/banyandb">BanyanDB(Alpha)</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-expose">Setup External Communication Channels</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/kafka-fetcher">Kafka Fetcher</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/advanced-deployment">Advanced Deployment Options</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/ttl">Data Lifecycle. Time To Live (TTL)</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/endpoint-grouping-rules">Group Parameterized Endpoints</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/dynamical-logging">Dynamical Logging</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/grpc-security">Security(SSL/TLS/mTLS)</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-load-balancer">Setup Native Load Balancer</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-telemetry">OAP Self Observability Telemetry</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-health-check">OAP Health Check</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">Tracing<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/trace-sampling">Trace Sampling</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/slow-db-statement">Detect Slow Database Statement</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/slow-cache-command">Detect Slow Cache Command</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/mq">Message Queue Performance</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/uninstrumented-gateways">Uninstrumented Gateways</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/zipkin-trace">Zipkin Trace</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/otlp-trace">OpenTelemetry Trace</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">Metrics<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/guides/backend-oal-scripts">OAL Scripts</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/opentelemetry-receiver">OpenTelemetry Metrics</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/aws-firehose-receiver">AWS CloudWatch Metrics</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-zabbix">Zabbix Metrics</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-meter">Meter Analysis</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/telegraf-receiver">Telegraf Metrics</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/apdex-threshold">Apdex Threshold</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/micrometer-observations">Spring MicroMeter Observations Analysis</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-alarm">Alerting</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">Logging<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        

            
            <a href="#">Persistent Logging<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/filelog-native">Native Logging from Files</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/log-agent-native">Native Logging from Agents</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/log-otlp">OpenTelemetry Logging</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/log-analyzer">Log Analysis</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/on-demand-pod-log">On Demand Pod Logs</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">Profiling<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-trace-profiling">Tracing Profiling</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-ebpf-profiling">eBPF Profiling</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-continuous-profiling">Continuous Profiling</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">Extension<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/exporter">Exporter</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/dynamic-config">Dynamic Configuration</a>
        
    </li>

    

    <li>
        

            
            <a href="#">AI Pipeline<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/ai-pipeline/introduction">Introduction</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/ai-pipeline/http-restful-uri-pattern">HTTP Restful URI recognition</a>
        
    </li>

    

</ul>

        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">UI Setup<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        

            
            <a href="#">Native UI<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/ui-setup">Setup</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/ui/readme">Customization</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/ui-grafana">Grafana UI</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">Official Dashboards<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        

            
            <a href="#">General Service<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/service-agent/server-agents">Server Agents</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/service-agent/agent-compatibility">Compatibility</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/service-agent/virtual-database">Virtual Database</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/service-agent/virtual-cache">Virtual Cache</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/service-agent/virtual-mq">Virtual MQ</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">Service Mesh<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/envoy/als_setting">Observe Service Mesh through Access Log Service (ALS)</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/zipkin/tracing">Observe Service Mesh through Zipkin traces</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/istio/readme">Observe Control Plane (Istio)</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/envoy/metrics_service_setting">Observe Data Plane (Envoy)</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-k8s-network-monitoring">Profile Pod&#39;s Network</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">Kubernetes<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-k8s-monitoring">Observe Kubernetes</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-k8s-network-monitoring">Profile Pod&#39;s Network</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">Infrastructure Monitoring<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-vm-monitoring">Linux Monitoring</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-win-monitoring">Windows Monitoring</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">AWS Cloud Monitoring<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-aws-eks-monitoring">EKS Monitoring</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-aws-s3-monitoring">S3 Monitoring</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-aws-dynamodb-monitoring">AWS DynamoDB</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-aws-api-gateway-monitoring">AWS API Gateway</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/service-agent/browser-agent">Browser Monitoring</a>
        
    </li>

    

    <li>
        

            
            <a href="#">Gateway Monitoring<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-nginx-monitoring">Nginx Monitoring</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-apisix-monitoring">APISIX Monitoring</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-aws-api-gateway-monitoring">AWS API Gateway</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">Database Monitoring<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-mysql-monitoring">MySQL/MariaDB Server</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-postgresql-monitoring">PostgreSQL Server</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-aws-dynamodb-monitoring">AWS DynamoDB</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-redis-monitoring">Redis</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-elasticsearch-monitoring">Elasticsearch</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-mongodb-monitoring">MongoDB</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-bookkeeper-monitoring">BookKeeper</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">MQ Monitoring<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-rabbitmq-monitoring">RabbitMQ</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-kafka-monitoring">Kafka</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-pulsar-monitoring">Pulsar</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">Self Observability<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/dashboards-so11y">OAP self telemetry</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/dashboards-so11y-satellite">Satellite self telemetry</a>
        
    </li>

    

</ul>

        
    </li>

    

</ul>

        
    </li>

    

    <li>
        
            <a href="https://github.com/apache/skywalking-cli">CLI Setup</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/setup/backend/backend-data-generator">Mock Data Generator Setup</a>
        
    </li>

    

</ul>

        
    </li>
    
    <li>
        
            
            <a href="#">APIs<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        

            
            <a href="#">Telemetry APIs/Protocols<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        

            
            <a href="#">Tracing<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/api/trace-data-protocol-v3">Spans APIs</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/api/x-process-propagation-headers-v3">Tracing Context Propagation</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/api/x-process-correlation-headers-v1">Tracing Correlation Correlation</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">Metrics APIs<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/api/meter">Meter APIs</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/api/browser-protocol">Browser performance APIs</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/api/jvm-protocol">JVM metrics APIs</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/api/log-data-protocol">Logging</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/api/instance-properties">Service Instance Properties APIs</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/api/event">Event</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/api/profiling-protocol">Profiling</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">Query APIs<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        

            
            <a href="#">GraphQL APIs<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/api/query-protocol">GraphQL APIs</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/api/metrics-query-expression">MQE Syntax</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/api/query-protocol-deprecated">Deprecated APIs</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/api/promql-service">PromQL APIs</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/api/logql-service">LogQL APIs</a>
        
    </li>

    

</ul>

        
    </li>

    

</ul>

        
    </li>
    
    <li>
        
            <a href="/docs/main/v9.7.0/en/security/readme">Security Notice</a>
        
    </li>
    
    <li>
        
            
            <a href="#">Debugging<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0en/debugging/config_dump">Scratch The OAP Config Dump</a>
        
    </li>

    

</ul>

        
    </li>
    
    <li>
        
            
            <a href="#">Academy<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/academy/scaling-with-apache-skywalking">Scaling SkyWalking server automatically in kubernetes</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/papers/stam">STAM Paper, Streaming Topology Analysis Method</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/concepts-and-designs/sdk-profiling">SDK Profiling to Fix the Blind Spot</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/concepts-and-designs/ebpf-cpu-profiling">eBPF CPU Profiling to pinpoint Service Mesh Critical Performance Impact</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/academy/diagnose-service-mesh-network-performance-with-ebpf">Diagnose Service Mesh Network Performance with eBPF</a>
        
    </li>

    

</ul>

        
    </li>
    
    <li>
        
            <a href="/docs/main/v9.7.0/en/faq/readme">FAQs</a>
        
    </li>
    
    <li>
        
            
            <a href="#">Contributing Guides<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/guides/community">Contact the community</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/guides/asf/committer">Become A Committer</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/guides/how-to-release/">Release Guide</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/guides/how-to-build">Compiling Guide</a>
        
    </li>

    

    <li>
        

            
            <a href="#">Contribute<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/guides/it-guide">Integration Tests</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/guides/benchmark">Benchmark Tests</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/guides/e2e">End to End Tests</a>
        
    </li>

    

    <li>
        

            
            <a href="#">Project Extensions<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/guides/component-library-settings">Component Library Settings</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/guides/source-extension">Extend An OAL Source</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        

            
            <a href="#">Dependencies<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/guides/dependencies">Project Dependencies Check</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/guides/how-to-bump-up-zipkin">Zipkin dependency</a>
        
    </li>

    

</ul>

        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/guides/i18n">I18n</a>
        
    </li>

    

</ul>

        
    </li>

    

</ul>

        
    </li>
    
    <li>
        
            
            <a href="#">Changelog<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes">Current Version</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-9.6.0">9.6.0</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-9.5.0">9.5.0</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-9.4.0">9.4.0</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-9.3.0">9.3.0</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-9.2.0">9.2.0</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-9.1.0">9.1.0</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-9.0.0">9.0.0</a>
        
    </li>

    

    <li>
        

            
            <a href="#">Archived Releases<i class="iconfont icon-arrow-right pull-right"></i></a>
            

            
<ul class="sidebar-submenu">
    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-8.9.1">8.9.1</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-8.9.0">8.9.0</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-8.8.1">8.8.1</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-8.8.0">8.8.0</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-8.7.0">8.7.0</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-8.6.0">8.6.0</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-8.5.0">8.5.0</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-8.4.0">8.4.0</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-8.3.0">8.3.0</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-8.2.0">8.2.0</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-8.1.0">8.1.0</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-8.0.1">8.0.1</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-8.0.0">8.0.0</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-7.0.0">7.0.0</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-6.x">6.x</a>
        
    </li>

    

    <li>
        
            <a href="/docs/main/v9.7.0/en/changes/changes-5.x">5.x</a>
        
    </li>

    

</ul>

        
    </li>

    

</ul>

        
    </li>
    
</ul>
<script src="/js/sidebar-menu.js"></script>
<script>
  (function (){
    $.sidebarMenu($('.sidebar-menu'))
    var path = window.location.pathname;
    var hash = window.location.hash;
    var $a = $('.sidebar-menu a')
    $a.each(function (e){
      if($(this).attr('href')+'/' === path || $(this).attr('href').replace('#','/#') === path+hash){
        $(this).parents('li').addClass('active').show()
      }
    })
    $a.on('click',function (){
      var url = $(this).attr('href')
      if(url!=='#'){
        window.location.href = url
      }
    })
  })()
</script>

                  <div class="commit-id">Commit Id: 1ca62dc</div>
                







































</div>
            <main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role="main">
              <i class="iconfont icon-menu-doc doc-menu-button"></i>
              
<div class="td-content">











	<h1 id="pinpoint-service-mesh-critical-performance-impact-by-using-ebpf">Pinpoint Service Mesh Critical Performance Impact by using eBPF</h1>
<h2 id="background">Background</h2>
<p><a href="https://skywalking.apache.org/">Apache SkyWalking</a> observes metrics, logs, traces, and events for services deployed into the service mesh. When troubleshooting, SkyWalking error analysis can be an invaluable tool helping to pinpoint where an error occurred. However, performance problems are more difficult: It’s often impossible to locate the root cause of performance problems with pre-existing observation data. To move beyond the status quo, dynamic debugging and troubleshooting are essential service performance tools. In this article, we&rsquo;ll discuss how to use eBPF technology to improve the profiling feature in SkyWalking and analyze the performance impact in the service mesh.</p>
<h2 id="trace-profiling-in-skywalking">Trace Profiling in SkyWalking</h2>
<p>Since SkyWalking 7.0.0, Trace Profiling has helped developers find performance problems by periodically sampling the thread stack to let developers know which lines of code take more time. However, Trace Profiling is not suitable for the following scenarios:</p>
<ol>
<li><strong>Thread Model</strong>: Trace Profiling is most useful for profiling code that executes in a single thread. It is less useful for middleware that relies heavily on async execution models. For example Goroutines in Go or Kotlin Coroutines.</li>
<li><strong>Language</strong>: Currently, Trace Profiling is only supported in Java and Python, since it’s not easy to obtain the thread stack in the runtimes of some languages such as Go and Node.js.</li>
<li><strong>Agent Binding</strong>: Trace Profiling requires Agent installation, which can be tricky depending on the language (e.g., PHP has to rely on its C kernel; Rust and C/C++ require manual instrumentation to make install).</li>
<li><strong>Trace Correlation</strong>: Since Trace Profiling is only associated with a single request it can be hard to determine which request is causing the problem.</li>
<li><strong>Short Lifecycle Services</strong>: Trace Profiling doesn&rsquo;t support short-lived services for (at least) two reasons:
<ol>
<li>It&rsquo;s hard to differentiate system performance from class code manipulation in the booting stage.</li>
<li>Trace profiling is linked to an endpoint to identify performance impact, but there is no endpoint to match these short-lived services.</li>
</ol>
</li>
</ol>
<p>Fortunately, there are techniques that can go further than Trace Profiling in these situations.</p>
<h2 id="introduce-ebpf">Introduce eBPF</h2>
<p>We have found that eBPF — a technology that can run sandboxed programs in an operating system kernel and thus safely and efficiently extend the capabilities of the kernel without requiring kernel modifications or loading kernel modules — can help us fill gaps left by Trace Profiling. eBPF is a trending technology because it breaks the traditional barrier between user and kernel space. Programs can now inject bytecode that runs in the kernel, instead of having to recompile the kernel to customize it. This is naturally a good fit for observability.</p>
<p>In the figure below, we can see that when the system executes the execve syscalls, the eBPF program is triggered, and the current process runtime information is obtained by using function calls.</p>
<p><img src="https://skywalking.apache.org/blog/2022-07-05-pinpoint-service-mesh-critical-performance-impact-by-using-ebpf/eBPF-hook-points.png" alt="eBPF Hook Point"></p>
<p>Using eBPF technology, we can expand the scope of Skywalking&rsquo;s profiling capabilities:</p>
<ol>
<li><strong>Global Performance Analysis</strong>: Before eBPF, data collection was limited to what agents can observe. Since eBPF programs run in the kernel, they can observe all threads. This is especially useful when you are not sure whether a performance problem is caused by a particular request.</li>
<li><strong>Data Content</strong>: eBPF can dump both user and kernel space thread stacks, so if a performance issue happens in kernel space, it’s easier to find.</li>
<li><strong>Agent Binding</strong>: All modern Linux kernels support eBPF, so there is no need to install anything. This means it is an orchestration-free vs an agent model. This reduces friction caused by built-in software which may not have the correct agents installed, such as Envoy in a Service Mesh.</li>
<li><strong>Sampling Type</strong>: Unlike Trace Profiling, eBPF is event-driven and, therefore, not constrained by interval polling. For example, eBPF can trigger events and collect more data depending on a transfer size threshold. This can allow the system to triage and prioritize data collection under extreme load.</li>
</ol>
<h3 id="ebpf-limitations">eBPF Limitations</h3>
<p>While eBPF offers significant advantages for hunting performance bottlenecks, no technology is perfect. eBPF has a number of limitations described below. Fortunately, since SkyWalking does not require eBPF, the impact is limited.</p>
<ol>
<li><strong>Linux Version Requirement</strong>: eBPF programs require a Linux kernel version above 4.4, with later kernel versions offering more data to be collected. The BCC has <a href="https://github.com/iovisor/bcc/blob/13b5563c11f7722a61a17c6ca0a1a387d2fa7788/docs/kernel-versions.md#main-features">documented the features supported by different Linux kernel versions</a>, with the differences between versions usually being what data can be collected with eBPF.</li>
<li><strong>Privileges Required</strong>: All processes that intend to load eBPF programs into the Linux kernel must be running in privileged mode. As such, bugs or other issues in such code may have a big impact.</li>
<li><strong>Weak Support for Dynamic Language</strong>: eBPF has weak support for JIT-based dynamic languages, such as Java. It also depends on what data you want to collect. For Profiling, eBPF does not support parsing the symbols of the program, which is why most eBPF-based profiling technologies only support static languages like C, C++, Go, and Rust. However, symbol mapping can sometimes be solved through tools provided by the language. For example, in Java, <a href="https://github.com/jvm-profiling-tools/perf-map-agent#architecture">perf-map-agent</a> can be used to generate the symbol mapping. However, dynamic languages don&rsquo;t support the attach (uprobe) functionality that would allow us to trace execution events through symbols.</li>
</ol>
<h3 id="introducing-skywalking-rover">Introducing SkyWalking Rover</h3>
<p><a href="https://github.com/apache/skywalking-rover">SkyWalking Rover</a> introduces the eBPF profiling feature into the SkyWalking ecosystem. The figure below shows the overall architecture of SkyWalking Rover. SkyWalking Rover is currently supported in Kubernetes environments and must be deployed inside a Kubernetes cluster. After establishing a connection with the SkyWalking backend server, it saves information about the processes on the current machine to SkyWalking. When the user creates an eBPF profiling task via the user interface, SkyWalking Rover receives the task and executes it in the relevant C, C++, Golang, and Rust language-based programs.</p>
<p>Other than an eBPF-capable kernel, there are no additional prerequisites for deploying SkyWalking Rover.</p>
<p><img src="https://skywalking.apache.org/blog/2022-07-05-pinpoint-service-mesh-critical-performance-impact-by-using-ebpf/architecture.png" alt="architecture"></p>
<h3 id="cpu-profiling-with-rover">CPU Profiling with Rover</h3>
<p>CPU profiling is the most intuitive way to show service performance. Inspired by <a href="https://www.brendangregg.com/offcpuanalysis.html">Brendan Gregg‘s blog post</a>, we&rsquo;ve divided CPU profiling into two types that we have implemented in Rover:</p>
<ol>
<li><strong>On-CPU Profiling</strong>: Where threads are spending time running on-CPU.</li>
<li><strong>Off-CPU Profiling</strong>: Where time is spent waiting while blocked on I/O, locks, timers, paging/swapping, etc.</li>
</ol>
<h2 id="profiling-envoy-with-ebpf">Profiling Envoy with eBPF</h2>
<p>Envoy is a popular proxy, used as the data plane by the Istio service mesh. In a Kubernetes cluster, Istio injects Envoy into each service’s pod as a sidecar where it transparently intercepts and processes incoming and outgoing traffic. As the data plane, any performance issues in Envoy can affect all service traffic in the mesh. In this scenario, it’s more powerful to use <strong>eBPF profiling</strong> to analyze issues in production caused by service mesh configuration.</p>
<h3 id="demo-environment">Demo Environment</h3>
<p>If you want to see this scenario in action, we&rsquo;ve built a demo environment where we deploy an Nginx service for stress testing. Traffic is intercepted by Envoy and forwarded to Nginx. The commands to install the whole environment can be accessed through <a href="https://github.com/mrproliu/skywalking-rover-profiling-demo">GitHub</a>.</p>
<h2 id="on-cpu-profiling">On-CPU Profiling</h2>
<p>On-CPU profiling is suitable for analyzing thread stacks when service CPU usage is high. If the stack is dumped more times, it means that the thread stack occupies more CPU resources.</p>
<p>When installing Istio using the demo configuration profile, we found there are two places where we can optimize performance:</p>
<ol>
<li><strong>Zipkin Tracing</strong>: Different Zipkin sampling percentages have a direct impact on QPS.</li>
<li><strong>Access Log Format</strong>: Reducing the fields of the Envoy access log can improve QPS.</li>
</ol>
<h3 id="zipkin-tracing">Zipkin Tracing</h3>
<h4 id="zipkin-with-100-sampling">Zipkin with 100% sampling</h4>
<p>In the default demo configuration profile, Envoy is using 100% sampling as default tracing policy. How does that impact the performance?</p>
<p>As shown in the figure below, using the <strong>on-CPU profiling</strong>, we found that it takes about <strong>16%</strong> of the CPU overhead. At a fixed consumption of <strong>2 CPUs</strong>, its QPS can reach <strong>5.7K</strong>.</p>
<p><img src="https://skywalking.apache.org/blog/2022-07-05-pinpoint-service-mesh-critical-performance-impact-by-using-ebpf/zipkin-sampling-100.png" alt="Zipkin with 100% sampling"></p>
<h4 id="disable-zipkin-tracing">Disable Zipkin tracing</h4>
<p>At this point, we found that if Zipkin is not necessary, the sampling percentage can be reduced or we can even disable tracing. Based on the <a href="https://istio.io/latest/docs/reference/config/istio.mesh.v1alpha1/#Tracing">Istio documentation</a>, we can disable tracing when installing the service mesh using the following command:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">istioctl install -y --set <span style="color:#008080">profile</span><span style="color:#000;font-weight:bold">=</span>demo <span style="color:#d14">\
</span><span style="color:#d14"></span>   --set <span style="color:#d14">&#39;meshConfig.enableTracing=false&#39;</span> <span style="color:#d14">\
</span><span style="color:#d14"></span>   --set <span style="color:#d14">&#39;meshConfig.defaultConfig.tracing.sampling=0.0&#39;</span>
</code></pre></div><p>After disabling tracing, we performed on-CPU profiling again. According to the figure below, we found that Zipkin has disappeared from the flame graph. With the same <strong>2 CPU</strong> consumption as in the previous example, the QPS reached <strong>9K</strong>, which is an almost <strong>60%</strong> increase.
<img src="https://skywalking.apache.org/blog/2022-07-05-pinpoint-service-mesh-critical-performance-impact-by-using-ebpf/zipkin-disable-tracing.png" alt="Disable Zipkin tracing"></p>
<h4 id="tracing-with-throughput">Tracing with Throughput</h4>
<p>With the same CPU usage, we&rsquo;ve discovered that Envoy performance greatly improves when the tracing feature is disabled. Of course, this requires us to make trade-offs between the number of samples Zipkin collects and the desired performance of Envoy (QPS).</p>
<p>The table below illustrates how different Zipkin sampling percentages under the same CPU usage affect QPS.</p>
<table>
<thead>
<tr>
<th>Zipkin sampling %</th>
<th>QPS</th>
<th>CPUs</th>
<th>Note</th>
</tr>
</thead>
<tbody>
<tr>
<td>100% <strong>(default)</strong></td>
<td>5.7K</td>
<td>2</td>
<td>16% used by Zipkin</td>
</tr>
<tr>
<td>1%</td>
<td>8.1K</td>
<td>2</td>
<td>0.3% used by Zipkin</td>
</tr>
<tr>
<td>disabled</td>
<td>9.2K</td>
<td>2</td>
<td>0% used by Zipkin</td>
</tr>
</tbody>
</table>
<h3 id="access-log-format">Access Log Format</h3>
<h4 id="default-log-format">Default Log Format</h4>
<p>In the default demo configuration profile, <a href="https://istio.io/latest/docs/tasks/observability/logs/access-log/#default-access-log-format">the default Access Log format</a> contains a lot of data. The flame graph below shows various functions involved in parsing the data such as request headers, response headers, and streaming the body.</p>
<p><img src="https://skywalking.apache.org/blog/2022-07-05-pinpoint-service-mesh-critical-performance-impact-by-using-ebpf/log-format-default.png" alt="Default Log Format"></p>
<h4 id="simplifying-access-log-format">Simplifying Access Log Format</h4>
<p>Typically, we don’t need all the information in the access log, so we can often simplify it to get what we need. The following command simplifies the access log format to only display basic information:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">istioctl install -y --set <span style="color:#008080">profile</span><span style="color:#000;font-weight:bold">=</span>demo <span style="color:#d14">\
</span><span style="color:#d14"></span>   --set meshConfig.accessLogFormat<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;[%START_TIME%] \&#34;%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%\&#34; %RESPONSE_CODE%\n&#34;</span>
</code></pre></div><p>After simplifying the access log format, we found that the QPS increased from <strong>5.7K</strong> to <strong>5.9K</strong>. When executing the on-CPU profiling again, the CPU usage of log formatting dropped from <strong>2.4%</strong> to <strong>0.7%</strong>.</p>
<p>Simplifying the log format helped us to improve the performance.</p>
<h2 id="off-cpu-profiling">Off-CPU Profiling</h2>
<p>Off-CPU profiling is suitable for performance issues that are not caused by high CPU usage. For example, when there are too many threads in one service, using off-CPU profiling could reveal which threads spend more time context switching.</p>
<p>We provide data aggregation in two dimensions:</p>
<ol>
<li><strong>Switch count</strong>: The number of times a thread switches context. When the thread returns to the CPU, it completes one context switch. A thread stack with a higher switch count spends more time context switching.</li>
<li><strong>Switch duration</strong>: The time it takes a thread to switch the context. A thread stack with a higher switch duration spends more time off-CPU.</li>
</ol>
<h3 id="write-access-log">Write Access Log</h3>
<h4 id="enable-write">Enable Write</h4>
<p>Using the same environment and settings as before in the on-CPU test, we performed off-CPU profiling. As shown below, we found that access log writes accounted for about <strong>28%</strong> of the total context switches. The &ldquo;__write&rdquo; shown below also indicates that this method is the Linux kernel method.</p>
<p><img src="https://skywalking.apache.org/blog/2022-07-05-pinpoint-service-mesh-critical-performance-impact-by-using-ebpf/access-log-write-enable.png" alt="Enable Write Access Log"></p>
<h4 id="disable-write">Disable Write</h4>
<p>SkyWalking implements Envoy&rsquo;s Access Log Service (ALS) feature which allows us to send access logs to the SkyWalking Observability Analysis Platform (OAP) using the gRPC protocol. Even by disabling the access logging, we can still use ALS to capture/aggregate the logs. We&rsquo;ve disabled writing to the access log using the following command:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">istioctl install -y --set <span style="color:#008080">profile</span><span style="color:#000;font-weight:bold">=</span>demo --set meshConfig.accessLogFile<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;&#34;</span>
</code></pre></div><p>After disabling the Access Log feature, we performed the off-CPU profiling. File writing entries have disappeared as shown in the figure below. Envoy throughput also increased from <strong>5.7K</strong> to <strong>5.9K</strong>.</p>
<p><img src="https://skywalking.apache.org/blog/2022-07-05-pinpoint-service-mesh-critical-performance-impact-by-using-ebpf/access-log-write-disable.png" alt="Disable Write Access Log"></p>
<h2 id="conclusion">Conclusion</h2>
<p>In this article, we&rsquo;ve examined the insights Apache Skywalking&rsquo;s Trace Profiling can give us and how much more can be achieved with eBPF profiling. All of these features are implemented in <a href="https://github.com/apache/skywalking-rover">skywalking-rover</a>. In addition to on- and off-CPU profiling, you will also find the following features:</p>
<ol>
<li><strong>Continuous profiling</strong>, helps you automatically profile without manual intervention. For example, when Rover detects that the CPU exceeds a configurable threshold, it automatically executes the on-CPU profiling task.</li>
<li>More profiling types to enrich usage scenarios, such as network, and memory profiling.</li>
</ol>




</div>


            </main>
          <div id="toc" class="d-none d-xl-block col-xl-2 td-toc d-print-none">
            




<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">











</div>






<nav id="TableOfContents">
  <ul>
    <li><a href="#pinpoint-service-mesh-critical-performance-impact-by-using-ebpf">Pinpoint Service Mesh Critical Performance Impact by using eBPF</a>
      <ul>
        <li><a href="#background">Background</a></li>
        <li><a href="#trace-profiling-in-skywalking">Trace Profiling in SkyWalking</a></li>
        <li><a href="#introduce-ebpf">Introduce eBPF</a>
          <ul>
            <li><a href="#ebpf-limitations">eBPF Limitations</a></li>
            <li><a href="#introducing-skywalking-rover">Introducing SkyWalking Rover</a></li>
            <li><a href="#cpu-profiling-with-rover">CPU Profiling with Rover</a></li>
          </ul>
        </li>
        <li><a href="#profiling-envoy-with-ebpf">Profiling Envoy with eBPF</a>
          <ul>
            <li><a href="#demo-environment">Demo Environment</a></li>
          </ul>
        </li>
        <li><a href="#on-cpu-profiling">On-CPU Profiling</a>
          <ul>
            <li><a href="#zipkin-tracing">Zipkin Tracing</a></li>
            <li><a href="#access-log-format">Access Log Format</a></li>
          </ul>
        </li>
        <li><a href="#off-cpu-profiling">Off-CPU Profiling</a>
          <ul>
            <li><a href="#write-access-log">Write Access Log</a></li>
          </ul>
        </li>
        <li><a href="#conclusion">Conclusion</a></li>
      </ul>
    </li>
  </ul>
</nav>




<script>
  $(function () {
    var $toc = $("#TableOfContents");
    if (!$toc || !$toc.length) {
      return;
    }
    var top = $toc.offset().top;
    $(window).on("scroll", debounce(setTop, 100))
    $(window).on("scroll", debounce(addActive, 30))

    function addActive() {
      var scrollValue = $(window).scrollTop();
      var topEle = null;
      $.each($('main h1, main h2, main h3'), function (index, item) {
        if ($(item).offset().top - 70 > scrollValue) {
          return
        }
        if (!topEle) {
          topEle = item
        } else if ($(item).offset().top >= $(topEle).offset().top) {
          topEle = item
        }
        if (topEle) {
          var id = $(item).attr('id');
          $toc.find('a').removeClass("active").end().find('a[href="' + '#' + id + '"]').addClass("active")
        }
      })
    }

    function setTop() {
      var scrollValue = $(window).scrollTop();
      if (scrollValue >= top - 70) {
        $toc.addClass('fixed')
      } else {
        $toc.removeClass('fixed')
      }
    }

    function debounce(fn, wait) {
      var timeout = null;
      return function () {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          fn.apply(this, arguments);
        }, wait);
      };
    }
  })

</script>

          </div>

        </div>
      </div>

      
<footer class="py-5 sky-row">
  <div class="container-fluid text-center">
    <div class="">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-color" target="_blank" href="https://twitter.com/asfskywalking">
      <i class="iconfont icon-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Slack" aria-label="Slack">
    <a class="text-color" target="_blank" href="http://s.apache.org/slack-invite">
      <i class="iconfont icon-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Mailing list" aria-label="Mailing list">
    <a class="text-color" target="_blank" href="https://lists.apache.org/list.html?dev@skywalking.apache.org">
      <i class="iconfont icon-email"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-color" target="_blank" href="https://github.com/apache/skywalking">
      <i class="iconfont icon-github"></i>
    </a>
  </li>
  
</ul>

        
        
    </div>
    <div class="">

        <small class="text-color">&copy; 2017 - 2024 The Apache Software Foundation All Rights Reserved</small>
        
	
    </div>
    <div class="">
      <small class="text-color mt-4">Apache SkyWalking, SkyWalking, Apache, the Apache feather logo, and the Apache SkyWalking project logo are either registered trademarks or trademarks of the Apache Software Foundation.</small>
    </div>
  </div>
</footer>


    </div>
    



















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































    
<div id="popup">
    <div class="mask">
        <img src=""/>
    </div>
</div>

    <div class="sidebar-mask"></div>
<div class="sidebar">
    <nav class="nav-links">
        <div class="nav-item"><a href="/docs/" class="nav-link">Projects and Documentation</a></div>
        <div class="nav-item"><a href="/events/" class="nav-link">Events</a></div>
        <div class="nav-item"><a href="/blog/" class="nav-link router-link-exact-active router-link-active">Blog</a>
        </div>
        <div class="nav-item"><a href="/downloads/" class="nav-link">Downloads</a></div>
        <div class="nav-item"><a href="/team/" class="nav-link">Team</a></div>
        <div class="nav-item"><a href="/users/" class="nav-link">Users</a></div>
        <div class="nav-item">
            <div class="dropdown-wrapper open">
                <a class="dropdown-title"><span>中文资料</span>
                    <span class="arrow down"></span>
                </a>
                <ul class="nav-dropdown">
                    <li class="dropdown-item">
                        <a href="/zh/" class="nav-link external">博客</a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://space.bilibili.com/390683219" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">B站</a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://juejin.cn/user/13673577331607" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">掘金</a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="nav-item">
            <div class="dropdown-wrapper open">
                <a class="dropdown-title">
                    <span>Links</span>
                    <span class="arrow down"></span>
                </a>
                <ul class="nav-dropdown">
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Apache Software Foundation
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://github.com/apache/skywalking/issues"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            GitHub Issue Tracker
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="https://lists.apache.org/list.html?dev@skywalking.apache.org" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Dev Mailing List
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/licenses/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            License
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/events/current-event"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Apache Events
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/security/" target="_blank"
                           rel="noopener noreferrer" class="nav-link external">
                            Security
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/foundation/sponsorship.html"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Sponsorship and Donate
                        </a>
                    </li>
                    <li class="dropdown-item">
                        <a href="http://www.apache.org/foundation/thanks.html"
                           target="_blank" rel="noopener noreferrer"
                           class="nav-link external">
                            Thanks
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</div>

    <script src="/js/bootstrap.bundle.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/@docsearch/js@3"></script>









<script src="/js/main.min.dc00f5ca911ee5aa105ea6de6b3b7e8d8169ba5a3bf156b1fcfe23dfe3e62b0a.js" integrity="sha256-3AD1ypEe5aoQXqbeazt&#43;jYFpulo78Vax/P4j3&#43;PmKwo=" crossorigin="anonymous"></script>


<script src="/js/mermaid.min.js"></script>
<script>
    window.onload = () => mermaid.init(undefined, ".language-mermaid");
</script>


<script defer
src="https://widget.kapa.ai/kapa-widget.bundle.js"
data-website-id="8a08392b-9c4d-4816-8bc4-f93e0ecdd2a7"
data-project-name="SkyWalking"
data-project-color="#2B74B8"
data-button-text="Ask AI"
data-search-mode-enabled="true"
data-modal-open-on-command-k="true"
data-modal-disclaimer="The AI supports multiple languages, but it may not be accessible in China, a proxy is required."
data-project-logo="https://miro.medium.com/v2/resize:fit:2400/0*kmS-5BQ8ShAhZ_F4.jpg"
data-modal-example-questions="What is Apache SkyWalking?,How to deploy SkyWalking?,How to inject agents non-intrusively?,How to setup trace sampling?"
data-button-position-top=""
data-button-position-right="20px"
data-button-position-bottom="200px"
data-button-position-left=""
></script>




  </body>
  <script>
    $(function (){
      $('.doc-menu-button').on('click',function (){
        $('.td-sidebar').toggleClass('active')
      })
      $('.version-select').on('change', function (){
        var selectVersion = $(this).val().toLowerCase();
        var prefix = '';
        var url = location.href.replace(/(\/docs\/[a-zA-Z\-]+\/)([\w|\.]+)(\/.*)/, function (match, p1, p2, p3){
          prefix = p1 + selectVersion;
          return p1 + selectVersion + p3
        })
        go2SelectVersion(url, prefix)

      })
      function go2SelectVersion(url, prefix){
        $.ajax({
          url: url,
          type: "get",
          success:function(){
            location.href = url;
          },
          statusCode: {
            404:function(){
              location.href = prefix + '/readme/';
            }
          }
        });
      }
    })
  </script>
</html>
